<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Wed Dec 19 16:00:41 PST 2012)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="12.html">org.h2.table</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">TableFilter.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>TableFilter.java</TD><TD>100% (5/5)</TD><TD>91%  (61/67)</TD><TD>85%  (1346/1576)</TD><TD>86%  (337.6/393)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">TableFilter</A></TD><TD>100% (1/1)</TD><TD>90%  (53/59)</TD><TD>85%  (1297/1527)</TD><TD>86%  (329.6/385)</TD></TR><TR><TD CLASS="f"><A HREF="#1">getRowIdColumn (): Column</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">lockRowAdd (ArrayList): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#3">lockRows (ArrayList): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">removeFilterCondition (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5">setAlias (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">toString (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#7">getSystemColumns (): Column []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">14%  (8/58)</TD><TD CLASS="h">20%  (2/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">setEvaluatable (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">30%  (10/33)</TD><TD CLASS="h">25%  (3/12)</TD></TR><TR><TD CLASS="f"><A HREF="#9">addFilterCondition (Expression, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">72%  (26/36)</TD><TD>88%  (7/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">addJoin (TableFilter, boolean, boolean, Expression): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">77%  (85/111)</TD><TD CLASS="h">72%  (21/29)</TD></TR><TR><TD CLASS="f"><A HREF="#b">getValue (Column): Value</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>88%  (38/43)</TD><TD>92%  (12/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">mapAndAddFilter (Expression): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (31/35)</TD><TD>89%  (8/9)</TD></TR><TR><TD CLASS="f"><A HREF="#d">getPlanSQL (boolean): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (246/265)</TD><TD>94%  (50.7/54)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">prepare (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (80/86)</TD><TD>90%  (19/21)</TD></TR><TR><TD CLASS="f"><A HREF="#f">optimizeFullCondition (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (42/44)</TD><TD>97%  (6.8/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">setPlanItem (PlanItem): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (29/30)</TD><TD>90%  (9/10)</TD></TR><TR><TD CLASS="f"><A HREF="#11">next (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>98%  (170/173)</TD><TD>96%  (45/47)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">TableFilter (Session, Table, String, boolean, Select): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (35/35)</TD><TD>100% (11/11)</TD></TR><TR><TD CLASS="f"><A HREF="#13">addIndexCondition (IndexCondition): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">addNaturalJoinColumn (Column): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#15">checkTimeout (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">get (): Row</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (14/14)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#17">getBestPlanItem (Session, int): PlanItem</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (142/142)</TD><TD>100% (26/26)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">getColumns (): Column []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#19">getFilterCondition (): Expression</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">getIndex (): Index</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">getJoin (): TableFilter</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">getJoinCondition (): Expression</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">getNestedJoin (): TableFilter</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">getSchemaName (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">getSelect (): Select</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">getSession (): Session</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#21">getTable (): Table</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">getTableAlias (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#23">getTableFilter (): TableFilter</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">hasInComparisons (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (25/25)</TD><TD>100% (6/6)</TD></TR><TR><TD CLASS="f"><A HREF="#25">hashCode (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">isEvaluatable (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#27">isJoinOuter (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">isJoinOuterIndirect (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#29">isNaturalJoinColumn (Column): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">isOk (Expression): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">isUsed (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">lock (Session, boolean, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (16/16)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">optimize (ExpressionColumn, Column): Expression</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">removeJoin (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">removeJoinCondition (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">removeUnusableIndexConditions (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (25/25)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#31">reset (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (19/19)</TD><TD>100% (7/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">set (Row): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (7/7)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#33">setEvaluatable (TableFilter, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (40/40)</TD><TD>100% (11/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">setEvaluatable (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#35">setFullCondition (Expression): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">setIndex (Index): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#37">setNullRow (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (23/23)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">setSession (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#39">setUsed (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">startQuery (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (21/21)</TD><TD>100% (7/7)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">visit (TableFilter$TableFilterVisitor): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (19/19)</TD><TD>100% (8/8)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#3c">TableFilter$1</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (9/9)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#3c">TableFilter$1 (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">accept (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#3f">TableFilter$2</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (15/15)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">TableFilter$2 (TableFilter, Expression): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#41">accept (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#42">TableFilter$3</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (15/15)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#42">TableFilter$3 (TableFilter, Expression): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">accept (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#45">TableFilter$5</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (10/10)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#45">TableFilter$5 (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#47">accept (TableFilter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Copyright 2004-2011 H2 Group. Multiple-Licensed under the H2 License,</TD></TR><TR><TD CLASS="l">3</TD><TD> * Version 1.0, and under the Eclipse Public License, Version 1.0</TD></TR><TR><TD CLASS="l">4</TD><TD> * (http://h2database.com/html/license.html).</TD></TR><TR><TD CLASS="l">5</TD><TD> * Initial Developer: H2 Group</TD></TR><TR><TD CLASS="l">6</TD><TD> */</TD></TR><TR><TD CLASS="l">7</TD><TD>package org.h2.table;</TD></TR><TR><TD CLASS="l">8</TD><TD> </TD></TR><TR><TD CLASS="l">9</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">10</TD><TD>import org.h2.command.Parser;</TD></TR><TR><TD CLASS="l">11</TD><TD>import org.h2.command.dml.Select;</TD></TR><TR><TD CLASS="l">12</TD><TD>import org.h2.constant.SysProperties;</TD></TR><TR><TD CLASS="l">13</TD><TD>import org.h2.engine.Right;</TD></TR><TR><TD CLASS="l">14</TD><TD>import org.h2.engine.Session;</TD></TR><TR><TD CLASS="l">15</TD><TD>import org.h2.engine.UndoLogRecord;</TD></TR><TR><TD CLASS="l">16</TD><TD>import org.h2.expression.Comparison;</TD></TR><TR><TD CLASS="l">17</TD><TD>import org.h2.expression.ConditionAndOr;</TD></TR><TR><TD CLASS="l">18</TD><TD>import org.h2.expression.Expression;</TD></TR><TR><TD CLASS="l">19</TD><TD>import org.h2.expression.ExpressionColumn;</TD></TR><TR><TD CLASS="l">20</TD><TD>import org.h2.index.Index;</TD></TR><TR><TD CLASS="l">21</TD><TD>import org.h2.index.IndexCondition;</TD></TR><TR><TD CLASS="l">22</TD><TD>import org.h2.index.IndexCursor;</TD></TR><TR><TD CLASS="l">23</TD><TD>import org.h2.message.DbException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import org.h2.result.Row;</TD></TR><TR><TD CLASS="l">25</TD><TD>import org.h2.result.SearchRow;</TD></TR><TR><TD CLASS="l">26</TD><TD>import org.h2.util.New;</TD></TR><TR><TD CLASS="l">27</TD><TD>import org.h2.util.StatementBuilder;</TD></TR><TR><TD CLASS="l">28</TD><TD>import org.h2.util.StringUtils;</TD></TR><TR><TD CLASS="l">29</TD><TD>import org.h2.value.Value;</TD></TR><TR><TD CLASS="l">30</TD><TD>import org.h2.value.ValueLong;</TD></TR><TR><TD CLASS="l">31</TD><TD>import org.h2.value.ValueNull;</TD></TR><TR><TD CLASS="l">32</TD><TD> </TD></TR><TR><TD CLASS="l">33</TD><TD>/**</TD></TR><TR><TD CLASS="l">34</TD><TD> * A table filter represents a table that is used in a query. There is one such</TD></TR><TR><TD CLASS="l">35</TD><TD> * object whenever a table (or view) is used in a query. For example the</TD></TR><TR><TD CLASS="l">36</TD><TD> * following query has 2 table filters: SELECT * FROM TEST T1, TEST T2.</TD></TR><TR><TD CLASS="l">37</TD><TD> */</TD></TR><TR><TD CLASS="l">38</TD><TD>public class TableFilter implements ColumnResolver {</TD></TR><TR><TD CLASS="l">39</TD><TD> </TD></TR><TR><TD CLASS="l">40</TD><TD>    private static final int BEFORE_FIRST = 0, FOUND = 1, AFTER_LAST = 2, NULL_ROW = 3;</TD></TR><TR><TD CLASS="l">41</TD><TD> </TD></TR><TR><TD CLASS="l">42</TD><TD>    protected Session session;</TD></TR><TR><TD CLASS="l">43</TD><TD> </TD></TR><TR><TD CLASS="l">44</TD><TD>    /**</TD></TR><TR><TD CLASS="l">45</TD><TD>     * Whether this is a direct or indirect (nested) outer join</TD></TR><TR><TD CLASS="l">46</TD><TD>     */</TD></TR><TR><TD CLASS="l">47</TD><TD>    protected boolean joinOuterIndirect;</TD></TR><TR><TD CLASS="l">48</TD><TD> </TD></TR><TR><TD CLASS="l">49</TD><TD>    private final Table table;</TD></TR><TR><TD CLASS="l">50</TD><TD>    private final Select select;</TD></TR><TR><TD CLASS="l">51</TD><TD>    private String alias;</TD></TR><TR><TD CLASS="l">52</TD><TD>    private Index index;</TD></TR><TR><TD CLASS="l">53</TD><TD>    private int scanCount;</TD></TR><TR><TD CLASS="l">54</TD><TD>    private boolean evaluatable;</TD></TR><TR><TD CLASS="l">55</TD><TD> </TD></TR><TR><TD CLASS="l">56</TD><TD>    /**</TD></TR><TR><TD CLASS="l">57</TD><TD>     * Indicates that this filter is used in the plan.</TD></TR><TR><TD CLASS="l">58</TD><TD>     */</TD></TR><TR><TD CLASS="l">59</TD><TD>    private boolean used;</TD></TR><TR><TD CLASS="l">60</TD><TD> </TD></TR><TR><TD CLASS="l">61</TD><TD>    /**</TD></TR><TR><TD CLASS="l">62</TD><TD>     * The filter used to walk through the index.</TD></TR><TR><TD CLASS="l">63</TD><TD>     */</TD></TR><TR><TD CLASS="l">64</TD><TD>    private final IndexCursor cursor;</TD></TR><TR><TD CLASS="l">65</TD><TD> </TD></TR><TR><TD CLASS="l">66</TD><TD>    /**</TD></TR><TR><TD CLASS="l">67</TD><TD>     * The index conditions used for direct index lookup (start or end).</TD></TR><TR><TD CLASS="l">68</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">69</TD><TD>    private final ArrayList&lt;IndexCondition&gt; indexConditions = New.arrayList();</TD></TR><TR><TD CLASS="l">70</TD><TD> </TD></TR><TR><TD CLASS="l">71</TD><TD>    /**</TD></TR><TR><TD CLASS="l">72</TD><TD>     * Additional conditions that can't be used for index lookup, but for row</TD></TR><TR><TD CLASS="l">73</TD><TD>     * filter for this table (ID=ID, NAME LIKE '%X%')</TD></TR><TR><TD CLASS="l">74</TD><TD>     */</TD></TR><TR><TD CLASS="l">75</TD><TD>    private Expression filterCondition;</TD></TR><TR><TD CLASS="l">76</TD><TD> </TD></TR><TR><TD CLASS="l">77</TD><TD>    /**</TD></TR><TR><TD CLASS="l">78</TD><TD>     * The complete join condition.</TD></TR><TR><TD CLASS="l">79</TD><TD>     */</TD></TR><TR><TD CLASS="l">80</TD><TD>    private Expression joinCondition;</TD></TR><TR><TD CLASS="l">81</TD><TD> </TD></TR><TR><TD CLASS="l">82</TD><TD>    private SearchRow currentSearchRow;</TD></TR><TR><TD CLASS="l">83</TD><TD>    private Row current;</TD></TR><TR><TD CLASS="l">84</TD><TD>    private int state;</TD></TR><TR><TD CLASS="l">85</TD><TD> </TD></TR><TR><TD CLASS="l">86</TD><TD>    /**</TD></TR><TR><TD CLASS="l">87</TD><TD>     * The joined table (if there is one).</TD></TR><TR><TD CLASS="l">88</TD><TD>     */</TD></TR><TR><TD CLASS="l">89</TD><TD>    private TableFilter join;</TD></TR><TR><TD CLASS="l">90</TD><TD> </TD></TR><TR><TD CLASS="l">91</TD><TD>    /**</TD></TR><TR><TD CLASS="l">92</TD><TD>     * Whether this is an outer join.</TD></TR><TR><TD CLASS="l">93</TD><TD>     */</TD></TR><TR><TD CLASS="l">94</TD><TD>    private boolean joinOuter;</TD></TR><TR><TD CLASS="l">95</TD><TD> </TD></TR><TR><TD CLASS="l">96</TD><TD>    /**</TD></TR><TR><TD CLASS="l">97</TD><TD>     * The nested joined table (if there is one).</TD></TR><TR><TD CLASS="l">98</TD><TD>     */</TD></TR><TR><TD CLASS="l">99</TD><TD>    private TableFilter nestedJoin;</TD></TR><TR><TD CLASS="l">100</TD><TD> </TD></TR><TR><TD CLASS="l">101</TD><TD>    private ArrayList&lt;Column&gt; naturalJoinColumns;</TD></TR><TR><TD CLASS="l">102</TD><TD>    private boolean foundOne;</TD></TR><TR><TD CLASS="l">103</TD><TD>    private Expression fullCondition;</TD></TR><TR><TD CLASS="l">104</TD><TD>    private final int hashCode;</TD></TR><TR><TD CLASS="l">105</TD><TD> </TD></TR><TR><TD CLASS="l">106</TD><TD>    /**</TD></TR><TR><TD CLASS="l">107</TD><TD>     * Create a new table filter object.</TD></TR><TR><TD CLASS="l">108</TD><TD>     *</TD></TR><TR><TD CLASS="l">109</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">110</TD><TD>     * @param table the table from where to read data</TD></TR><TR><TD CLASS="l"><A NAME="0">111</A></TD><TD>     * @param alias the alias name</TD></TR><TR><TD CLASS="l">112</TD><TD>     * @param rightsChecked true if rights are already checked</TD></TR><TR><TD CLASS="l">113</TD><TD>     * @param select the select statement</TD></TR><TR><TD CLASS="l">114</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">115</TD><TD>    public TableFilter(Session session, Table table, String alias, boolean rightsChecked, Select select) {</TD></TR><TR CLASS="c"><TD CLASS="l">116</TD><TD>        this.session = session;</TD></TR><TR CLASS="c"><TD CLASS="l">117</TD><TD>        this.table = table;</TD></TR><TR CLASS="c"><TD CLASS="l">118</TD><TD>        this.alias = alias;</TD></TR><TR CLASS="c"><TD CLASS="l">119</TD><TD>        this.select = select;</TD></TR><TR CLASS="c"><TD CLASS="l">120</TD><TD>        this.cursor = new IndexCursor(this);</TD></TR><TR CLASS="c"><TD CLASS="l">121</TD><TD>        if (!rightsChecked) {</TD></TR><TR CLASS="c"><TD CLASS="l">122</TD><TD>            session.getUser().checkRight(table, Right.SELECT);</TD></TR><TR><TD CLASS="l">123</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1f">124</A></TD><TD>        hashCode = session.nextObjectId();</TD></TR><TR CLASS="c"><TD CLASS="l">125</TD><TD>    }</TD></TR><TR><TD CLASS="l">126</TD><TD> </TD></TR><TR><TD CLASS="l">127</TD><TD>    public Select getSelect() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="21">128</A></TD><TD>        return select;</TD></TR><TR><TD CLASS="l">129</TD><TD>    }</TD></TR><TR><TD CLASS="l">130</TD><TD> </TD></TR><TR><TD CLASS="l">131</TD><TD>    public Table getTable() {</TD></TR><TR CLASS="c"><TD CLASS="l">132</TD><TD>        return table;</TD></TR><TR><TD CLASS="l">133</TD><TD>    }</TD></TR><TR><TD CLASS="l">134</TD><TD> </TD></TR><TR><TD CLASS="l">135</TD><TD>    /**</TD></TR><TR><TD CLASS="l">136</TD><TD>     * Lock the table. This will also lock joined tables.</TD></TR><TR><TD CLASS="l">137</TD><TD>     *</TD></TR><TR><TD CLASS="l">138</TD><TD>     * @param s the session</TD></TR><TR><TD CLASS="l"><A NAME="2c">139</A></TD><TD>     * @param exclusive true if an exclusive lock is required</TD></TR><TR><TD CLASS="l">140</TD><TD>     * @param force lock even in the MVCC mode</TD></TR><TR><TD CLASS="l">141</TD><TD>     */</TD></TR><TR><TD CLASS="l">142</TD><TD>    public void lock(Session s, boolean exclusive, boolean force) {</TD></TR><TR CLASS="c"><TD CLASS="l">143</TD><TD>        table.lock(s, exclusive, force);</TD></TR><TR CLASS="c"><TD CLASS="l">144</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">145</TD><TD>            join.lock(s, exclusive, force);</TD></TR><TR><TD CLASS="l">146</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">147</TD><TD>    }</TD></TR><TR><TD CLASS="l">148</TD><TD> </TD></TR><TR><TD CLASS="l">149</TD><TD>    /**</TD></TR><TR><TD CLASS="l">150</TD><TD>     * Get the best plan item (index, cost) to use use for the current join</TD></TR><TR><TD CLASS="l">151</TD><TD>     * order.</TD></TR><TR><TD CLASS="l">152</TD><TD>     *</TD></TR><TR><TD CLASS="l">153</TD><TD>     * @param s the session</TD></TR><TR><TD CLASS="l">154</TD><TD>     * @param level 1 for the first table in a join, 2 for the second, and so on</TD></TR><TR><TD CLASS="l"><A NAME="17">155</A></TD><TD>     * @return the best plan item</TD></TR><TR><TD CLASS="l">156</TD><TD>     */</TD></TR><TR><TD CLASS="l">157</TD><TD>    public PlanItem getBestPlanItem(Session s, int level) {</TD></TR><TR><TD CLASS="l">158</TD><TD>        PlanItem item;</TD></TR><TR CLASS="c"><TD CLASS="l">159</TD><TD>        if (indexConditions.size() == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">160</TD><TD>            item = new PlanItem();</TD></TR><TR CLASS="c"><TD CLASS="l">161</TD><TD>            item.setIndex(table.getScanIndex(s));</TD></TR><TR CLASS="c"><TD CLASS="l">162</TD><TD>            item.cost = item.getIndex().getCost(s, null);</TD></TR><TR><TD CLASS="l">163</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">164</TD><TD>            int len = table.getColumns().length;</TD></TR><TR CLASS="c"><TD CLASS="l">165</TD><TD>            int[] masks = new int[len];</TD></TR><TR CLASS="c"><TD CLASS="l">166</TD><TD>            for (IndexCondition condition : indexConditions) {</TD></TR><TR CLASS="c"><TD CLASS="l">167</TD><TD>                if (condition.isEvaluatable()) {</TD></TR><TR CLASS="c"><TD CLASS="l">168</TD><TD>                    if (condition.isAlwaysFalse()) {</TD></TR><TR CLASS="c"><TD CLASS="l">169</TD><TD>                        masks = null;</TD></TR><TR CLASS="c"><TD CLASS="l">170</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">171</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">172</TD><TD>                    int id = condition.getColumn().getColumnId();</TD></TR><TR CLASS="c"><TD CLASS="l">173</TD><TD>                    if (id &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">174</TD><TD>                        masks[id] |= condition.getMask(indexConditions);</TD></TR><TR><TD CLASS="l">175</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">176</TD><TD>                }</TD></TR><TR><TD CLASS="l">177</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">178</TD><TD>            item = table.getBestPlanItem(s, masks);</TD></TR><TR><TD CLASS="l">179</TD><TD>            // The more index conditions, the earlier the table.</TD></TR><TR><TD CLASS="l">180</TD><TD>            // This is to ensure joins without indexes run quickly:</TD></TR><TR><TD CLASS="l">181</TD><TD>            // x (x.a=10); y (x.b=y.b) - see issue 113</TD></TR><TR CLASS="c"><TD CLASS="l">182</TD><TD>            item.cost -= item.cost * indexConditions.size() / 100 / level;</TD></TR><TR><TD CLASS="l">183</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">184</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">185</TD><TD>            setEvaluatable(nestedJoin);</TD></TR><TR CLASS="c"><TD CLASS="l">186</TD><TD>            item.setNestedJoinPlan(nestedJoin.getBestPlanItem(s, level));</TD></TR><TR><TD CLASS="l">187</TD><TD>            // TODO optimizer: calculate cost of a join: should use separate</TD></TR><TR><TD CLASS="l">188</TD><TD>            // expected row number and lookup cost</TD></TR><TR CLASS="c"><TD CLASS="l">189</TD><TD>            item.cost += item.cost * item.getNestedJoinPlan().cost;</TD></TR><TR><TD CLASS="l">190</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">191</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">192</TD><TD>            setEvaluatable(join);</TD></TR><TR CLASS="c"><TD CLASS="l">193</TD><TD>            item.setJoinPlan(join.getBestPlanItem(s, level));</TD></TR><TR><TD CLASS="l">194</TD><TD>            // TODO optimizer: calculate cost of a join: should use separate</TD></TR><TR><TD CLASS="l">195</TD><TD>            // expected row number and lookup cost</TD></TR><TR CLASS="c"><TD CLASS="l">196</TD><TD>            item.cost += item.cost * item.getJoinPlan().cost;</TD></TR><TR><TD CLASS="l">197</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="8">198</A></TD><TD>        return item;</TD></TR><TR><TD CLASS="l">199</TD><TD>    }</TD></TR><TR><TD CLASS="l">200</TD><TD> </TD></TR><TR><TD CLASS="l">201</TD><TD>    private void setEvaluatable(TableFilter join) {</TD></TR><TR CLASS="c"><TD CLASS="l">202</TD><TD>        if (session.getDatabase().getSettings().nestedJoins) {</TD></TR><TR CLASS="c"><TD CLASS="l">203</TD><TD>            setEvaluatable(true);</TD></TR><TR CLASS="c"><TD CLASS="l">204</TD><TD>            return;</TD></TR><TR><TD CLASS="l">205</TD><TD>        }</TD></TR><TR><TD CLASS="l">206</TD><TD>        // this table filter is now evaluatable - in all sub-joins</TD></TR><TR><TD CLASS="l">207</TD><TD>        do {</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>            Expression e = join.getJoinCondition();</TD></TR><TR CLASS="z"><TD CLASS="l">209</TD><TD>            if (e != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>                e.setEvaluatable(this, true);</TD></TR><TR><TD CLASS="l">211</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">212</TD><TD>            TableFilter n = join.getNestedJoin();</TD></TR><TR CLASS="z"><TD CLASS="l">213</TD><TD>            if (n != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">214</TD><TD>                setEvaluatable(n);</TD></TR><TR><TD CLASS="l">215</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>            join = join.getJoin();</TD></TR><TR CLASS="z"><TD CLASS="l">217</TD><TD>        } while (join != null);</TD></TR><TR CLASS="z"><TD CLASS="l">218</TD><TD>    }</TD></TR><TR><TD CLASS="l">219</TD><TD> </TD></TR><TR><TD CLASS="l">220</TD><TD>    /**</TD></TR><TR><TD CLASS="l">221</TD><TD>     * Set what plan item (index, cost) to use use.</TD></TR><TR><TD CLASS="l"><A NAME="10">222</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">223</TD><TD>     * @param item the plan item</TD></TR><TR><TD CLASS="l">224</TD><TD>     */</TD></TR><TR><TD CLASS="l">225</TD><TD>    public void setPlanItem(PlanItem item) {</TD></TR><TR CLASS="c"><TD CLASS="l">226</TD><TD>        if (item == null) {</TD></TR><TR><TD CLASS="l">227</TD><TD>            // invalid plan, most likely because a column wasn't found</TD></TR><TR><TD CLASS="l">228</TD><TD>            // this will result in an exception later on</TD></TR><TR CLASS="z"><TD CLASS="l">229</TD><TD>            return;</TD></TR><TR><TD CLASS="l">230</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">231</TD><TD>        setIndex(item.getIndex());</TD></TR><TR CLASS="c"><TD CLASS="l">232</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">233</TD><TD>            if (item.getNestedJoinPlan() != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">234</TD><TD>                nestedJoin.setPlanItem(item.getNestedJoinPlan());</TD></TR><TR><TD CLASS="l">235</TD><TD>            }</TD></TR><TR><TD CLASS="l">236</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">237</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">238</TD><TD>            if (item.getJoinPlan() != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">239</TD><TD>                join.setPlanItem(item.getJoinPlan());</TD></TR><TR><TD CLASS="l">240</TD><TD>            }</TD></TR><TR><TD CLASS="l">241</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">242</TD><TD>    }</TD></TR><TR><TD CLASS="l">243</TD><TD> </TD></TR><TR><TD CLASS="l">244</TD><TD>    /**</TD></TR><TR><TD CLASS="l">245</TD><TD>     * Prepare reading rows. This method will remove all index conditions that</TD></TR><TR><TD CLASS="l">246</TD><TD>     * can not be used, and optimize the conditions.</TD></TR><TR><TD CLASS="l"><A NAME="e">247</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">248</TD><TD>    public void prepare() {</TD></TR><TR><TD CLASS="l">249</TD><TD>        // forget all unused index conditions</TD></TR><TR><TD CLASS="l">250</TD><TD>        // the indexConditions list may be modified here</TD></TR><TR CLASS="c"><TD CLASS="l">251</TD><TD>        for (int i = 0; i &lt; indexConditions.size(); i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">252</TD><TD>            IndexCondition condition = indexConditions.get(i);</TD></TR><TR CLASS="c"><TD CLASS="l">253</TD><TD>            if (!condition.isAlwaysFalse()) {</TD></TR><TR CLASS="c"><TD CLASS="l">254</TD><TD>                Column col = condition.getColumn();</TD></TR><TR CLASS="c"><TD CLASS="l">255</TD><TD>                if (col.getColumnId() &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">256</TD><TD>                    if (index.getColumnIndex(col) &lt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">257</TD><TD>                        indexConditions.remove(i);</TD></TR><TR CLASS="c"><TD CLASS="l">258</TD><TD>                        i--;</TD></TR><TR><TD CLASS="l">259</TD><TD>                    }</TD></TR><TR><TD CLASS="l">260</TD><TD>                }</TD></TR><TR><TD CLASS="l">261</TD><TD>            }</TD></TR><TR><TD CLASS="l">262</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">263</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">264</TD><TD>            if (SysProperties.CHECK &amp;&amp; nestedJoin == this) {</TD></TR><TR CLASS="z"><TD CLASS="l">265</TD><TD>                DbException.throwInternalError(&#34;self join&#34;);</TD></TR><TR><TD CLASS="l">266</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">267</TD><TD>            nestedJoin.prepare();</TD></TR><TR><TD CLASS="l">268</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">269</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">270</TD><TD>            if (SysProperties.CHECK &amp;&amp; join == this) {</TD></TR><TR CLASS="z"><TD CLASS="l">271</TD><TD>                DbException.throwInternalError(&#34;self join&#34;);</TD></TR><TR><TD CLASS="l">272</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">273</TD><TD>            join.prepare();</TD></TR><TR><TD CLASS="l">274</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">275</TD><TD>        if (filterCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">276</TD><TD>            filterCondition = filterCondition.optimize(session);</TD></TR><TR><TD CLASS="l">277</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">278</TD><TD>        if (joinCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">279</TD><TD>            joinCondition = joinCondition.optimize(session);</TD></TR><TR><TD CLASS="l">280</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">281</TD><TD>    }</TD></TR><TR><TD CLASS="l">282</TD><TD> </TD></TR><TR><TD CLASS="l">283</TD><TD>    /**</TD></TR><TR><TD CLASS="l">284</TD><TD>     * Start the query. This will reset the scan counts.</TD></TR><TR><TD CLASS="l"><A NAME="3a">285</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">286</TD><TD>     * @param s the session</TD></TR><TR><TD CLASS="l">287</TD><TD>     */</TD></TR><TR><TD CLASS="l">288</TD><TD>    public void startQuery(Session s) {</TD></TR><TR CLASS="c"><TD CLASS="l">289</TD><TD>        this.session = s;</TD></TR><TR CLASS="c"><TD CLASS="l">290</TD><TD>        scanCount = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">291</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">292</TD><TD>            nestedJoin.startQuery(s);</TD></TR><TR><TD CLASS="l">293</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">294</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">295</TD><TD>            join.startQuery(s);</TD></TR><TR><TD CLASS="l">296</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">297</TD><TD>    }</TD></TR><TR><TD CLASS="l">298</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="31">299</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">300</TD><TD>     * Reset to the current position.</TD></TR><TR><TD CLASS="l">301</TD><TD>     */</TD></TR><TR><TD CLASS="l">302</TD><TD>    public void reset() {</TD></TR><TR CLASS="c"><TD CLASS="l">303</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">304</TD><TD>            nestedJoin.reset();</TD></TR><TR><TD CLASS="l">305</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">306</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">307</TD><TD>            join.reset();</TD></TR><TR><TD CLASS="l">308</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">309</TD><TD>        state = BEFORE_FIRST;</TD></TR><TR CLASS="c"><TD CLASS="l">310</TD><TD>        foundOne = false;</TD></TR><TR CLASS="c"><TD CLASS="l">311</TD><TD>    }</TD></TR><TR><TD CLASS="l">312</TD><TD> </TD></TR><TR><TD CLASS="l">313</TD><TD>    /**</TD></TR><TR><TD CLASS="l">314</TD><TD>     * Check if there are more rows to read.</TD></TR><TR><TD CLASS="l"><A NAME="11">315</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">316</TD><TD>     * @return true if there are</TD></TR><TR><TD CLASS="l">317</TD><TD>     */</TD></TR><TR><TD CLASS="l">318</TD><TD>    public boolean next() {</TD></TR><TR CLASS="c"><TD CLASS="l">319</TD><TD>        if (state == AFTER_LAST) {</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>            return false;</TD></TR><TR CLASS="c"><TD CLASS="l">321</TD><TD>        } else if (state == BEFORE_FIRST) {</TD></TR><TR CLASS="c"><TD CLASS="l">322</TD><TD>            cursor.find(session, indexConditions);</TD></TR><TR CLASS="c"><TD CLASS="l">323</TD><TD>            if (!cursor.isAlwaysFalse()) {</TD></TR><TR CLASS="c"><TD CLASS="l">324</TD><TD>                if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">325</TD><TD>                    nestedJoin.reset();</TD></TR><TR><TD CLASS="l">326</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">327</TD><TD>                if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">328</TD><TD>                    join.reset();</TD></TR><TR><TD CLASS="l">329</TD><TD>                }</TD></TR><TR><TD CLASS="l">330</TD><TD>            }</TD></TR><TR><TD CLASS="l">331</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">332</TD><TD>            // state == FOUND || NULL_ROW</TD></TR><TR><TD CLASS="l">333</TD><TD>            // the last row was ok - try next row of the join</TD></TR><TR CLASS="c"><TD CLASS="l">334</TD><TD>            if (join != null &amp;&amp; join.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">335</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">336</TD><TD>            }</TD></TR><TR><TD CLASS="l">337</TD><TD>        }</TD></TR><TR><TD CLASS="l">338</TD><TD>        while (true) {</TD></TR><TR><TD CLASS="l">339</TD><TD>            // go to the next row</TD></TR><TR CLASS="c"><TD CLASS="l">340</TD><TD>            if (state == NULL_ROW) {</TD></TR><TR CLASS="c"><TD CLASS="l">341</TD><TD>                break;</TD></TR><TR><TD CLASS="l">342</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">343</TD><TD>            if (cursor.isAlwaysFalse()) {</TD></TR><TR CLASS="c"><TD CLASS="l">344</TD><TD>                state = AFTER_LAST;</TD></TR><TR CLASS="c"><TD CLASS="l">345</TD><TD>            } else if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">346</TD><TD>                if (state == BEFORE_FIRST) {</TD></TR><TR CLASS="c"><TD CLASS="l">347</TD><TD>                    state = FOUND;</TD></TR><TR><TD CLASS="l">348</TD><TD>                }</TD></TR><TR><TD CLASS="l">349</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">350</TD><TD>                if ((++scanCount &amp; 4095) == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">351</TD><TD>                    checkTimeout();</TD></TR><TR><TD CLASS="l">352</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">353</TD><TD>                if (cursor.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">354</TD><TD>                    currentSearchRow = cursor.getSearchRow();</TD></TR><TR CLASS="c"><TD CLASS="l">355</TD><TD>                    current = null;</TD></TR><TR CLASS="c"><TD CLASS="l">356</TD><TD>                    state = FOUND;</TD></TR><TR><TD CLASS="l">357</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">358</TD><TD>                    state = AFTER_LAST;</TD></TR><TR><TD CLASS="l">359</TD><TD>                }</TD></TR><TR><TD CLASS="l">360</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">361</TD><TD>            if (nestedJoin != null &amp;&amp; state == FOUND) {</TD></TR><TR CLASS="c"><TD CLASS="l">362</TD><TD>                if (!nestedJoin.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">363</TD><TD>                    state = AFTER_LAST;</TD></TR><TR CLASS="c"><TD CLASS="l">364</TD><TD>                    if (joinOuter &amp;&amp; !foundOne) {</TD></TR><TR><TD CLASS="l">365</TD><TD>                        // possibly null row</TD></TR><TR><TD CLASS="l">366</TD><TD>                    } else {</TD></TR><TR><TD CLASS="l">367</TD><TD>                        continue;</TD></TR><TR><TD CLASS="l">368</TD><TD>                    }</TD></TR><TR><TD CLASS="l">369</TD><TD>                }</TD></TR><TR><TD CLASS="l">370</TD><TD>            }</TD></TR><TR><TD CLASS="l">371</TD><TD>            // if no more rows found, try the null row (for outer joins only)</TD></TR><TR CLASS="c"><TD CLASS="l">372</TD><TD>            if (state == AFTER_LAST) {</TD></TR><TR CLASS="c"><TD CLASS="l">373</TD><TD>                if (joinOuter &amp;&amp; !foundOne) {</TD></TR><TR CLASS="c"><TD CLASS="l">374</TD><TD>                    setNullRow();</TD></TR><TR><TD CLASS="l">375</TD><TD>                } else {</TD></TR><TR><TD CLASS="l">376</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">377</TD><TD>                }</TD></TR><TR><TD CLASS="l">378</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">379</TD><TD>            if (!isOk(filterCondition)) {</TD></TR><TR CLASS="c"><TD CLASS="l">380</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">381</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">382</TD><TD>            boolean joinConditionOk = isOk(joinCondition);</TD></TR><TR CLASS="c"><TD CLASS="l">383</TD><TD>            if (state == FOUND) {</TD></TR><TR CLASS="c"><TD CLASS="l">384</TD><TD>                if (joinConditionOk) {</TD></TR><TR CLASS="c"><TD CLASS="l">385</TD><TD>                    foundOne = true;</TD></TR><TR><TD CLASS="l">386</TD><TD>                } else {</TD></TR><TR><TD CLASS="l">387</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">388</TD><TD>                }</TD></TR><TR><TD CLASS="l">389</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">390</TD><TD>            if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">391</TD><TD>                join.reset();</TD></TR><TR CLASS="c"><TD CLASS="l">392</TD><TD>                if (!join.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">393</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">394</TD><TD>                }</TD></TR><TR><TD CLASS="l">395</TD><TD>            }</TD></TR><TR><TD CLASS="l">396</TD><TD>            // check if it's ok</TD></TR><TR CLASS="c"><TD CLASS="l">397</TD><TD>            if (state == NULL_ROW || joinConditionOk) {</TD></TR><TR CLASS="c"><TD CLASS="l">398</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">399</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">401</TD><TD>        state = AFTER_LAST;</TD></TR><TR CLASS="c"><TD CLASS="l">402</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">403</TD><TD>    }</TD></TR><TR><TD CLASS="l">404</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="37">405</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">406</TD><TD>     * Set the state of this and all nested tables to the NULL row.</TD></TR><TR><TD CLASS="l">407</TD><TD>     */</TD></TR><TR><TD CLASS="l">408</TD><TD>    protected void setNullRow() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="3c">409</A></TD><TD>        state = NULL_ROW;</TD></TR><TR CLASS="c"><TD CLASS="l">410</TD><TD>        current = table.getNullRow();</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="3e">411</A></TD><TD>        currentSearchRow = current;</TD></TR><TR CLASS="c"><TD CLASS="l">412</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">413</TD><TD>            nestedJoin.visit(new TableFilterVisitor() {</TD></TR><TR><TD CLASS="l">414</TD><TD>                public void accept(TableFilter f) {</TD></TR><TR CLASS="c"><TD CLASS="l">415</TD><TD>                    f.setNullRow();</TD></TR><TR CLASS="c"><TD CLASS="l">416</TD><TD>                }</TD></TR><TR><TD CLASS="l">417</TD><TD>            });</TD></TR><TR><TD CLASS="l"><A NAME="15">418</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">419</TD><TD>    }</TD></TR><TR><TD CLASS="l">420</TD><TD> </TD></TR><TR><TD CLASS="l">421</TD><TD>    private void checkTimeout() {</TD></TR><TR CLASS="c"><TD CLASS="l">422</TD><TD>        session.checkCanceled();</TD></TR><TR><TD CLASS="l">423</TD><TD>        // System.out.println(this.alias+ &#34; &#34; + table.getName() + &#34;: &#34; +</TD></TR><TR><TD CLASS="l"><A NAME="2a">424</A></TD><TD>        // scanCount);</TD></TR><TR CLASS="c"><TD CLASS="l">425</TD><TD>    }</TD></TR><TR><TD CLASS="l">426</TD><TD> </TD></TR><TR><TD CLASS="l">427</TD><TD>    private boolean isOk(Expression condition) {</TD></TR><TR CLASS="c"><TD CLASS="l">428</TD><TD>        if (condition == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">429</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">430</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">431</TD><TD>        return Boolean.TRUE.equals(condition.getBooleanValue(session));</TD></TR><TR><TD CLASS="l">432</TD><TD>    }</TD></TR><TR><TD CLASS="l">433</TD><TD> </TD></TR><TR><TD CLASS="l">434</TD><TD>    /**</TD></TR><TR><TD CLASS="l">435</TD><TD>     * Get the current row.</TD></TR><TR><TD CLASS="l"><A NAME="16">436</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">437</TD><TD>     * @return the current row, or null</TD></TR><TR><TD CLASS="l">438</TD><TD>     */</TD></TR><TR><TD CLASS="l">439</TD><TD>    public Row get() {</TD></TR><TR CLASS="c"><TD CLASS="l">440</TD><TD>        if (current == null &amp;&amp; currentSearchRow != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">441</TD><TD>            current = cursor.get();</TD></TR><TR><TD CLASS="l">442</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">443</TD><TD>        return current;</TD></TR><TR><TD CLASS="l">444</TD><TD>    }</TD></TR><TR><TD CLASS="l">445</TD><TD> </TD></TR><TR><TD CLASS="l">446</TD><TD>    /**</TD></TR><TR><TD CLASS="l">447</TD><TD>     * Set the current row.</TD></TR><TR><TD CLASS="l">448</TD><TD>     *</TD></TR><TR><TD CLASS="l">449</TD><TD>     * @param current the current row</TD></TR><TR><TD CLASS="l"><A NAME="32">450</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">451</TD><TD>    public void set(Row current) {</TD></TR><TR><TD CLASS="l">452</TD><TD>        // this is currently only used so that check constraints work - to set</TD></TR><TR><TD CLASS="l">453</TD><TD>        // the current (new) row</TD></TR><TR CLASS="c"><TD CLASS="l">454</TD><TD>        this.current = current;</TD></TR><TR CLASS="c"><TD CLASS="l">455</TD><TD>        this.currentSearchRow = current;</TD></TR><TR CLASS="c"><TD CLASS="l">456</TD><TD>    }</TD></TR><TR><TD CLASS="l">457</TD><TD> </TD></TR><TR><TD CLASS="l">458</TD><TD>    /**</TD></TR><TR><TD CLASS="l">459</TD><TD>     * Get the table alias name. If no alias is specified, the table name is</TD></TR><TR><TD CLASS="l">460</TD><TD>     * returned.</TD></TR><TR><TD CLASS="l"><A NAME="22">461</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">462</TD><TD>     * @return the alias name</TD></TR><TR><TD CLASS="l">463</TD><TD>     */</TD></TR><TR><TD CLASS="l">464</TD><TD>    public String getTableAlias() {</TD></TR><TR CLASS="c"><TD CLASS="l">465</TD><TD>        if (alias != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">466</TD><TD>            return alias;</TD></TR><TR><TD CLASS="l">467</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">468</TD><TD>        return table.getName();</TD></TR><TR><TD CLASS="l">469</TD><TD>    }</TD></TR><TR><TD CLASS="l">470</TD><TD> </TD></TR><TR><TD CLASS="l">471</TD><TD>    /**</TD></TR><TR><TD CLASS="l">472</TD><TD>     * Add an index condition.</TD></TR><TR><TD CLASS="l"><A NAME="13">473</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">474</TD><TD>     * @param condition the index condition</TD></TR><TR><TD CLASS="l">475</TD><TD>     */</TD></TR><TR><TD CLASS="l">476</TD><TD>    public void addIndexCondition(IndexCondition condition) {</TD></TR><TR CLASS="c"><TD CLASS="l">477</TD><TD>        indexConditions.add(condition);</TD></TR><TR CLASS="c"><TD CLASS="l">478</TD><TD>    }</TD></TR><TR><TD CLASS="l">479</TD><TD> </TD></TR><TR><TD CLASS="l">480</TD><TD>    /**</TD></TR><TR><TD CLASS="l">481</TD><TD>     * Add a filter condition.</TD></TR><TR><TD CLASS="l">482</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="9">483</A></TD><TD>     * @param condition the condition</TD></TR><TR><TD CLASS="l">484</TD><TD>     * @param isJoin if this is in fact a join condition</TD></TR><TR><TD CLASS="l">485</TD><TD>     */</TD></TR><TR><TD CLASS="l">486</TD><TD>    public void addFilterCondition(Expression condition, boolean isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">487</TD><TD>        if (isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">488</TD><TD>            if (joinCondition == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">489</TD><TD>                joinCondition = condition;</TD></TR><TR><TD CLASS="l">490</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>                joinCondition = new ConditionAndOr(ConditionAndOr.AND, joinCondition, condition);</TD></TR><TR><TD CLASS="l">492</TD><TD>            }</TD></TR><TR><TD CLASS="l">493</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">494</TD><TD>            if (filterCondition == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">495</TD><TD>                filterCondition = condition;</TD></TR><TR><TD CLASS="l">496</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">497</TD><TD>                filterCondition = new ConditionAndOr(ConditionAndOr.AND, filterCondition, condition);</TD></TR><TR><TD CLASS="l">498</TD><TD>            }</TD></TR><TR><TD CLASS="l">499</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">500</TD><TD>    }</TD></TR><TR><TD CLASS="l">501</TD><TD> </TD></TR><TR><TD CLASS="l">502</TD><TD>    /**</TD></TR><TR><TD CLASS="l">503</TD><TD>     * Add a joined table.</TD></TR><TR><TD CLASS="l">504</TD><TD>     *</TD></TR><TR><TD CLASS="l">505</TD><TD>     * @param filter the joined table filter</TD></TR><TR><TD CLASS="l">506</TD><TD>     * @param outer if this is an outer join</TD></TR><TR><TD CLASS="l"><A NAME="a">507</A></TD><TD>     * @param nested if this is a nested join</TD></TR><TR><TD CLASS="l">508</TD><TD>     * @param on the join condition</TD></TR><TR><TD CLASS="l">509</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="3f">510</A></TD><TD>    public void addJoin(TableFilter filter, boolean outer, boolean nested, final Expression on) {</TD></TR><TR CLASS="c"><TD CLASS="l">511</TD><TD>        if (on != null) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="41">512</A></TD><TD>            on.mapColumns(this, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">513</TD><TD>            if (session.getDatabase().getSettings().nestedJoins) {</TD></TR><TR CLASS="c"><TD CLASS="l">514</TD><TD>                visit(new TableFilterVisitor() {</TD></TR><TR><TD CLASS="l"><A NAME="42">515</A></TD><TD>                    public void accept(TableFilter f) {</TD></TR><TR CLASS="c"><TD CLASS="l">516</TD><TD>                        on.mapColumns(f, 0);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="44">517</A></TD><TD>                    }</TD></TR><TR><TD CLASS="l">518</TD><TD>                });</TD></TR><TR CLASS="c"><TD CLASS="l">519</TD><TD>                filter.visit(new TableFilterVisitor() {</TD></TR><TR><TD CLASS="l">520</TD><TD>                    public void accept(TableFilter f) {</TD></TR><TR CLASS="c"><TD CLASS="l">521</TD><TD>                        on.mapColumns(f, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">522</TD><TD>                    }</TD></TR><TR><TD CLASS="l">523</TD><TD>                });</TD></TR><TR><TD CLASS="l">524</TD><TD>            }</TD></TR><TR><TD CLASS="l">525</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">526</TD><TD>        if (nested &amp;&amp; session.getDatabase().getSettings().nestedJoins) {</TD></TR><TR CLASS="c"><TD CLASS="l">527</TD><TD>            if (nestedJoin != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">528</TD><TD>                throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">529</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">530</TD><TD>            nestedJoin = filter;</TD></TR><TR CLASS="c"><TD CLASS="l">531</TD><TD>            filter.joinOuter = outer;</TD></TR><TR CLASS="c"><TD CLASS="l">532</TD><TD>            if (outer) {</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>                visit(new TableFilterVisitor() {</TD></TR><TR><TD CLASS="l">534</TD><TD>                    public void accept(TableFilter f) {</TD></TR><TR><TD CLASS="l">535</TD><TD>                        f.joinOuterIndirect = true;</TD></TR><TR><TD CLASS="l">536</TD><TD>                    }</TD></TR><TR><TD CLASS="l">537</TD><TD>                });</TD></TR><TR><TD CLASS="l">538</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">539</TD><TD>            if (on != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">540</TD><TD>                filter.mapAndAddFilter(on);</TD></TR><TR><TD CLASS="l">541</TD><TD>            }</TD></TR><TR><TD CLASS="l">542</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">543</TD><TD>            if (join == null) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="45">544</A></TD><TD>                join = filter;</TD></TR><TR CLASS="c"><TD CLASS="l">545</TD><TD>                filter.joinOuter = outer;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="47">546</A></TD><TD>                if (session.getDatabase().getSettings().nestedJoins) {</TD></TR><TR CLASS="c"><TD CLASS="l">547</TD><TD>                    if (outer) {</TD></TR><TR CLASS="c"><TD CLASS="l">548</TD><TD>                        filter.visit(new TableFilterVisitor() {</TD></TR><TR><TD CLASS="l">549</TD><TD>                            public void accept(TableFilter f) {</TD></TR><TR CLASS="c"><TD CLASS="l">550</TD><TD>                                f.joinOuterIndirect = true;</TD></TR><TR CLASS="c"><TD CLASS="l">551</TD><TD>                            }</TD></TR><TR><TD CLASS="l">552</TD><TD>                        });</TD></TR><TR><TD CLASS="l">553</TD><TD>                    }</TD></TR><TR><TD CLASS="l">554</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>                    if (outer) {</TD></TR><TR><TD CLASS="l">556</TD><TD>                        // convert all inner joins on the right hand side to outer joins</TD></TR><TR CLASS="z"><TD CLASS="l">557</TD><TD>                        TableFilter f = filter.join;</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>                        while (f != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>                            f.joinOuter = true;</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>                            f = f.join;</TD></TR><TR><TD CLASS="l">561</TD><TD>                        }</TD></TR><TR><TD CLASS="l">562</TD><TD>                    }</TD></TR><TR><TD CLASS="l">563</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">564</TD><TD>                if (on != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">565</TD><TD>                    filter.mapAndAddFilter(on);</TD></TR><TR><TD CLASS="l">566</TD><TD>                }</TD></TR><TR><TD CLASS="l">567</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">568</TD><TD>                join.addJoin(filter, outer, nested, on);</TD></TR><TR><TD CLASS="l">569</TD><TD>            }</TD></TR><TR><TD CLASS="l">570</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">571</TD><TD>    }</TD></TR><TR><TD CLASS="l">572</TD><TD> </TD></TR><TR><TD CLASS="l">573</TD><TD>    /**</TD></TR><TR><TD CLASS="l">574</TD><TD>     * Map the columns and add the join condition.</TD></TR><TR><TD CLASS="l"><A NAME="c">575</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">576</TD><TD>     * @param on the condition</TD></TR><TR><TD CLASS="l">577</TD><TD>     */</TD></TR><TR><TD CLASS="l">578</TD><TD>    public void mapAndAddFilter(Expression on) {</TD></TR><TR CLASS="c"><TD CLASS="l">579</TD><TD>        on.mapColumns(this, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">580</TD><TD>        addFilterCondition(on, true);</TD></TR><TR CLASS="c"><TD CLASS="l">581</TD><TD>        on.createIndexConditions(session, this);</TD></TR><TR CLASS="c"><TD CLASS="l">582</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">583</TD><TD>            on.mapColumns(nestedJoin, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">584</TD><TD>            on.createIndexConditions(session, nestedJoin);</TD></TR><TR><TD CLASS="l">585</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">586</TD><TD>        if (join != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>            join.mapAndAddFilter(on);</TD></TR><TR><TD CLASS="l"><A NAME="1b">588</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">589</TD><TD>    }</TD></TR><TR><TD CLASS="l">590</TD><TD> </TD></TR><TR><TD CLASS="l">591</TD><TD>    public TableFilter getJoin() {</TD></TR><TR CLASS="c"><TD CLASS="l">592</TD><TD>        return join;</TD></TR><TR><TD CLASS="l">593</TD><TD>    }</TD></TR><TR><TD CLASS="l">594</TD><TD> </TD></TR><TR><TD CLASS="l">595</TD><TD>    /**</TD></TR><TR><TD CLASS="l">596</TD><TD>     * Whether this is an outer joined table.</TD></TR><TR><TD CLASS="l"><A NAME="27">597</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">598</TD><TD>     * @return true if it is</TD></TR><TR><TD CLASS="l">599</TD><TD>     */</TD></TR><TR><TD CLASS="l">600</TD><TD>    public boolean isJoinOuter() {</TD></TR><TR CLASS="c"><TD CLASS="l">601</TD><TD>        return joinOuter;</TD></TR><TR><TD CLASS="l">602</TD><TD>    }</TD></TR><TR><TD CLASS="l">603</TD><TD> </TD></TR><TR><TD CLASS="l">604</TD><TD>    /**</TD></TR><TR><TD CLASS="l">605</TD><TD>     * Whether this is indirectly an outer joined table (nested within an inner</TD></TR><TR><TD CLASS="l">606</TD><TD>     * join).</TD></TR><TR><TD CLASS="l"><A NAME="28">607</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">608</TD><TD>     * @return true if it is</TD></TR><TR><TD CLASS="l">609</TD><TD>     */</TD></TR><TR><TD CLASS="l">610</TD><TD>    public boolean isJoinOuterIndirect() {</TD></TR><TR CLASS="c"><TD CLASS="l">611</TD><TD>        return joinOuterIndirect;</TD></TR><TR><TD CLASS="l">612</TD><TD>    }</TD></TR><TR><TD CLASS="l">613</TD><TD> </TD></TR><TR><TD CLASS="l">614</TD><TD>    /**</TD></TR><TR><TD CLASS="l">615</TD><TD>     * Get the query execution plan text to use for this table filter.</TD></TR><TR><TD CLASS="l">616</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="d">617</A></TD><TD>     * @param isJoin if this is a joined table</TD></TR><TR><TD CLASS="l">618</TD><TD>     * @return the SQL statement snippet</TD></TR><TR><TD CLASS="l">619</TD><TD>     */</TD></TR><TR><TD CLASS="l">620</TD><TD>    public String getPlanSQL(boolean isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">621</TD><TD>        StringBuilder buff = new StringBuilder();</TD></TR><TR CLASS="c"><TD CLASS="l">622</TD><TD>        if (isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">623</TD><TD>            if (joinOuter) {</TD></TR><TR CLASS="c"><TD CLASS="l">624</TD><TD>                buff.append(&#34;LEFT OUTER JOIN &#34;);</TD></TR><TR><TD CLASS="l">625</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">626</TD><TD>                buff.append(&#34;INNER JOIN &#34;);</TD></TR><TR><TD CLASS="l">627</TD><TD>            }</TD></TR><TR><TD CLASS="l">628</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">629</TD><TD>        if (nestedJoin != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">630</TD><TD>            StringBuffer buffNested = new StringBuffer();</TD></TR><TR CLASS="c"><TD CLASS="l">631</TD><TD>            TableFilter n = nestedJoin;</TD></TR><TR><TD CLASS="l">632</TD><TD>            do {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="90% line coverage (19 out of 21 instructions)">633</TD><TD TITLE="90% line coverage (19 out of 21 instructions)">                buffNested.append(n.getPlanSQL(n != nestedJoin));</TD></TR><TR CLASS="c"><TD CLASS="l">634</TD><TD>                buffNested.append('\n');</TD></TR><TR CLASS="c"><TD CLASS="l">635</TD><TD>                n = n.getJoin();</TD></TR><TR CLASS="c"><TD CLASS="l">636</TD><TD>            } while (n != null);</TD></TR><TR CLASS="c"><TD CLASS="l">637</TD><TD>            String nested = buffNested.toString();</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="85% line coverage (11 out of 13 instructions)">638</TD><TD TITLE="85% line coverage (11 out of 13 instructions)">            boolean enclose = !nested.startsWith(&#34;(&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">639</TD><TD>            if (enclose) {</TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>                buff.append(&#34;(\n&#34;);</TD></TR><TR><TD CLASS="l">641</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">642</TD><TD>            buff.append(StringUtils.indent(nested, 4, false));</TD></TR><TR CLASS="c"><TD CLASS="l">643</TD><TD>            if (enclose) {</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>                buff.append(')');</TD></TR><TR><TD CLASS="l">645</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">646</TD><TD>            if (isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">647</TD><TD>                buff.append(&#34; ON &#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">648</TD><TD>                if (joinCondition == null) {</TD></TR><TR><TD CLASS="l">649</TD><TD>                    // need to have a ON expression,</TD></TR><TR><TD CLASS="l">650</TD><TD>                    // otherwise the nesting is unclear</TD></TR><TR CLASS="c"><TD CLASS="l">651</TD><TD>                    buff.append(&#34;1=1&#34;);</TD></TR><TR><TD CLASS="l">652</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">653</TD><TD>                    buff.append(StringUtils.unEnclose(joinCondition.getSQL()));</TD></TR><TR><TD CLASS="l">654</TD><TD>                }</TD></TR><TR><TD CLASS="l">655</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">656</TD><TD>            return buff.toString();</TD></TR><TR><TD CLASS="l">657</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">658</TD><TD>        buff.append(table.getSQL());</TD></TR><TR CLASS="c"><TD CLASS="l">659</TD><TD>        if (alias != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">660</TD><TD>            buff.append(' ').append(Parser.quoteIdentifier(alias));</TD></TR><TR><TD CLASS="l">661</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">662</TD><TD>        if (index != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">663</TD><TD>            buff.append('\n');</TD></TR><TR CLASS="c"><TD CLASS="l">664</TD><TD>            StatementBuilder planBuff = new StatementBuilder();</TD></TR><TR CLASS="c"><TD CLASS="l">665</TD><TD>            planBuff.append(index.getPlanSQL());</TD></TR><TR CLASS="c"><TD CLASS="l">666</TD><TD>            if (indexConditions.size() &gt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">667</TD><TD>                planBuff.append(&#34;: &#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">668</TD><TD>                for (IndexCondition condition : indexConditions) {</TD></TR><TR CLASS="c"><TD CLASS="l">669</TD><TD>                    planBuff.appendExceptFirst(&#34;\n    AND &#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">670</TD><TD>                    planBuff.append(condition.getSQL());</TD></TR><TR><TD CLASS="l">671</TD><TD>                }</TD></TR><TR><TD CLASS="l">672</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">673</TD><TD>            String plan = StringUtils.quoteRemarkSQL(planBuff.toString());</TD></TR><TR CLASS="c"><TD CLASS="l">674</TD><TD>            if (plan.indexOf('\n') &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">675</TD><TD>                plan += &#34;\n&#34;;</TD></TR><TR><TD CLASS="l">676</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">677</TD><TD>            buff.append(StringUtils.indent(&#34;/* &#34; + plan + &#34; */&#34;, 4, false));</TD></TR><TR><TD CLASS="l">678</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">679</TD><TD>        if (isJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">680</TD><TD>            buff.append(&#34;\n    ON &#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">681</TD><TD>            if (joinCondition == null) {</TD></TR><TR><TD CLASS="l">682</TD><TD>                // need to have a ON expression, otherwise the nesting is</TD></TR><TR><TD CLASS="l">683</TD><TD>                // unclear</TD></TR><TR CLASS="c"><TD CLASS="l">684</TD><TD>                buff.append(&#34;1=1&#34;);</TD></TR><TR><TD CLASS="l">685</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">686</TD><TD>                buff.append(StringUtils.unEnclose(joinCondition.getSQL()));</TD></TR><TR><TD CLASS="l">687</TD><TD>            }</TD></TR><TR><TD CLASS="l">688</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">689</TD><TD>        if (filterCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">690</TD><TD>            buff.append('\n');</TD></TR><TR CLASS="c"><TD CLASS="l">691</TD><TD>            String condition = StringUtils.unEnclose(filterCondition.getSQL());</TD></TR><TR CLASS="c"><TD CLASS="l">692</TD><TD>            condition = &#34;/* WHERE &#34; + StringUtils.quoteRemarkSQL(condition) + &#34;\n*/&#34;;</TD></TR><TR CLASS="c"><TD CLASS="l">693</TD><TD>            buff.append(StringUtils.indent(condition, 4, false));</TD></TR><TR><TD CLASS="l">694</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">695</TD><TD>        if (scanCount &gt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">696</TD><TD>            buff.append(&#34;\n    /* scanCount: &#34;).append(scanCount).append(&#34; */&#34;);</TD></TR><TR><TD CLASS="l">697</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">698</TD><TD>        return buff.toString();</TD></TR><TR><TD CLASS="l">699</TD><TD>    }</TD></TR><TR><TD CLASS="l">700</TD><TD> </TD></TR><TR><TD CLASS="l">701</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="30">702</A></TD><TD>     * Remove all index conditions that are not used by the current index.</TD></TR><TR><TD CLASS="l">703</TD><TD>     */</TD></TR><TR><TD CLASS="l">704</TD><TD>    void removeUnusableIndexConditions() {</TD></TR><TR><TD CLASS="l">705</TD><TD>        // the indexConditions list may be modified here</TD></TR><TR CLASS="c"><TD CLASS="l">706</TD><TD>        for (int i = 0; i &lt; indexConditions.size(); i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">707</TD><TD>            IndexCondition cond = indexConditions.get(i);</TD></TR><TR CLASS="c"><TD CLASS="l">708</TD><TD>            if (!cond.isEvaluatable()) {</TD></TR><TR CLASS="c"><TD CLASS="l">709</TD><TD>                indexConditions.remove(i--);</TD></TR><TR><TD CLASS="l">710</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="1a">711</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">712</TD><TD>    }</TD></TR><TR><TD CLASS="l">713</TD><TD> </TD></TR><TR><TD CLASS="l">714</TD><TD>    public Index getIndex() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="36">715</A></TD><TD>        return index;</TD></TR><TR><TD CLASS="l">716</TD><TD>    }</TD></TR><TR><TD CLASS="l">717</TD><TD> </TD></TR><TR><TD CLASS="l">718</TD><TD>    public void setIndex(Index index) {</TD></TR><TR CLASS="c"><TD CLASS="l">719</TD><TD>        this.index = index;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="39">720</A></TD><TD>        cursor.setIndex(index);</TD></TR><TR CLASS="c"><TD CLASS="l">721</TD><TD>    }</TD></TR><TR><TD CLASS="l">722</TD><TD> </TD></TR><TR><TD CLASS="l">723</TD><TD>    public void setUsed(boolean used) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="2b">724</A></TD><TD>        this.used = used;</TD></TR><TR CLASS="c"><TD CLASS="l">725</TD><TD>    }</TD></TR><TR><TD CLASS="l">726</TD><TD> </TD></TR><TR><TD CLASS="l">727</TD><TD>    public boolean isUsed() {</TD></TR><TR CLASS="c"><TD CLASS="l">728</TD><TD>        return used;</TD></TR><TR><TD CLASS="l">729</TD><TD>    }</TD></TR><TR><TD CLASS="l">730</TD><TD> </TD></TR><TR><TD CLASS="l">731</TD><TD>    /**</TD></TR><TR><TD CLASS="l">732</TD><TD>     * Set the session of this table filter.</TD></TR><TR><TD CLASS="l"><A NAME="38">733</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">734</TD><TD>     * @param session the new session</TD></TR><TR><TD CLASS="l">735</TD><TD>     */</TD></TR><TR><TD CLASS="l">736</TD><TD>    void setSession(Session session) {</TD></TR><TR CLASS="c"><TD CLASS="l">737</TD><TD>        this.session = session;</TD></TR><TR CLASS="c"><TD CLASS="l">738</TD><TD>    }</TD></TR><TR><TD CLASS="l">739</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2e">740</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">741</TD><TD>     * Remove the joined table</TD></TR><TR><TD CLASS="l">742</TD><TD>     */</TD></TR><TR><TD CLASS="l">743</TD><TD>    public void removeJoin() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1c">744</A></TD><TD>        this.join = null;</TD></TR><TR CLASS="c"><TD CLASS="l">745</TD><TD>    }</TD></TR><TR><TD CLASS="l">746</TD><TD> </TD></TR><TR><TD CLASS="l">747</TD><TD>    public Expression getJoinCondition() {</TD></TR><TR CLASS="c"><TD CLASS="l">748</TD><TD>        return joinCondition;</TD></TR><TR><TD CLASS="l">749</TD><TD>    }</TD></TR><TR><TD CLASS="l">750</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2f">751</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">752</TD><TD>     * Remove the join condition.</TD></TR><TR><TD CLASS="l">753</TD><TD>     */</TD></TR><TR><TD CLASS="l">754</TD><TD>    public void removeJoinCondition() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="19">755</A></TD><TD>        this.joinCondition = null;</TD></TR><TR CLASS="c"><TD CLASS="l">756</TD><TD>    }</TD></TR><TR><TD CLASS="l">757</TD><TD> </TD></TR><TR><TD CLASS="l">758</TD><TD>    public Expression getFilterCondition() {</TD></TR><TR CLASS="c"><TD CLASS="l">759</TD><TD>        return filterCondition;</TD></TR><TR><TD CLASS="l">760</TD><TD>    }</TD></TR><TR><TD CLASS="l">761</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="4">762</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">763</TD><TD>     * Remove the filter condition.</TD></TR><TR><TD CLASS="l">764</TD><TD>     */</TD></TR><TR><TD CLASS="l">765</TD><TD>    public void removeFilterCondition() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="35">766</A></TD><TD>        this.filterCondition = null;</TD></TR><TR CLASS="z"><TD CLASS="l">767</TD><TD>    }</TD></TR><TR><TD CLASS="l">768</TD><TD> </TD></TR><TR><TD CLASS="l">769</TD><TD>    public void setFullCondition(Expression condition) {</TD></TR><TR CLASS="c"><TD CLASS="l">770</TD><TD>        this.fullCondition = condition;</TD></TR><TR CLASS="c"><TD CLASS="l">771</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">772</TD><TD>            join.setFullCondition(condition);</TD></TR><TR><TD CLASS="l">773</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">774</TD><TD>    }</TD></TR><TR><TD CLASS="l">775</TD><TD> </TD></TR><TR><TD CLASS="l">776</TD><TD>    /**</TD></TR><TR><TD CLASS="l">777</TD><TD>     * Optimize the full condition. This will add the full condition to the</TD></TR><TR><TD CLASS="l">778</TD><TD>     * filter condition.</TD></TR><TR><TD CLASS="l"><A NAME="f">779</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">780</TD><TD>     * @param fromOuterJoin if this method was called from an outer joined table</TD></TR><TR><TD CLASS="l">781</TD><TD>     */</TD></TR><TR><TD CLASS="l">782</TD><TD>    void optimizeFullCondition(boolean fromOuterJoin) {</TD></TR><TR CLASS="c"><TD CLASS="l">783</TD><TD>        if (fullCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">784</TD><TD>            fullCondition.addFilterConditions(this, fromOuterJoin || joinOuter);</TD></TR><TR CLASS="c"><TD CLASS="l">785</TD><TD>            if (nestedJoin != null) {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="82% line coverage (9 out of 11 instructions)">786</TD><TD TITLE="82% line coverage (9 out of 11 instructions)">                nestedJoin.optimizeFullCondition(fromOuterJoin || joinOuter);</TD></TR><TR><TD CLASS="l">787</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">788</TD><TD>            if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">789</TD><TD>                join.optimizeFullCondition(fromOuterJoin || joinOuter);</TD></TR><TR><TD CLASS="l">790</TD><TD>            }</TD></TR><TR><TD CLASS="l">791</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">792</TD><TD>    }</TD></TR><TR><TD CLASS="l">793</TD><TD> </TD></TR><TR><TD CLASS="l">794</TD><TD>    /**</TD></TR><TR><TD CLASS="l">795</TD><TD>     * Update the filter and join conditions of this and all joined tables with</TD></TR><TR><TD CLASS="l">796</TD><TD>     * the information that the given table filter and all nested filter can now</TD></TR><TR><TD CLASS="l">797</TD><TD>     * return rows or not.</TD></TR><TR><TD CLASS="l">798</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="33">799</A></TD><TD>     * @param filter the table filter</TD></TR><TR><TD CLASS="l">800</TD><TD>     * @param b the new flag</TD></TR><TR><TD CLASS="l">801</TD><TD>     */</TD></TR><TR><TD CLASS="l">802</TD><TD>    public void setEvaluatable(TableFilter filter, boolean b) {</TD></TR><TR CLASS="c"><TD CLASS="l">803</TD><TD>        filter.setEvaluatable(b);</TD></TR><TR CLASS="c"><TD CLASS="l">804</TD><TD>        if (filterCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">805</TD><TD>            filterCondition.setEvaluatable(filter, b);</TD></TR><TR><TD CLASS="l">806</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">807</TD><TD>        if (joinCondition != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">808</TD><TD>            joinCondition.setEvaluatable(filter, b);</TD></TR><TR><TD CLASS="l">809</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">810</TD><TD>        if (nestedJoin != null) {</TD></TR><TR><TD CLASS="l">811</TD><TD>            // don't enable / disable the nested join filters</TD></TR><TR><TD CLASS="l">812</TD><TD>            // if enabling a filter in a joined filter</TD></TR><TR CLASS="c"><TD CLASS="l">813</TD><TD>            if (this == filter) {</TD></TR><TR CLASS="c"><TD CLASS="l">814</TD><TD>                nestedJoin.setEvaluatable(nestedJoin, b);</TD></TR><TR><TD CLASS="l">815</TD><TD>            }</TD></TR><TR><TD CLASS="l">816</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">817</TD><TD>        if (join != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">818</TD><TD>            join.setEvaluatable(filter, b);</TD></TR><TR><TD CLASS="l"><A NAME="34">819</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">820</TD><TD>    }</TD></TR><TR><TD CLASS="l">821</TD><TD> </TD></TR><TR><TD CLASS="l">822</TD><TD>    public void setEvaluatable(boolean evaluatable) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1e">823</A></TD><TD>        this.evaluatable = evaluatable;</TD></TR><TR CLASS="c"><TD CLASS="l">824</TD><TD>    }</TD></TR><TR><TD CLASS="l">825</TD><TD> </TD></TR><TR><TD CLASS="l">826</TD><TD>    public String getSchemaName() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="18">827</A></TD><TD>        return table.getSchema().getName();</TD></TR><TR><TD CLASS="l">828</TD><TD>    }</TD></TR><TR><TD CLASS="l">829</TD><TD> </TD></TR><TR><TD CLASS="l">830</TD><TD>    public Column[] getColumns() {</TD></TR><TR CLASS="c"><TD CLASS="l">831</TD><TD>        return table.getColumns();</TD></TR><TR><TD CLASS="l">832</TD><TD>    }</TD></TR><TR><TD CLASS="l">833</TD><TD> </TD></TR><TR><TD CLASS="l">834</TD><TD>    /**</TD></TR><TR><TD CLASS="l">835</TD><TD>     * Get the system columns that this table understands. This is used for</TD></TR><TR><TD CLASS="l">836</TD><TD>     * compatibility with other databases. The columns are only returned if the</TD></TR><TR><TD CLASS="l">837</TD><TD>     * current mode supports system columns.</TD></TR><TR><TD CLASS="l"><A NAME="7">838</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">839</TD><TD>     * @return the system columns</TD></TR><TR><TD CLASS="l">840</TD><TD>     */</TD></TR><TR><TD CLASS="l">841</TD><TD>    public Column[] getSystemColumns() {</TD></TR><TR CLASS="c"><TD CLASS="l">842</TD><TD>        if (!session.getDatabase().getMode().systemColumns) {</TD></TR><TR CLASS="c"><TD CLASS="l">843</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">844</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>        Column[] sys = new Column[3];</TD></TR><TR CLASS="z"><TD CLASS="l">846</TD><TD>        sys[0] = new Column(&#34;oid&#34;, Value.INT);</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>        sys[0].setTable(table, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">848</TD><TD>        sys[1] = new Column(&#34;ctid&#34;, Value.STRING);</TD></TR><TR CLASS="z"><TD CLASS="l">849</TD><TD>        sys[1].setTable(table, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">850</TD><TD>        sys[2] = new Column(&#34;CTID&#34;, Value.STRING);</TD></TR><TR CLASS="z"><TD CLASS="l">851</TD><TD>        sys[2].setTable(table, 0);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1">852</A></TD><TD>        return sys;</TD></TR><TR><TD CLASS="l">853</TD><TD>    }</TD></TR><TR><TD CLASS="l">854</TD><TD> </TD></TR><TR><TD CLASS="l">855</TD><TD>    public Column getRowIdColumn() {</TD></TR><TR CLASS="z"><TD CLASS="l">856</TD><TD>        if (session.getDatabase().getSettings().rowId) {</TD></TR><TR CLASS="z"><TD CLASS="l">857</TD><TD>            return table.getRowIdColumn();</TD></TR><TR><TD CLASS="l">858</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="b">859</A></TD><TD>        return null;</TD></TR><TR><TD CLASS="l">860</TD><TD>    }</TD></TR><TR><TD CLASS="l">861</TD><TD> </TD></TR><TR><TD CLASS="l">862</TD><TD>    public Value getValue(Column column) {</TD></TR><TR CLASS="c"><TD CLASS="l">863</TD><TD>        if (currentSearchRow == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">864</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">865</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">866</TD><TD>        int columnId = column.getColumnId();</TD></TR><TR CLASS="c"><TD CLASS="l">867</TD><TD>        if (columnId == -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">868</TD><TD>            return ValueLong.get(currentSearchRow.getKey());</TD></TR><TR><TD CLASS="l">869</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">870</TD><TD>        if (current == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">871</TD><TD>            Value v = currentSearchRow.getValue(columnId);</TD></TR><TR CLASS="c"><TD CLASS="l">872</TD><TD>            if (v != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">873</TD><TD>                return v;</TD></TR><TR><TD CLASS="l">874</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">875</TD><TD>            current = cursor.get();</TD></TR><TR CLASS="c"><TD CLASS="l">876</TD><TD>            if (current == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">877</TD><TD>                return ValueNull.INSTANCE;</TD></TR><TR><TD CLASS="l">878</TD><TD>            }</TD></TR><TR><TD CLASS="l">879</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="23">880</A></TD><TD>        return current.getValue(columnId);</TD></TR><TR><TD CLASS="l">881</TD><TD>    }</TD></TR><TR><TD CLASS="l">882</TD><TD> </TD></TR><TR><TD CLASS="l">883</TD><TD>    public TableFilter getTableFilter() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5">884</A></TD><TD>        return this;</TD></TR><TR><TD CLASS="l">885</TD><TD>    }</TD></TR><TR><TD CLASS="l">886</TD><TD> </TD></TR><TR><TD CLASS="l">887</TD><TD>    public void setAlias(String alias) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2d">888</A></TD><TD>        this.alias = alias;</TD></TR><TR CLASS="z"><TD CLASS="l">889</TD><TD>    }</TD></TR><TR><TD CLASS="l">890</TD><TD> </TD></TR><TR><TD CLASS="l">891</TD><TD>    public Expression optimize(ExpressionColumn expressionColumn, Column column) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6">892</A></TD><TD>        return expressionColumn;</TD></TR><TR><TD CLASS="l">893</TD><TD>    }</TD></TR><TR><TD CLASS="l">894</TD><TD> </TD></TR><TR><TD CLASS="l">895</TD><TD>    public String toString() {</TD></TR><TR CLASS="z"><TD CLASS="l">896</TD><TD>        return alias != null ? alias : table.toString();</TD></TR><TR><TD CLASS="l">897</TD><TD>    }</TD></TR><TR><TD CLASS="l">898</TD><TD> </TD></TR><TR><TD CLASS="l">899</TD><TD>    /**</TD></TR><TR><TD CLASS="l">900</TD><TD>     * Add a column to the natural join key column list.</TD></TR><TR><TD CLASS="l"><A NAME="14">901</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">902</TD><TD>     * @param c the column to add</TD></TR><TR><TD CLASS="l">903</TD><TD>     */</TD></TR><TR><TD CLASS="l">904</TD><TD>    public void addNaturalJoinColumn(Column c) {</TD></TR><TR CLASS="c"><TD CLASS="l">905</TD><TD>        if (naturalJoinColumns == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">906</TD><TD>            naturalJoinColumns = New.arrayList();</TD></TR><TR><TD CLASS="l">907</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">908</TD><TD>        naturalJoinColumns.add(c);</TD></TR><TR CLASS="c"><TD CLASS="l">909</TD><TD>    }</TD></TR><TR><TD CLASS="l">910</TD><TD> </TD></TR><TR><TD CLASS="l">911</TD><TD>    /**</TD></TR><TR><TD CLASS="l">912</TD><TD>     * Check if the given column is a natural join column.</TD></TR><TR><TD CLASS="l">913</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="29">914</A></TD><TD>     * @param c the column to check</TD></TR><TR><TD CLASS="l">915</TD><TD>     * @return true if this is a joined natural join column</TD></TR><TR><TD CLASS="l">916</TD><TD>     */</TD></TR><TR><TD CLASS="l">917</TD><TD>    public boolean isNaturalJoinColumn(Column c) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="25">918</A></TD><TD>        return naturalJoinColumns != null &amp;&amp; naturalJoinColumns.indexOf(c) &gt;= 0;</TD></TR><TR><TD CLASS="l">919</TD><TD>    }</TD></TR><TR><TD CLASS="l">920</TD><TD> </TD></TR><TR><TD CLASS="l">921</TD><TD>    public int hashCode() {</TD></TR><TR CLASS="c"><TD CLASS="l">922</TD><TD>        return hashCode;</TD></TR><TR><TD CLASS="l">923</TD><TD>    }</TD></TR><TR><TD CLASS="l">924</TD><TD> </TD></TR><TR><TD CLASS="l">925</TD><TD>    /**</TD></TR><TR><TD CLASS="l">926</TD><TD>     * Are there any index conditions that involve IN(...).</TD></TR><TR><TD CLASS="l"><A NAME="24">927</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">928</TD><TD>     * @return whether there are IN(...) comparisons</TD></TR><TR><TD CLASS="l">929</TD><TD>     */</TD></TR><TR><TD CLASS="l">930</TD><TD>    public boolean hasInComparisons() {</TD></TR><TR CLASS="c"><TD CLASS="l">931</TD><TD>        for (IndexCondition cond : indexConditions) {</TD></TR><TR CLASS="c"><TD CLASS="l">932</TD><TD>            int compareType = cond.getCompareType();</TD></TR><TR CLASS="c"><TD CLASS="l">933</TD><TD>            if (compareType == Comparison.IN_QUERY || compareType == Comparison.IN_LIST) {</TD></TR><TR CLASS="c"><TD CLASS="l">934</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">935</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">936</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">937</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">938</TD><TD>    }</TD></TR><TR><TD CLASS="l">939</TD><TD> </TD></TR><TR><TD CLASS="l">940</TD><TD>    /**</TD></TR><TR><TD CLASS="l">941</TD><TD>     * Add the current row to the array, if there is a current row.</TD></TR><TR><TD CLASS="l"><A NAME="2">942</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">943</TD><TD>     * @param rows the rows to lock</TD></TR><TR><TD CLASS="l">944</TD><TD>     */</TD></TR><TR><TD CLASS="l">945</TD><TD>    public void lockRowAdd(ArrayList&lt;Row&gt; rows) {</TD></TR><TR CLASS="z"><TD CLASS="l">946</TD><TD>        if (state == FOUND) {</TD></TR><TR CLASS="z"><TD CLASS="l">947</TD><TD>            rows.add(get());</TD></TR><TR><TD CLASS="l">948</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">949</TD><TD>    }</TD></TR><TR><TD CLASS="l">950</TD><TD> </TD></TR><TR><TD CLASS="l">951</TD><TD>    /**</TD></TR><TR><TD CLASS="l">952</TD><TD>     * Lock the given rows.</TD></TR><TR><TD CLASS="l"><A NAME="3">953</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">954</TD><TD>     * @param forUpdateRows the rows to lock</TD></TR><TR><TD CLASS="l">955</TD><TD>     */</TD></TR><TR><TD CLASS="l">956</TD><TD>    public void lockRows(ArrayList&lt;Row&gt; forUpdateRows) {</TD></TR><TR CLASS="z"><TD CLASS="l">957</TD><TD>        for (Row row : forUpdateRows) {</TD></TR><TR CLASS="z"><TD CLASS="l">958</TD><TD>            Row newRow = row.getCopy();</TD></TR><TR CLASS="z"><TD CLASS="l">959</TD><TD>            table.removeRow(session, row);</TD></TR><TR CLASS="z"><TD CLASS="l">960</TD><TD>            session.log(table, UndoLogRecord.DELETE, row);</TD></TR><TR CLASS="z"><TD CLASS="l">961</TD><TD>            table.addRow(session, newRow);</TD></TR><TR CLASS="z"><TD CLASS="l">962</TD><TD>            session.log(table, UndoLogRecord.INSERT, newRow);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1d">963</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">964</TD><TD>    }</TD></TR><TR><TD CLASS="l">965</TD><TD> </TD></TR><TR><TD CLASS="l">966</TD><TD>    public TableFilter getNestedJoin() {</TD></TR><TR CLASS="c"><TD CLASS="l">967</TD><TD>        return nestedJoin;</TD></TR><TR><TD CLASS="l">968</TD><TD>    }</TD></TR><TR><TD CLASS="l">969</TD><TD> </TD></TR><TR><TD CLASS="l">970</TD><TD>    /**</TD></TR><TR><TD CLASS="l">971</TD><TD>     * Visit this and all joined or nested table filters.</TD></TR><TR><TD CLASS="l"><A NAME="3b">972</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">973</TD><TD>     * @param visitor the visitor</TD></TR><TR><TD CLASS="l">974</TD><TD>     */</TD></TR><TR><TD CLASS="l">975</TD><TD>    public void visit(TableFilterVisitor visitor) {</TD></TR><TR CLASS="c"><TD CLASS="l">976</TD><TD>        TableFilter f = this;</TD></TR><TR><TD CLASS="l">977</TD><TD>        do {</TD></TR><TR CLASS="c"><TD CLASS="l">978</TD><TD>            visitor.accept(f);</TD></TR><TR CLASS="c"><TD CLASS="l">979</TD><TD>            TableFilter n = f.nestedJoin;</TD></TR><TR CLASS="c"><TD CLASS="l">980</TD><TD>            if (n != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">981</TD><TD>                n.visit(visitor);</TD></TR><TR><TD CLASS="l">982</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">983</TD><TD>            f = f.join;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="26">984</A></TD><TD>        } while (f != null);</TD></TR><TR CLASS="c"><TD CLASS="l">985</TD><TD>    }</TD></TR><TR><TD CLASS="l">986</TD><TD> </TD></TR><TR><TD CLASS="l">987</TD><TD>    public boolean isEvaluatable() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="20">988</A></TD><TD>        return evaluatable;</TD></TR><TR><TD CLASS="l">989</TD><TD>    }</TD></TR><TR><TD CLASS="l">990</TD><TD> </TD></TR><TR><TD CLASS="l">991</TD><TD>    public Session getSession() {</TD></TR><TR CLASS="c"><TD CLASS="l">992</TD><TD>        return session;</TD></TR><TR><TD CLASS="l">993</TD><TD>    }</TD></TR><TR><TD CLASS="l">994</TD><TD> </TD></TR><TR><TD CLASS="l">995</TD><TD>    /**</TD></TR><TR><TD CLASS="l">996</TD><TD>     * A visitor for table filters.</TD></TR><TR><TD CLASS="l">997</TD><TD>     */</TD></TR><TR><TD CLASS="l">998</TD><TD>    public interface TableFilterVisitor {</TD></TR><TR><TD CLASS="l">999</TD><TD> </TD></TR><TR><TD CLASS="l">1000</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1001</TD><TD>         * This method is called for each nested or joined table filter.</TD></TR><TR><TD CLASS="l">1002</TD><TD>         *</TD></TR><TR><TD CLASS="l">1003</TD><TD>         * @param f the filter</TD></TR><TR><TD CLASS="l">1004</TD><TD>         */</TD></TR><TR><TD CLASS="l">1005</TD><TD>        void accept(TableFilter f);</TD></TR><TR><TD CLASS="l">1006</TD><TD>    }</TD></TR><TR><TD CLASS="l">1007</TD><TD> </TD></TR><TR><TD CLASS="l">1008</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="12.html">org.h2.table</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>