<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Wed Dec 19 16:00:41 PST 2012)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="a.html">org.h2.engine</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">Database.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>Database.java</TD><TD>100% (1/1)</TD><TD>89%  (144/162)</TD><TD CLASS="h">71%  (3049/4300)</TD><TD CLASS="h">73%  (783.4/1075)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">Database</A></TD><TD>100% (1/1)</TD><TD>89%  (144/162)</TD><TD CLASS="h">71%  (3049/4300)</TD><TD CLASS="h">73%  (783.4/1075)</TD></TR><TR><TD CLASS="f"><A HREF="#1">checkpointIfRequired (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/99)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">flushSequences (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#3">getInDoubtTransactions (): ArrayList</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">getLobFileListCache (): SmallLRUCache</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#5">getPowerOffCount (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">getTraceSystem (): TraceSystem</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#7">readLob (long, byte [], long, byte [], int, int): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">setAllowLiterals (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#9">setDefaultTableType (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">setEventListener (DatabaseEventListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#b">setInitialPowerOffCount (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">setLogMode (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#d">setMaxLogSize (long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">setOptimizeReuseResults (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#f">setReadOnly (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">startServer (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#11">sync (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">toString (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#13">isReconnectNeeded (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">5%   (6/123)</TD><TD CLASS="h">7%   (2/28)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">reconnectModified (boolean): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">6%   (12/204)</TD><TD CLASS="h">5%   (2/42)</TD></TR><TR><TD CLASS="f"><A HREF="#15">beforeWriting (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">9%   (6/65)</TD><TD CLASS="h">12%  (2/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">afterWriting (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">16%  (5/32)</TD><TD CLASS="h">25%  (2/8)</TD></TR><TR><TD CLASS="f"><A HREF="#17">stopServer (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">33%  (4/12)</TD><TD CLASS="h">40%  (2/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">exceptionThrown (SQLException, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">36%  (4/11)</TD><TD CLASS="h">40%  (2/5)</TD></TR><TR><TD CLASS="f"><A HREF="#19">setLockMode (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">37%  (7/19)</TD><TD CLASS="h">57%  (4/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">shutdownImmediately (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">40%  (4/10)</TD><TD CLASS="h">50%  (3/6)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">setEventListenerClass (String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">42%  (23/55)</TD><TD CLASS="h">64%  (7/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">checkWritingAllowed (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">48%  (11/23)</TD><TD CLASS="h">50%  (4/8)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">createTempFile (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">50%  (15/30)</TD><TD CLASS="h">57%  (4/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">verifyMetaLocked (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">50%  (5/10)</TD><TD CLASS="h">52%  (1.6/3)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">closeOpenFilesAndUnlock (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">57%  (73/127)</TD><TD CLASS="h">57%  (21.1/37)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">setCacheSize (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">62%  (15/24)</TD><TD CLASS="h">71%  (5/7)</TD></TR><TR><TD CLASS="f"><A HREF="#21">openDatabase (int, int, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">65%  (42/65)</TD><TD CLASS="h">75%  (15/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">closeFiles (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">65%  (11/17)</TD><TD CLASS="h">71%  (5/7)</TD></TR><TR><TD CLASS="f"><A HREF="#23">removeSession (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">65%  (64/98)</TD><TD CLASS="h">67%  (12/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">getSchema (String): Schema</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">67%  (8/12)</TD><TD CLASS="h">75%  (3/4)</TD></TR><TR><TD CLASS="f"><A HREF="#25">getUser (String): User</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">67%  (8/12)</TD><TD CLASS="h">75%  (3/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">setMultiThreaded (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">67%  (16/24)</TD><TD CLASS="h">71%  (5/7)</TD></TR><TR><TD CLASS="f"><A HREF="#27">closeAllSessionsException (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">71%  (35/49)</TD><TD>80%  (8/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">deleteOldTempFiles (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">72%  (21/29)</TD><TD CLASS="h">77%  (3.9/5)</TD></TR><TR><TD CLASS="f"><A HREF="#29">renameDatabaseObject (Session, DbObject, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">73%  (56/77)</TD><TD>88%  (15/17)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">isFileLockSerialized (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">75%  (6/8)</TD><TD CLASS="h">75%  (0.8/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">removeDatabaseObject (Session, DbObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">75%  (43/57)</TD><TD>87%  (13/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">getDatabasePath (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">78%  (7/9)</TD><TD CLASS="h">67%  (2/3)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">getLogMode (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">78%  (7/9)</TD><TD CLASS="h">67%  (2/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">getMap (int): HashMap</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">78%  (36/46)</TD><TD>95%  (18/19)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">checkpoint (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>80%  (20/25)</TD><TD>91%  (6.4/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">getPageStore (): PageStore</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>83%  (44/53)</TD><TD CLASS="h">78%  (7/9)</TD></TR><TR><TD CLASS="f"><A HREF="#31">validateFilePasswordHash (String, byte []): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>83%  (10/12)</TD><TD CLASS="h">67%  (2/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">checkPowerOff (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>84%  (56/67)</TD><TD>80%  (20/25)</TD></TR><TR><TD CLASS="f"><A HREF="#33">open (int, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>84%  (515/616)</TD><TD>84%  (96.4/115)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">recompileInvalidViews (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>85%  (55/65)</TD><TD>82%  (14/17)</TD></TR><TR><TD CLASS="f"><A HREF="#35">openFile (String, String, boolean): FileStore</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>86%  (24/28)</TD><TD>89%  (8/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">close (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>86%  (235/274)</TD><TD CLASS="h">79%  (62.5/79)</TD></TR><TR><TD CLASS="f"><A HREF="#37">getSessions (boolean): Session []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>87%  (33/38)</TD><TD>97%  (8.7/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">addMeta (Session, DbObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>87%  (41/47)</TD><TD>92%  (11/12)</TD></TR><TR><TD CLASS="f"><A HREF="#39">getMaxLengthInplaceLob (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>88%  (7/8)</TD><TD>87%  (0.9/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">createSession (User): Session</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>88%  (46/52)</TD><TD CLASS="h">78%  (7/9)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">setPowerOffCount (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (8/9)</TD><TD CLASS="h">75%  (3/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3c">initMetaTables (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (42/47)</TD><TD>94%  (9.4/10)</TD></TR><TR><TD CLASS="f"><A HREF="#3d">removeMeta (Session, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>90%  (69/77)</TD><TD>90%  (18/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">prepareCommit (Session, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>90%  (9/10)</TD><TD CLASS="h">75%  (3/4)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">checkMetaFree (Session, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>91%  (21/23)</TD><TD>83%  (5/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#40">setProgress (int, String, int, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>92%  (12/13)</TD><TD>80%  (4/5)</TD></TR><TR><TD CLASS="f"><A HREF="#41">getAllSchemaObjects (int): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (25/27)</TD><TD>83%  (5/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#42">commit (Session): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (13/14)</TD><TD>83%  (5/6)</TD></TR><TR><TD CLASS="f"><A HREF="#43">updateWithChildren (Session, DbObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>94%  (34/36)</TD><TD>90%  (9/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">setWriteDelay (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (19/20)</TD><TD>98%  (4.9/5)</TD></TR><TR><TD CLASS="f"><A HREF="#45">addDatabaseObject (Session, DbObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (59/62)</TD><TD>93%  (14/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#46">removeSchemaObject (Session, SchemaObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (114/118)</TD><TD>97%  (32/33)</TD></TR><TR><TD CLASS="f"><A HREF="#47">getDependentTable (SchemaObject, Table): Table</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (36/37)</TD><TD>91%  (10/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">Database (ConnectionInfo, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>98%  (246/250)</TD><TD>98%  (61/62)</TD></TR><TR><TD CLASS="f"><A HREF="#49">addSchemaObject (Session, SchemaObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (23/23)</TD><TD>100% (7/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4a">allocateObjectId (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#4b">areEqual (Value, Value): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4c">compare (Value, Value): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#4d">compareTypeSave (Value, Value): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4e">equalsIdentifiers (String, String): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (21/21)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#4f">exists (String): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#50">findAggregate (String): UserAggregate</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#51">findComment (DbObject): Comment</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (15/15)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#52">findRole (String): Role</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#53">findSchema (String): Schema</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (14/14)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#54">findSetting (String): Setting</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#55">findUser (String): User</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#56">findUserDataType (String): UserDataType</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#57">flush (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#58">getAllAggregates (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#59">getAllComments (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5a">getAllRights (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5b">getAllRoles (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5c">getAllSchemaObjects (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (24/24)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#5d">getAllSchemas (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (7/7)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5e">getAllSettings (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5f">getAllTablesAndViews (boolean): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (26/26)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#60">getAllUserDataTypes (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#61">getAllUsers (): ArrayList</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#62">getAllowLiterals (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#63">getCacheType (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#64">getCluster (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#65">getCompareMode (): CompareMode</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#66">getCompiler (): SourceCompiler</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#67">getDefaultTableType (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#68">getExclusiveSession (): Session</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#69">getFirstUserTable (): Table</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (24/24)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6a">getFlushOnEachCommit (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#6b">getIgnoreCase (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6c">getLinkConnection (String, String, String, String): TableLinkConnection</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#6d">getLobCompressionAlgorithm (int): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6e">getLobConnection (): Connection</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#6f">getLobStorage (): LobStorage</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#70">getLobSyncObject (): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#71">getLockMode (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#72">getMaxMemoryRows (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#73">getMaxMemoryUndo (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#74">getMaxOperationMemory (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#75">getMode (): Mode</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#76">getModificationDataId (): long</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#77">getModificationMetaId (): long</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#78">getName (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#79">getNextModificationDataId (): long</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7a">getNextModificationMetaId (): long</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (14/14)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#7b">getOptimizeReuseResults (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7c">getPublicRole (): Role</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#7d">getReferentialIntegrity (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7e">getSessionCount (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#7f">getSettings (): DbSettings</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#80">getShortName (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#81">getSystemSession (): Session</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#82">getTempFileDeleter (): TempFileDeleter</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#83">getTempTableName (String, Session): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (30/30)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#84">getTrace (String): Trace</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#85">isClosing (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#86">isMultiThreaded (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#87">isMultiVersion (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#88">isPersistent (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#89">isReadOnly (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8a">isStarting (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#8b">isSysTableLocked (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8c">lockMeta (Session): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (18/18)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#8d">newStringMap (): HashMap</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8e">opened (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (13/13)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#8f">parseDatabaseShortName (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (40/40)</TD><TD>100% (10/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#90">renameSchemaObject (Session, SchemaObject, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#91">setCloseDelay (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#92">setCluster (String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#93">setCompactMode (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#94">setCompareMode (CompareMode): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#95">setDeleteFilesOnDisconnect (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#96">setExclusiveSession (Session, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#97">setIgnoreCase (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#98">setLobCompressionAlgorithm (String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#99">setMasterUser (User): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (15/15)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9a">setMaxLengthInplaceLob (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#9b">setMaxMemoryRows (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9c">setMaxMemoryUndo (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#9d">setMaxOperationMemory (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9e">setMode (Mode): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#9f">setMultiVersion (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a0">setReferentialIntegrity (boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#a1">stopWriter (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a2">update (Session, DbObject): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (16/16)</TD><TD>100% (5/5)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Copyright 2004-2011 H2 Group. Multiple-Licensed under the H2 License,</TD></TR><TR><TD CLASS="l">3</TD><TD> * Version 1.0, and under the Eclipse Public License, Version 1.0</TD></TR><TR><TD CLASS="l">4</TD><TD> * (http://h2database.com/html/license.html).</TD></TR><TR><TD CLASS="l">5</TD><TD> * Initial Developer: H2 Group</TD></TR><TR><TD CLASS="l">6</TD><TD> */</TD></TR><TR><TD CLASS="l">7</TD><TD>package org.h2.engine;</TD></TR><TR><TD CLASS="l">8</TD><TD> </TD></TR><TR><TD CLASS="l">9</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">10</TD><TD>import java.sql.Connection;</TD></TR><TR><TD CLASS="l">11</TD><TD>import java.sql.SQLException;</TD></TR><TR><TD CLASS="l">12</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">13</TD><TD>import java.util.Collections;</TD></TR><TR><TD CLASS="l">14</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">15</TD><TD>import java.util.HashSet;</TD></TR><TR><TD CLASS="l">16</TD><TD>import java.util.Properties;</TD></TR><TR><TD CLASS="l">17</TD><TD>import java.util.Set;</TD></TR><TR><TD CLASS="l">18</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">19</TD><TD>import org.h2.api.DatabaseEventListener;</TD></TR><TR><TD CLASS="l">20</TD><TD>import org.h2.command.ddl.CreateTableData;</TD></TR><TR><TD CLASS="l">21</TD><TD>import org.h2.command.dml.SetTypes;</TD></TR><TR><TD CLASS="l">22</TD><TD>import org.h2.constant.DbSettings;</TD></TR><TR><TD CLASS="l">23</TD><TD>import org.h2.constant.ErrorCode;</TD></TR><TR><TD CLASS="l">24</TD><TD>import org.h2.constant.SysProperties;</TD></TR><TR><TD CLASS="l">25</TD><TD>import org.h2.constraint.Constraint;</TD></TR><TR><TD CLASS="l">26</TD><TD>import org.h2.index.Cursor;</TD></TR><TR><TD CLASS="l">27</TD><TD>import org.h2.index.Index;</TD></TR><TR><TD CLASS="l">28</TD><TD>import org.h2.index.IndexType;</TD></TR><TR><TD CLASS="l">29</TD><TD>import org.h2.jdbc.JdbcConnection;</TD></TR><TR><TD CLASS="l">30</TD><TD>import org.h2.message.DbException;</TD></TR><TR><TD CLASS="l">31</TD><TD>import org.h2.message.Trace;</TD></TR><TR><TD CLASS="l">32</TD><TD>import org.h2.message.TraceSystem;</TD></TR><TR><TD CLASS="l">33</TD><TD>import org.h2.result.Row;</TD></TR><TR><TD CLASS="l">34</TD><TD>import org.h2.result.SearchRow;</TD></TR><TR><TD CLASS="l">35</TD><TD>import org.h2.schema.Schema;</TD></TR><TR><TD CLASS="l">36</TD><TD>import org.h2.schema.SchemaObject;</TD></TR><TR><TD CLASS="l">37</TD><TD>import org.h2.schema.Sequence;</TD></TR><TR><TD CLASS="l">38</TD><TD>import org.h2.schema.TriggerObject;</TD></TR><TR><TD CLASS="l">39</TD><TD>import org.h2.store.DataHandler;</TD></TR><TR><TD CLASS="l">40</TD><TD>import org.h2.store.FileLock;</TD></TR><TR><TD CLASS="l">41</TD><TD>import org.h2.store.FileStore;</TD></TR><TR><TD CLASS="l">42</TD><TD>import org.h2.store.InDoubtTransaction;</TD></TR><TR><TD CLASS="l">43</TD><TD>import org.h2.store.LobStorage;</TD></TR><TR><TD CLASS="l">44</TD><TD>import org.h2.store.PageStore;</TD></TR><TR><TD CLASS="l">45</TD><TD>import org.h2.store.WriterThread;</TD></TR><TR><TD CLASS="l">46</TD><TD>import org.h2.store.fs.FileUtils;</TD></TR><TR><TD CLASS="l">47</TD><TD>import org.h2.table.Column;</TD></TR><TR><TD CLASS="l">48</TD><TD>import org.h2.table.IndexColumn;</TD></TR><TR><TD CLASS="l">49</TD><TD>import org.h2.table.MetaTable;</TD></TR><TR><TD CLASS="l">50</TD><TD>import org.h2.table.Table;</TD></TR><TR><TD CLASS="l">51</TD><TD>import org.h2.table.TableLinkConnection;</TD></TR><TR><TD CLASS="l">52</TD><TD>import org.h2.table.TableView;</TD></TR><TR><TD CLASS="l">53</TD><TD>import org.h2.tools.DeleteDbFiles;</TD></TR><TR><TD CLASS="l">54</TD><TD>import org.h2.tools.Server;</TD></TR><TR><TD CLASS="l">55</TD><TD>import org.h2.util.BitField;</TD></TR><TR><TD CLASS="l">56</TD><TD>import org.h2.util.MathUtils;</TD></TR><TR><TD CLASS="l">57</TD><TD>import org.h2.util.NetUtils;</TD></TR><TR><TD CLASS="l">58</TD><TD>import org.h2.util.New;</TD></TR><TR><TD CLASS="l">59</TD><TD>import org.h2.util.SmallLRUCache;</TD></TR><TR><TD CLASS="l">60</TD><TD>import org.h2.util.SourceCompiler;</TD></TR><TR><TD CLASS="l">61</TD><TD>import org.h2.util.StringUtils;</TD></TR><TR><TD CLASS="l">62</TD><TD>import org.h2.util.TempFileDeleter;</TD></TR><TR><TD CLASS="l">63</TD><TD>import org.h2.util.Utils;</TD></TR><TR><TD CLASS="l">64</TD><TD>import org.h2.value.CaseInsensitiveMap;</TD></TR><TR><TD CLASS="l">65</TD><TD>import org.h2.value.CompareMode;</TD></TR><TR><TD CLASS="l">66</TD><TD>import org.h2.value.Value;</TD></TR><TR><TD CLASS="l">67</TD><TD>import org.h2.value.ValueInt;</TD></TR><TR><TD CLASS="l">68</TD><TD> </TD></TR><TR><TD CLASS="l">69</TD><TD>/**</TD></TR><TR><TD CLASS="l">70</TD><TD> * There is one database object per open database.</TD></TR><TR><TD CLASS="l">71</TD><TD> *</TD></TR><TR><TD CLASS="l">72</TD><TD> * The format of the meta data table is:</TD></TR><TR><TD CLASS="l">73</TD><TD> *  id int, 0, objectType int, sql varchar</TD></TR><TR><TD CLASS="l">74</TD><TD> *</TD></TR><TR><TD CLASS="l">75</TD><TD> * @since 2004-04-15 22:49</TD></TR><TR><TD CLASS="l">76</TD><TD> */</TD></TR><TR><TD CLASS="l">77</TD><TD>public class Database implements DataHandler {</TD></TR><TR><TD CLASS="l">78</TD><TD> </TD></TR><TR><TD CLASS="l">79</TD><TD>    private static int initialPowerOffCount;</TD></TR><TR><TD CLASS="l">80</TD><TD> </TD></TR><TR><TD CLASS="l">81</TD><TD>    /**</TD></TR><TR><TD CLASS="l">82</TD><TD>     * The default name of the system user. This name is only used as long as</TD></TR><TR><TD CLASS="l">83</TD><TD>     * there is no administrator user registered.</TD></TR><TR><TD CLASS="l">84</TD><TD>     */</TD></TR><TR><TD CLASS="l">85</TD><TD>    private static final String SYSTEM_USER_NAME = &#34;DBA&#34;;</TD></TR><TR><TD CLASS="l">86</TD><TD> </TD></TR><TR><TD CLASS="l">87</TD><TD>    private final boolean persistent;</TD></TR><TR><TD CLASS="l">88</TD><TD>    private final String databaseName;</TD></TR><TR><TD CLASS="l">89</TD><TD>    private final String databaseShortName;</TD></TR><TR><TD CLASS="l">90</TD><TD>    private final String databaseURL;</TD></TR><TR><TD CLASS="l">91</TD><TD>    private final String cipher;</TD></TR><TR><TD CLASS="l">92</TD><TD>    private final byte[] filePasswordHash;</TD></TR><TR><TD CLASS="l">93</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">94</TD><TD>    private final HashMap&lt;String, Role&gt; roles = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">95</TD><TD>    private final HashMap&lt;String, User&gt; users = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">96</TD><TD>    private final HashMap&lt;String, Setting&gt; settings = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">97</TD><TD>    private final HashMap&lt;String, Schema&gt; schemas = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">98</TD><TD>    private final HashMap&lt;String, Right&gt; rights = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">99</TD><TD>    private final HashMap&lt;String, UserDataType&gt; userDataTypes = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">100</TD><TD>    private final HashMap&lt;String, UserAggregate&gt; aggregates = New.hashMap();</TD></TR><TR CLASS="c"><TD CLASS="l">101</TD><TD>    private final HashMap&lt;String, Comment&gt; comments = New.hashMap();</TD></TR><TR><TD CLASS="l">102</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">103</TD><TD>    private final Set&lt;Session&gt; userSessions = Collections.synchronizedSet(new HashSet&lt;Session&gt;());</TD></TR><TR><TD CLASS="l">104</TD><TD>    private Session exclusiveSession;</TD></TR><TR CLASS="c"><TD CLASS="l">105</TD><TD>    private final BitField objectIds = new BitField();</TD></TR><TR CLASS="c"><TD CLASS="l">106</TD><TD>    private final Object lobSyncObject = new Object();</TD></TR><TR><TD CLASS="l">107</TD><TD> </TD></TR><TR><TD CLASS="l">108</TD><TD>    private Schema mainSchema;</TD></TR><TR><TD CLASS="l">109</TD><TD>    private Schema infoSchema;</TD></TR><TR><TD CLASS="l">110</TD><TD>    private int nextSessionId;</TD></TR><TR><TD CLASS="l">111</TD><TD>    private int nextTempTableId;</TD></TR><TR><TD CLASS="l">112</TD><TD>    private User systemUser;</TD></TR><TR><TD CLASS="l">113</TD><TD>    private Session systemSession;</TD></TR><TR><TD CLASS="l">114</TD><TD>    private Table meta;</TD></TR><TR><TD CLASS="l">115</TD><TD>    private Index metaIdIndex;</TD></TR><TR><TD CLASS="l">116</TD><TD>    private FileLock lock;</TD></TR><TR><TD CLASS="l">117</TD><TD>    private WriterThread writer;</TD></TR><TR><TD CLASS="l">118</TD><TD>    private boolean starting;</TD></TR><TR><TD CLASS="l">119</TD><TD>    private TraceSystem traceSystem;</TD></TR><TR><TD CLASS="l">120</TD><TD>    private Trace trace;</TD></TR><TR><TD CLASS="l">121</TD><TD>    private int fileLockMethod;</TD></TR><TR><TD CLASS="l">122</TD><TD>    private Role publicRole;</TD></TR><TR><TD CLASS="l">123</TD><TD>    private long modificationDataId;</TD></TR><TR><TD CLASS="l">124</TD><TD>    private long modificationMetaId;</TD></TR><TR><TD CLASS="l">125</TD><TD>    private CompareMode compareMode;</TD></TR><TR CLASS="c"><TD CLASS="l">126</TD><TD>    private String cluster = Constants.CLUSTERING_DISABLED;</TD></TR><TR><TD CLASS="l">127</TD><TD>    private boolean readOnly;</TD></TR><TR><TD CLASS="l">128</TD><TD>    private boolean noDiskSpace;</TD></TR><TR CLASS="c"><TD CLASS="l">129</TD><TD>    private int writeDelay = Constants.DEFAULT_WRITE_DELAY;</TD></TR><TR><TD CLASS="l">130</TD><TD>    private DatabaseEventListener eventListener;</TD></TR><TR CLASS="c"><TD CLASS="l">131</TD><TD>    private int maxMemoryRows = Constants.DEFAULT_MAX_MEMORY_ROWS;</TD></TR><TR CLASS="c"><TD CLASS="l">132</TD><TD>    private int maxMemoryUndo = Constants.DEFAULT_MAX_MEMORY_UNDO;</TD></TR><TR CLASS="c"><TD CLASS="l">133</TD><TD>    private int lockMode = Constants.DEFAULT_LOCK_MODE;</TD></TR><TR><TD CLASS="l">134</TD><TD>    private int maxLengthInplaceLob;</TD></TR><TR CLASS="c"><TD CLASS="l">135</TD><TD>    private int allowLiterals = Constants.ALLOW_LITERALS_ALL;</TD></TR><TR><TD CLASS="l">136</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">137</TD><TD>    private int powerOffCount = initialPowerOffCount;</TD></TR><TR><TD CLASS="l">138</TD><TD>    private int closeDelay;</TD></TR><TR><TD CLASS="l">139</TD><TD>    private DatabaseCloser delayedCloser;</TD></TR><TR><TD CLASS="l">140</TD><TD>    private volatile boolean closing;</TD></TR><TR><TD CLASS="l">141</TD><TD>    private boolean ignoreCase;</TD></TR><TR><TD CLASS="l">142</TD><TD>    private boolean deleteFilesOnDisconnect;</TD></TR><TR><TD CLASS="l">143</TD><TD>    private String lobCompressionAlgorithm;</TD></TR><TR CLASS="c"><TD CLASS="l">144</TD><TD>    private boolean optimizeReuseResults = true;</TD></TR><TR><TD CLASS="l">145</TD><TD>    private String cacheType;</TD></TR><TR><TD CLASS="l">146</TD><TD>    private String accessModeData;</TD></TR><TR CLASS="c"><TD CLASS="l">147</TD><TD>    private boolean referentialIntegrity = true;</TD></TR><TR><TD CLASS="l">148</TD><TD>    private boolean multiVersion;</TD></TR><TR><TD CLASS="l">149</TD><TD>    private DatabaseCloser closeOnExit;</TD></TR><TR CLASS="c"><TD CLASS="l">150</TD><TD>    private Mode mode = Mode.getInstance(Mode.REGULAR);</TD></TR><TR><TD CLASS="l">151</TD><TD>    private boolean multiThreaded;</TD></TR><TR CLASS="c"><TD CLASS="l">152</TD><TD>    private int maxOperationMemory = Constants.DEFAULT_MAX_OPERATION_MEMORY;</TD></TR><TR><TD CLASS="l">153</TD><TD>    private SmallLRUCache&lt;String, String[]&gt; lobFileListCache;</TD></TR><TR><TD CLASS="l">154</TD><TD>    private boolean autoServerMode;</TD></TR><TR><TD CLASS="l">155</TD><TD>    private int autoServerPort;</TD></TR><TR><TD CLASS="l">156</TD><TD>    private Server server;</TD></TR><TR><TD CLASS="l">157</TD><TD>    private HashMap&lt;TableLinkConnection, TableLinkConnection&gt; linkConnections;</TD></TR><TR CLASS="c"><TD CLASS="l">158</TD><TD>    private TempFileDeleter tempFileDeleter = TempFileDeleter.getInstance();</TD></TR><TR><TD CLASS="l">159</TD><TD>    private PageStore pageStore;</TD></TR><TR><TD CLASS="l">160</TD><TD>    private Properties reconnectLastLock;</TD></TR><TR><TD CLASS="l">161</TD><TD>    private volatile long reconnectCheckNext;</TD></TR><TR><TD CLASS="l">162</TD><TD>    private volatile boolean reconnectChangePending;</TD></TR><TR><TD CLASS="l">163</TD><TD>    private volatile int checkpointAllowed;</TD></TR><TR><TD CLASS="l">164</TD><TD>    private volatile boolean checkpointRunning;</TD></TR><TR CLASS="c"><TD CLASS="l">165</TD><TD>    private final Object reconnectSync = new Object();</TD></TR><TR><TD CLASS="l">166</TD><TD>    private int cacheSize;</TD></TR><TR><TD CLASS="l">167</TD><TD>    private int compactMode;</TD></TR><TR><TD CLASS="l">168</TD><TD>    private SourceCompiler compiler;</TD></TR><TR><TD CLASS="l">169</TD><TD>    private volatile boolean metaTablesInitialized;</TD></TR><TR><TD CLASS="l">170</TD><TD>    private boolean flushOnEachCommit;</TD></TR><TR><TD CLASS="l">171</TD><TD>    private LobStorage lobStorage;</TD></TR><TR CLASS="c"><TD CLASS="l">172</TD><TD>    private int pageSize = Constants.DEFAULT_PAGE_SIZE;</TD></TR><TR CLASS="c"><TD CLASS="l">173</TD><TD>    private int defaultTableType = Table.TYPE_CACHED;</TD></TR><TR><TD CLASS="l"><A NAME="0">174</A></TD><TD>    private final DbSettings dbSettings;</TD></TR><TR><TD CLASS="l">175</TD><TD>    private final int reconnectCheckDelay;</TD></TR><TR><TD CLASS="l">176</TD><TD>    private int logMode;</TD></TR><TR><TD CLASS="l">177</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">178</TD><TD>    public Database(ConnectionInfo ci, String cipher) {</TD></TR><TR CLASS="c"><TD CLASS="l">179</TD><TD>        String name = ci.getName();</TD></TR><TR CLASS="c"><TD CLASS="l">180</TD><TD>        this.dbSettings = ci.getDbSettings();</TD></TR><TR CLASS="c"><TD CLASS="l">181</TD><TD>        this.reconnectCheckDelay = dbSettings.reconnectCheckDelay;</TD></TR><TR CLASS="c"><TD CLASS="l">182</TD><TD>        this.compareMode = CompareMode.getInstance(null, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">183</TD><TD>        this.persistent = ci.isPersistent();</TD></TR><TR CLASS="c"><TD CLASS="l">184</TD><TD>        this.filePasswordHash = ci.getFilePasswordHash();</TD></TR><TR CLASS="c"><TD CLASS="l">185</TD><TD>        this.databaseName = name;</TD></TR><TR CLASS="c"><TD CLASS="l">186</TD><TD>        this.databaseShortName = parseDatabaseShortName();</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="99% line coverage (172 out of 173 instructions)">187</TD><TD TITLE="99% line coverage (172 out of 173 instructions)">        this.maxLengthInplaceLob = SysProperties.LOB_IN_DATABASE ?</TD></TR><TR><TD CLASS="l">188</TD><TD>                Constants.DEFAULT_MAX_LENGTH_INPLACE_LOB2 : Constants.DEFAULT_MAX_LENGTH_INPLACE_LOB;</TD></TR><TR CLASS="c"><TD CLASS="l">189</TD><TD>        this.cipher = cipher;</TD></TR><TR CLASS="c"><TD CLASS="l">190</TD><TD>        String lockMethodName = ci.getProperty(&#34;FILE_LOCK&#34;, null);</TD></TR><TR CLASS="c"><TD CLASS="l">191</TD><TD>        this.accessModeData = StringUtils.toLowerEnglish(ci.getProperty(&#34;ACCESS_MODE_DATA&#34;, &#34;rw&#34;));</TD></TR><TR CLASS="c"><TD CLASS="l">192</TD><TD>        this.autoServerMode = ci.getProperty(&#34;AUTO_SERVER&#34;, false);</TD></TR><TR CLASS="c"><TD CLASS="l">193</TD><TD>        this.autoServerPort = ci.getProperty(&#34;AUTO_SERVER_PORT&#34;, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">194</TD><TD>        this.cacheSize = ci.getProperty(&#34;CACHE_SIZE&#34;, Constants.CACHE_SIZE_DEFAULT);</TD></TR><TR CLASS="c"><TD CLASS="l">195</TD><TD>        this.pageSize = ci.getProperty(&#34;PAGE_SIZE&#34;, Constants.DEFAULT_PAGE_SIZE);</TD></TR><TR CLASS="c"><TD CLASS="l">196</TD><TD>        if (&#34;r&#34;.equals(accessModeData)) {</TD></TR><TR CLASS="z"><TD CLASS="l">197</TD><TD>            readOnly = true;</TD></TR><TR><TD CLASS="l">198</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">199</TD><TD>        this.fileLockMethod = FileLock.getFileLockMethod(lockMethodName);</TD></TR><TR CLASS="c"><TD CLASS="l">200</TD><TD>        this.databaseURL = ci.getURL();</TD></TR><TR CLASS="c"><TD CLASS="l">201</TD><TD>        String listener = ci.removeProperty(&#34;DATABASE_EVENT_LISTENER&#34;, null);</TD></TR><TR CLASS="c"><TD CLASS="l">202</TD><TD>        if (listener != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">203</TD><TD>            listener = StringUtils.trim(listener, true, true, &#34;'&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">204</TD><TD>            setEventListenerClass(listener);</TD></TR><TR><TD CLASS="l">205</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">206</TD><TD>        String modeName = ci.removeProperty(&#34;MODE&#34;, null);</TD></TR><TR CLASS="c"><TD CLASS="l">207</TD><TD>        if (modeName != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">208</TD><TD>            this.mode = Mode.getInstance(modeName);</TD></TR><TR><TD CLASS="l">209</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">210</TD><TD>        this.multiVersion = ci.getProperty(&#34;MVCC&#34;, false);</TD></TR><TR CLASS="c"><TD CLASS="l">211</TD><TD>        this.logMode = ci.getProperty(&#34;LOG&#34;, PageStore.LOG_MODE_SYNC);</TD></TR><TR CLASS="c"><TD CLASS="l">212</TD><TD>        boolean closeAtVmShutdown = dbSettings.dbCloseOnExit;</TD></TR><TR CLASS="c"><TD CLASS="l">213</TD><TD>        int traceLevelFile = ci.getIntProperty(SetTypes.TRACE_LEVEL_FILE, TraceSystem.DEFAULT_TRACE_LEVEL_FILE);</TD></TR><TR CLASS="c"><TD CLASS="l">214</TD><TD>        int traceLevelSystemOut = ci.getIntProperty(SetTypes.TRACE_LEVEL_SYSTEM_OUT,</TD></TR><TR><TD CLASS="l">215</TD><TD>                TraceSystem.DEFAULT_TRACE_LEVEL_SYSTEM_OUT);</TD></TR><TR CLASS="c"><TD CLASS="l">216</TD><TD>        this.cacheType = StringUtils.toUpperEnglish(ci.removeProperty(&#34;CACHE_TYPE&#34;, Constants.CACHE_TYPE_DEFAULT));</TD></TR><TR CLASS="c"><TD CLASS="l">217</TD><TD>        openDatabase(traceLevelFile, traceLevelSystemOut, closeAtVmShutdown);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="21">218</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">219</TD><TD> </TD></TR><TR><TD CLASS="l">220</TD><TD>    private void openDatabase(int traceLevelFile, int traceLevelSystemOut, boolean closeAtVmShutdown) {</TD></TR><TR><TD CLASS="l">221</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">222</TD><TD>            open(traceLevelFile, traceLevelSystemOut);</TD></TR><TR CLASS="c"><TD CLASS="l">223</TD><TD>            if (closeAtVmShutdown) {</TD></TR><TR><TD CLASS="l">224</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">225</TD><TD>                    closeOnExit = new DatabaseCloser(this, 0, true);</TD></TR><TR CLASS="c"><TD CLASS="l">226</TD><TD>                    Runtime.getRuntime().addShutdownHook(closeOnExit);</TD></TR><TR CLASS="c"><TD CLASS="l">227</TD><TD>                } catch (IllegalStateException e) {</TD></TR><TR><TD CLASS="l">228</TD><TD>                    // shutdown in progress - just don't register the handler</TD></TR><TR><TD CLASS="l">229</TD><TD>                    // (maybe an application wants to write something into a</TD></TR><TR><TD CLASS="l">230</TD><TD>                    // database at shutdown time)</TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>                } catch (SecurityException  e) {</TD></TR><TR><TD CLASS="l">232</TD><TD>                    // applets may not do that - ignore</TD></TR><TR><TD CLASS="l">233</TD><TD>                    // Google App Engine doesn't allow</TD></TR><TR><TD CLASS="l">234</TD><TD>                    // to instantiate classes that extend Thread</TD></TR><TR CLASS="c"><TD CLASS="l">235</TD><TD>                }</TD></TR><TR><TD CLASS="l">236</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">237</TD><TD>        } catch (Throwable e) {</TD></TR><TR CLASS="c"><TD CLASS="l">238</TD><TD>            if (e instanceof OutOfMemoryError) {</TD></TR><TR CLASS="z"><TD CLASS="l">239</TD><TD>                e.fillInStackTrace();</TD></TR><TR><TD CLASS="l">240</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">241</TD><TD>            if (traceSystem != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">242</TD><TD>                if (e instanceof SQLException) {</TD></TR><TR CLASS="z"><TD CLASS="l">243</TD><TD>                    SQLException e2 = (SQLException) e;</TD></TR><TR CLASS="z"><TD CLASS="l">244</TD><TD>                    if (e2.getErrorCode() != ErrorCode.DATABASE_ALREADY_OPEN_1) {</TD></TR><TR><TD CLASS="l">245</TD><TD>                        // only write if the database is not already in use</TD></TR><TR CLASS="z"><TD CLASS="l">246</TD><TD>                        trace.error(e, &#34;opening {0}&#34;, databaseName);</TD></TR><TR><TD CLASS="l">247</TD><TD>                    }</TD></TR><TR><TD CLASS="l">248</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">249</TD><TD>                traceSystem.close();</TD></TR><TR><TD CLASS="l">250</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">251</TD><TD>            closeOpenFilesAndUnlock(false);</TD></TR><TR CLASS="c"><TD CLASS="l">252</TD><TD>            throw DbException.convert(e);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="b">253</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">254</TD><TD>    }</TD></TR><TR><TD CLASS="l">255</TD><TD> </TD></TR><TR><TD CLASS="l">256</TD><TD>    public static void setInitialPowerOffCount(int count) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3b">257</A></TD><TD>        initialPowerOffCount = count;</TD></TR><TR CLASS="z"><TD CLASS="l">258</TD><TD>    }</TD></TR><TR><TD CLASS="l">259</TD><TD> </TD></TR><TR><TD CLASS="l">260</TD><TD>    public void setPowerOffCount(int count) {</TD></TR><TR CLASS="c"><TD CLASS="l">261</TD><TD>        if (powerOffCount == -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>            return;</TD></TR><TR><TD CLASS="l">263</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">264</TD><TD>        powerOffCount = count;</TD></TR><TR CLASS="c"><TD CLASS="l">265</TD><TD>    }</TD></TR><TR><TD CLASS="l">266</TD><TD> </TD></TR><TR><TD CLASS="l">267</TD><TD>    /**</TD></TR><TR><TD CLASS="l">268</TD><TD>     * Check if two values are equal with the current comparison mode.</TD></TR><TR><TD CLASS="l">269</TD><TD>     *</TD></TR><TR><TD CLASS="l">270</TD><TD>     * @param a the first value</TD></TR><TR><TD CLASS="l">271</TD><TD>     * @param b the second value</TD></TR><TR><TD CLASS="l"><A NAME="4b">272</A></TD><TD>     * @return true if both objects are equal</TD></TR><TR><TD CLASS="l">273</TD><TD>     */</TD></TR><TR><TD CLASS="l">274</TD><TD>    public boolean areEqual(Value a, Value b) {</TD></TR><TR><TD CLASS="l">275</TD><TD>        // can not use equals because ValueDecimal 0.0 is not equal to 0.00.</TD></TR><TR CLASS="c"><TD CLASS="l">276</TD><TD>        return a.compareTo(b, compareMode) == 0;</TD></TR><TR><TD CLASS="l">277</TD><TD>    }</TD></TR><TR><TD CLASS="l">278</TD><TD> </TD></TR><TR><TD CLASS="l">279</TD><TD>    /**</TD></TR><TR><TD CLASS="l">280</TD><TD>     * Compare two values with the current comparison mode. The values may not</TD></TR><TR><TD CLASS="l">281</TD><TD>     * be of the same type.</TD></TR><TR><TD CLASS="l">282</TD><TD>     *</TD></TR><TR><TD CLASS="l">283</TD><TD>     * @param a the first value</TD></TR><TR><TD CLASS="l">284</TD><TD>     * @param b the second value</TD></TR><TR><TD CLASS="l"><A NAME="4c">285</A></TD><TD>     * @return 0 if both values are equal, -1 if the first value is smaller, and</TD></TR><TR><TD CLASS="l">286</TD><TD>     *         1 otherwise</TD></TR><TR><TD CLASS="l">287</TD><TD>     */</TD></TR><TR><TD CLASS="l">288</TD><TD>    public int compare(Value a, Value b) {</TD></TR><TR CLASS="c"><TD CLASS="l">289</TD><TD>        return a.compareTo(b, compareMode);</TD></TR><TR><TD CLASS="l">290</TD><TD>    }</TD></TR><TR><TD CLASS="l">291</TD><TD> </TD></TR><TR><TD CLASS="l">292</TD><TD>    /**</TD></TR><TR><TD CLASS="l">293</TD><TD>     * Compare two values with the current comparison mode. The values must be</TD></TR><TR><TD CLASS="l">294</TD><TD>     * of the same type.</TD></TR><TR><TD CLASS="l">295</TD><TD>     *</TD></TR><TR><TD CLASS="l">296</TD><TD>     * @param a the first value</TD></TR><TR><TD CLASS="l">297</TD><TD>     * @param b the second value</TD></TR><TR><TD CLASS="l"><A NAME="4d">298</A></TD><TD>     * @return 0 if both values are equal, -1 if the first value is smaller, and</TD></TR><TR><TD CLASS="l">299</TD><TD>     *         1 otherwise</TD></TR><TR><TD CLASS="l">300</TD><TD>     */</TD></TR><TR><TD CLASS="l">301</TD><TD>    public int compareTypeSave(Value a, Value b) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="76">302</A></TD><TD>        return a.compareTypeSave(b, compareMode);</TD></TR><TR><TD CLASS="l">303</TD><TD>    }</TD></TR><TR><TD CLASS="l">304</TD><TD> </TD></TR><TR><TD CLASS="l">305</TD><TD>    public long getModificationDataId() {</TD></TR><TR CLASS="c"><TD CLASS="l">306</TD><TD>        return modificationDataId;</TD></TR><TR><TD CLASS="l">307</TD><TD>    }</TD></TR><TR><TD CLASS="l">308</TD><TD> </TD></TR><TR><TD CLASS="l">309</TD><TD>    /**</TD></TR><TR><TD CLASS="l">310</TD><TD>     * Set or reset the pending change flag in the .lock.db file.</TD></TR><TR><TD CLASS="l">311</TD><TD>     *</TD></TR><TR><TD CLASS="l">312</TD><TD>     * @param pending the new value of the flag</TD></TR><TR><TD CLASS="l"><A NAME="14">313</A></TD><TD>     * @return true if the call was successful,</TD></TR><TR><TD CLASS="l">314</TD><TD>     *          false if another connection was faster</TD></TR><TR><TD CLASS="l">315</TD><TD>     */</TD></TR><TR><TD CLASS="l">316</TD><TD>    private synchronized boolean reconnectModified(boolean pending) {</TD></TR><TR CLASS="c"><TD CLASS="l">317</TD><TD>        if (readOnly || lock == null || fileLockMethod != FileLock.LOCK_SERIALIZED) {</TD></TR><TR CLASS="c"><TD CLASS="l">318</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">319</TD><TD>        }</TD></TR><TR><TD CLASS="l">320</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>            if (pending == reconnectChangePending) {</TD></TR><TR CLASS="z"><TD CLASS="l">322</TD><TD>                long now = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>                if (now &gt; reconnectCheckNext) {</TD></TR><TR CLASS="z"><TD CLASS="l">324</TD><TD>                    if (pending) {</TD></TR><TR CLASS="z"><TD CLASS="l">325</TD><TD>                        String pos = pageStore == null ? null : &#34;&#34; + pageStore.getWriteCountTotal();</TD></TR><TR CLASS="z"><TD CLASS="l">326</TD><TD>                        lock.setProperty(&#34;logPos&#34;, pos);</TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>                        lock.save();</TD></TR><TR><TD CLASS="l">328</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>                    reconnectCheckNext = now + reconnectCheckDelay;</TD></TR><TR><TD CLASS="l">330</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">332</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">333</TD><TD>            Properties old = lock.load();</TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>            if (pending) {</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>                if (old.getProperty(&#34;changePending&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>                    return false;</TD></TR><TR><TD CLASS="l">337</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">338</TD><TD>                trace.debug(&#34;wait before writing&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>                Thread.sleep((int) (reconnectCheckDelay * 1.1));</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>                Properties now = lock.load();</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>                if (!now.equals(old)) {</TD></TR><TR><TD CLASS="l">342</TD><TD>                    // somebody else was faster</TD></TR><TR CLASS="z"><TD CLASS="l">343</TD><TD>                    return false;</TD></TR><TR><TD CLASS="l">344</TD><TD>                }</TD></TR><TR><TD CLASS="l">345</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">346</TD><TD>            String pos = pageStore == null ? null : &#34;&#34; + pageStore.getWriteCountTotal();</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>            lock.setProperty(&#34;logPos&#34;, pos);</TD></TR><TR CLASS="z"><TD CLASS="l">348</TD><TD>            if (pending) {</TD></TR><TR CLASS="z"><TD CLASS="l">349</TD><TD>                lock.setProperty(&#34;changePending&#34;, &#34;true-&#34; + Math.random());</TD></TR><TR><TD CLASS="l">350</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">351</TD><TD>                lock.setProperty(&#34;changePending&#34;, null);</TD></TR><TR><TD CLASS="l">352</TD><TD>            }</TD></TR><TR><TD CLASS="l">353</TD><TD>            // ensure that the writer thread will</TD></TR><TR><TD CLASS="l">354</TD><TD>            // not reset the flag before we are done</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>            reconnectCheckNext = System.currentTimeMillis() + 2 * reconnectCheckDelay;</TD></TR><TR CLASS="z"><TD CLASS="l">356</TD><TD>            old = lock.save();</TD></TR><TR CLASS="z"><TD CLASS="l">357</TD><TD>            if (pending) {</TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>                trace.debug(&#34;wait before writing again&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>                Thread.sleep((int) (reconnectCheckDelay * 1.1));</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>                Properties now = lock.load();</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>                if (!now.equals(old)) {</TD></TR><TR><TD CLASS="l">362</TD><TD>                    // somebody else was faster</TD></TR><TR CLASS="z"><TD CLASS="l">363</TD><TD>                    return false;</TD></TR><TR><TD CLASS="l">364</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">365</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>                Thread.sleep(1);</TD></TR><TR><TD CLASS="l">367</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>            reconnectLastLock = old;</TD></TR><TR CLASS="z"><TD CLASS="l">369</TD><TD>            reconnectChangePending = pending;</TD></TR><TR CLASS="z"><TD CLASS="l">370</TD><TD>            reconnectCheckNext = System.currentTimeMillis() + reconnectCheckDelay;</TD></TR><TR CLASS="z"><TD CLASS="l">371</TD><TD>            return true;</TD></TR><TR CLASS="z"><TD CLASS="l">372</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">373</TD><TD>            trace.error(e, &#34;pending {0}&#34;, pending);</TD></TR><TR CLASS="z"><TD CLASS="l">374</TD><TD>            return false;</TD></TR><TR><TD CLASS="l"><A NAME="79">375</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">376</TD><TD>    }</TD></TR><TR><TD CLASS="l">377</TD><TD> </TD></TR><TR><TD CLASS="l">378</TD><TD>    public long getNextModificationDataId() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="77">379</A></TD><TD>        return ++modificationDataId;</TD></TR><TR><TD CLASS="l">380</TD><TD>    }</TD></TR><TR><TD CLASS="l">381</TD><TD> </TD></TR><TR><TD CLASS="l">382</TD><TD>    public long getModificationMetaId() {</TD></TR><TR CLASS="c"><TD CLASS="l">383</TD><TD>        return modificationMetaId;</TD></TR><TR><TD CLASS="l">384</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="7a">385</A></TD><TD> </TD></TR><TR><TD CLASS="l">386</TD><TD>    public long getNextModificationMetaId() {</TD></TR><TR><TD CLASS="l">387</TD><TD>        // if the meta data has been modified, the data is modified as well</TD></TR><TR><TD CLASS="l">388</TD><TD>        // (because MetaTable returns modificationDataId)</TD></TR><TR CLASS="c"><TD CLASS="l">389</TD><TD>        modificationDataId++;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5">390</A></TD><TD>        return modificationMetaId++;</TD></TR><TR><TD CLASS="l">391</TD><TD>    }</TD></TR><TR><TD CLASS="l">392</TD><TD> </TD></TR><TR><TD CLASS="l">393</TD><TD>    public int getPowerOffCount() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="32">394</A></TD><TD>        return powerOffCount;</TD></TR><TR><TD CLASS="l">395</TD><TD>    }</TD></TR><TR><TD CLASS="l">396</TD><TD> </TD></TR><TR><TD CLASS="l">397</TD><TD>    public void checkPowerOff() {</TD></TR><TR CLASS="c"><TD CLASS="l">398</TD><TD>        if (powerOffCount == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">399</TD><TD>            return;</TD></TR><TR><TD CLASS="l">400</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">401</TD><TD>        if (powerOffCount &gt; 1) {</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>            powerOffCount--;</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>            return;</TD></TR><TR><TD CLASS="l">404</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">405</TD><TD>        if (powerOffCount != -1) {</TD></TR><TR><TD CLASS="l">406</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">407</TD><TD>                powerOffCount = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">408</TD><TD>                stopWriter();</TD></TR><TR CLASS="c"><TD CLASS="l">409</TD><TD>                if (pageStore != null) {</TD></TR><TR><TD CLASS="l">410</TD><TD>                    try {</TD></TR><TR CLASS="c"><TD CLASS="l">411</TD><TD>                        pageStore.close();</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>                    } catch (DbException e) {</TD></TR><TR><TD CLASS="l">413</TD><TD>                        // ignore</TD></TR><TR CLASS="c"><TD CLASS="l">414</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">415</TD><TD>                    pageStore = null;</TD></TR><TR><TD CLASS="l">416</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">417</TD><TD>                if (lock != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">418</TD><TD>                    stopServer();</TD></TR><TR CLASS="c"><TD CLASS="l">419</TD><TD>                    if (fileLockMethod != FileLock.LOCK_SERIALIZED) {</TD></TR><TR><TD CLASS="l">420</TD><TD>                        // allow testing shutdown</TD></TR><TR CLASS="c"><TD CLASS="l">421</TD><TD>                        lock.unlock();</TD></TR><TR><TD CLASS="l">422</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">423</TD><TD>                    lock = null;</TD></TR><TR><TD CLASS="l">424</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">425</TD><TD>                if (traceSystem != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">426</TD><TD>                    traceSystem.close();</TD></TR><TR><TD CLASS="l">427</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">428</TD><TD>            } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">429</TD><TD>                TraceSystem.traceThrowable(e);</TD></TR><TR CLASS="c"><TD CLASS="l">430</TD><TD>            }</TD></TR><TR><TD CLASS="l">431</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">432</TD><TD>        Engine.getInstance().close(databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">433</TD><TD>        throw DbException.get(ErrorCode.DATABASE_IS_CLOSED);</TD></TR><TR><TD CLASS="l">434</TD><TD>    }</TD></TR><TR><TD CLASS="l">435</TD><TD> </TD></TR><TR><TD CLASS="l">436</TD><TD>    /**</TD></TR><TR><TD CLASS="l">437</TD><TD>     * Check if a database with the given name exists.</TD></TR><TR><TD CLASS="l">438</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="4f">439</A></TD><TD>     * @param name the name of the database (including path)</TD></TR><TR><TD CLASS="l">440</TD><TD>     * @return true if one exists</TD></TR><TR><TD CLASS="l">441</TD><TD>     */</TD></TR><TR><TD CLASS="l">442</TD><TD>    static boolean exists(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">443</TD><TD>        return FileUtils.exists(name + Constants.SUFFIX_PAGE_FILE);</TD></TR><TR><TD CLASS="l">444</TD><TD>    }</TD></TR><TR><TD CLASS="l">445</TD><TD> </TD></TR><TR><TD CLASS="l">446</TD><TD>    /**</TD></TR><TR><TD CLASS="l">447</TD><TD>     * Get the trace object for the given module.</TD></TR><TR><TD CLASS="l">448</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="84">449</A></TD><TD>     * @param module the module name</TD></TR><TR><TD CLASS="l">450</TD><TD>     * @return the trace object</TD></TR><TR><TD CLASS="l">451</TD><TD>     */</TD></TR><TR><TD CLASS="l">452</TD><TD>    public Trace getTrace(String module) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="35">453</A></TD><TD>        return traceSystem.getTrace(module);</TD></TR><TR><TD CLASS="l">454</TD><TD>    }</TD></TR><TR><TD CLASS="l">455</TD><TD> </TD></TR><TR><TD CLASS="l">456</TD><TD>    public FileStore openFile(String name, String openMode, boolean mustExist) {</TD></TR><TR CLASS="c"><TD CLASS="l">457</TD><TD>        if (mustExist &amp;&amp; !FileUtils.exists(name)) {</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>            throw DbException.get(ErrorCode.FILE_NOT_FOUND_1, name);</TD></TR><TR><TD CLASS="l">459</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">460</TD><TD>        FileStore store = FileStore.open(this, name, openMode, cipher, filePasswordHash);</TD></TR><TR><TD CLASS="l">461</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">462</TD><TD>            store.init();</TD></TR><TR CLASS="c"><TD CLASS="l">463</TD><TD>        } catch (DbException e) {</TD></TR><TR CLASS="c"><TD CLASS="l">464</TD><TD>            store.closeSilently();</TD></TR><TR CLASS="c"><TD CLASS="l">465</TD><TD>            throw e;</TD></TR><TR CLASS="c"><TD CLASS="l">466</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">467</TD><TD>        return store;</TD></TR><TR><TD CLASS="l">468</TD><TD>    }</TD></TR><TR><TD CLASS="l">469</TD><TD> </TD></TR><TR><TD CLASS="l">470</TD><TD>    /**</TD></TR><TR><TD CLASS="l">471</TD><TD>     * Check if the file password hash is correct.</TD></TR><TR><TD CLASS="l">472</TD><TD>     *</TD></TR><TR><TD CLASS="l">473</TD><TD>     * @param testCipher the cipher algorithm</TD></TR><TR><TD CLASS="l"><A NAME="31">474</A></TD><TD>     * @param testHash the hash code</TD></TR><TR><TD CLASS="l">475</TD><TD>     * @return true if the cipher algorithm and the password match</TD></TR><TR><TD CLASS="l">476</TD><TD>     */</TD></TR><TR><TD CLASS="l">477</TD><TD>    boolean validateFilePasswordHash(String testCipher, byte[] testHash) {</TD></TR><TR CLASS="c"><TD CLASS="l">478</TD><TD>        if (!StringUtils.equals(testCipher, this.cipher)) {</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">480</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="8f">481</A></TD><TD>        return Utils.compareSecure(testHash, filePasswordHash);</TD></TR><TR><TD CLASS="l">482</TD><TD>    }</TD></TR><TR><TD CLASS="l">483</TD><TD> </TD></TR><TR><TD CLASS="l">484</TD><TD>    private String parseDatabaseShortName() {</TD></TR><TR CLASS="c"><TD CLASS="l">485</TD><TD>        String n = databaseName;</TD></TR><TR CLASS="c"><TD CLASS="l">486</TD><TD>        if (n.endsWith(&#34;:&#34;)) {</TD></TR><TR CLASS="c"><TD CLASS="l">487</TD><TD>            n = null;</TD></TR><TR><TD CLASS="l">488</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">489</TD><TD>        if (n != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">490</TD><TD>            StringTokenizer tokenizer = new StringTokenizer(n, &#34;/\\:,;&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">491</TD><TD>            while (tokenizer.hasMoreTokens()) {</TD></TR><TR CLASS="c"><TD CLASS="l">492</TD><TD>                n = tokenizer.nextToken();</TD></TR><TR><TD CLASS="l">493</TD><TD>            }</TD></TR><TR><TD CLASS="l">494</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">495</TD><TD>        if (n == null || n.length() == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">496</TD><TD>            n = &#34;unnamed&#34;;</TD></TR><TR><TD CLASS="l">497</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="33">498</A></TD><TD>        return dbSettings.databaseToUpper ? StringUtils.toUpperEnglish(n) : n;</TD></TR><TR><TD CLASS="l">499</TD><TD>    }</TD></TR><TR><TD CLASS="l">500</TD><TD> </TD></TR><TR><TD CLASS="l">501</TD><TD>    private synchronized void open(int traceLevelFile, int traceLevelSystemOut) {</TD></TR><TR CLASS="c"><TD CLASS="l">502</TD><TD>        if (persistent) {</TD></TR><TR CLASS="c"><TD CLASS="l">503</TD><TD>            String dataFileName = databaseName + &#34;.data.db&#34;;</TD></TR><TR CLASS="c"><TD CLASS="l">504</TD><TD>            boolean existsData = FileUtils.exists(dataFileName);</TD></TR><TR CLASS="c"><TD CLASS="l">505</TD><TD>            String pageFileName = databaseName + Constants.SUFFIX_PAGE_FILE;</TD></TR><TR CLASS="c"><TD CLASS="l">506</TD><TD>            boolean existsPage = FileUtils.exists(pageFileName);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="93% line coverage (28 out of 30 instructions)">507</TD><TD TITLE="93% line coverage (28 out of 30 instructions)">            if (existsData &amp;&amp; !existsPage) {</TD></TR><TR CLASS="z"><TD CLASS="l">508</TD><TD>                throw DbException.get(ErrorCode.FILE_VERSION_ERROR_1,</TD></TR><TR><TD CLASS="l">509</TD><TD>                        &#34;Old database: &#34; + dataFileName + &#34; - please convert the database to a SQL script and re-create it.&#34;);</TD></TR><TR><TD CLASS="l">510</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">511</TD><TD>            if (existsPage &amp;&amp; !FileUtils.canWrite(pageFileName)) {</TD></TR><TR CLASS="c"><TD CLASS="l">512</TD><TD>                readOnly = true;</TD></TR><TR><TD CLASS="l">513</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">514</TD><TD>            if (readOnly) {</TD></TR><TR CLASS="c"><TD CLASS="l">515</TD><TD>                traceSystem = new TraceSystem(null);</TD></TR><TR><TD CLASS="l">516</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">517</TD><TD>                traceSystem = new TraceSystem(databaseName + Constants.SUFFIX_TRACE_FILE);</TD></TR><TR><TD CLASS="l">518</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">519</TD><TD>            traceSystem.setLevelFile(traceLevelFile);</TD></TR><TR CLASS="c"><TD CLASS="l">520</TD><TD>            traceSystem.setLevelSystemOut(traceLevelSystemOut);</TD></TR><TR CLASS="c"><TD CLASS="l">521</TD><TD>            trace = traceSystem.getTrace(Trace.DATABASE);</TD></TR><TR CLASS="c"><TD CLASS="l">522</TD><TD>            trace.info(&#34;opening {0} (build {1})&#34;, databaseName, Constants.BUILD_ID);</TD></TR><TR CLASS="c"><TD CLASS="l">523</TD><TD>            if (autoServerMode) {</TD></TR><TR CLASS="z"><TD CLASS="l">524</TD><TD>                if (readOnly ||</TD></TR><TR><TD CLASS="l">525</TD><TD>                        fileLockMethod == FileLock.LOCK_NO ||</TD></TR><TR><TD CLASS="l">526</TD><TD>                        fileLockMethod == FileLock.LOCK_SERIALIZED ||</TD></TR><TR><TD CLASS="l">527</TD><TD>                        fileLockMethod == FileLock.LOCK_FS ||</TD></TR><TR><TD CLASS="l">528</TD><TD>                        !persistent) {</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>                    throw DbException.getUnsupportedException(&#34;autoServerMode &amp;&amp; (readOnly || fileLockMethod == NO&#34; +</TD></TR><TR><TD CLASS="l">530</TD><TD>                            &#34; || fileLockMethod == SERIALIZED || inMemory)&#34;);</TD></TR><TR><TD CLASS="l">531</TD><TD>                }</TD></TR><TR><TD CLASS="l">532</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">533</TD><TD>            String lockFileName = databaseName + Constants.SUFFIX_LOCK_FILE;</TD></TR><TR CLASS="c"><TD CLASS="l">534</TD><TD>            if (readOnly) {</TD></TR><TR CLASS="c"><TD CLASS="l">535</TD><TD>                if (FileUtils.exists(lockFileName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">536</TD><TD>                    throw DbException.get(ErrorCode.DATABASE_ALREADY_OPEN_1, &#34;Lock file exists: &#34; + lockFileName);</TD></TR><TR><TD CLASS="l">537</TD><TD>                }</TD></TR><TR><TD CLASS="l">538</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">539</TD><TD>            if (!readOnly &amp;&amp; fileLockMethod != FileLock.LOCK_NO) {</TD></TR><TR CLASS="c"><TD CLASS="l">540</TD><TD>                if (fileLockMethod != FileLock.LOCK_FS) {</TD></TR><TR CLASS="c"><TD CLASS="l">541</TD><TD>                    lock = new FileLock(traceSystem, lockFileName, Constants.LOCK_SLEEP);</TD></TR><TR CLASS="c"><TD CLASS="l">542</TD><TD>                    lock.lock(fileLockMethod);</TD></TR><TR CLASS="c"><TD CLASS="l">543</TD><TD>                    if (autoServerMode) {</TD></TR><TR CLASS="z"><TD CLASS="l">544</TD><TD>                        startServer(lock.getUniqueId());</TD></TR><TR><TD CLASS="l">545</TD><TD>                    }</TD></TR><TR><TD CLASS="l">546</TD><TD>                }</TD></TR><TR><TD CLASS="l">547</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">548</TD><TD>            if (SysProperties.MODIFY_ON_WRITE) {</TD></TR><TR CLASS="z"><TD CLASS="l">549</TD><TD>                while (isReconnectNeeded()) {</TD></TR><TR><TD CLASS="l">550</TD><TD>                    // wait until others stopped writing</TD></TR><TR><TD CLASS="l">551</TD><TD>                }</TD></TR><TR><TD CLASS="l">552</TD><TD>            } else {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="43% line coverage (3 out of 7 instructions)">553</TD><TD TITLE="43% line coverage (3 out of 7 instructions)">                while (isReconnectNeeded() &amp;&amp; !beforeWriting()) {</TD></TR><TR><TD CLASS="l">554</TD><TD>                    // wait until others stopped writing and</TD></TR><TR><TD CLASS="l">555</TD><TD>                    // until we can write (the file is not yet open -</TD></TR><TR><TD CLASS="l">556</TD><TD>                    // no need to re-connect)</TD></TR><TR><TD CLASS="l">557</TD><TD>                }</TD></TR><TR><TD CLASS="l">558</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">559</TD><TD>            deleteOldTempFiles();</TD></TR><TR CLASS="c"><TD CLASS="l">560</TD><TD>            starting = true;</TD></TR><TR CLASS="c"><TD CLASS="l">561</TD><TD>            if (SysProperties.MODIFY_ON_WRITE) {</TD></TR><TR><TD CLASS="l">562</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>                    getPageStore();</TD></TR><TR CLASS="z"><TD CLASS="l">564</TD><TD>                } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>                    if (e.getErrorCode() != ErrorCode.DATABASE_IS_READ_ONLY) {</TD></TR><TR CLASS="z"><TD CLASS="l">566</TD><TD>                        throw e;</TD></TR><TR><TD CLASS="l">567</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">568</TD><TD>                    pageStore = null;</TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>                    while (!beforeWriting()) {</TD></TR><TR><TD CLASS="l">570</TD><TD>                        // wait until others stopped writing and</TD></TR><TR><TD CLASS="l">571</TD><TD>                        // until we can write (the file is not yet open -</TD></TR><TR><TD CLASS="l">572</TD><TD>                        // no need to re-connect)</TD></TR><TR><TD CLASS="l">573</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">574</TD><TD>                    getPageStore();</TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>                }</TD></TR><TR><TD CLASS="l">576</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">577</TD><TD>                getPageStore();</TD></TR><TR><TD CLASS="l">578</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">579</TD><TD>            starting = false;</TD></TR><TR CLASS="c"><TD CLASS="l">580</TD><TD>            writer = WriterThread.create(this, writeDelay);</TD></TR><TR CLASS="c"><TD CLASS="l">581</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">582</TD><TD>            if (autoServerMode) {</TD></TR><TR CLASS="z"><TD CLASS="l">583</TD><TD>                throw DbException.getUnsupportedException(&#34;autoServerMode &amp;&amp; inMemory&#34;);</TD></TR><TR><TD CLASS="l">584</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">585</TD><TD>            traceSystem = new TraceSystem(null);</TD></TR><TR CLASS="c"><TD CLASS="l">586</TD><TD>            trace = traceSystem.getTrace(Trace.DATABASE);</TD></TR><TR><TD CLASS="l">587</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">588</TD><TD>        systemUser = new User(this, 0, SYSTEM_USER_NAME, true);</TD></TR><TR CLASS="c"><TD CLASS="l">589</TD><TD>        mainSchema = new Schema(this, 0, Constants.SCHEMA_MAIN, systemUser, true);</TD></TR><TR CLASS="c"><TD CLASS="l">590</TD><TD>        infoSchema = new Schema(this, -1, &#34;INFORMATION_SCHEMA&#34;, systemUser, true);</TD></TR><TR CLASS="c"><TD CLASS="l">591</TD><TD>        schemas.put(mainSchema.getName(), mainSchema);</TD></TR><TR CLASS="c"><TD CLASS="l">592</TD><TD>        schemas.put(infoSchema.getName(), infoSchema);</TD></TR><TR CLASS="c"><TD CLASS="l">593</TD><TD>        publicRole = new Role(this, 0, Constants.PUBLIC_ROLE_NAME, true);</TD></TR><TR CLASS="c"><TD CLASS="l">594</TD><TD>        roles.put(Constants.PUBLIC_ROLE_NAME, publicRole);</TD></TR><TR CLASS="c"><TD CLASS="l">595</TD><TD>        systemUser.setAdmin(true);</TD></TR><TR CLASS="c"><TD CLASS="l">596</TD><TD>        systemSession = new Session(this, systemUser, ++nextSessionId);</TD></TR><TR CLASS="c"><TD CLASS="l">597</TD><TD>        CreateTableData data = new CreateTableData();</TD></TR><TR CLASS="c"><TD CLASS="l">598</TD><TD>        ArrayList&lt;Column&gt; cols = data.columns;</TD></TR><TR CLASS="c"><TD CLASS="l">599</TD><TD>        Column columnId = new Column(&#34;ID&#34;, Value.INT);</TD></TR><TR CLASS="c"><TD CLASS="l">600</TD><TD>        columnId.setNullable(false);</TD></TR><TR CLASS="c"><TD CLASS="l">601</TD><TD>        cols.add(columnId);</TD></TR><TR CLASS="c"><TD CLASS="l">602</TD><TD>        cols.add(new Column(&#34;HEAD&#34;, Value.INT));</TD></TR><TR CLASS="c"><TD CLASS="l">603</TD><TD>        cols.add(new Column(&#34;TYPE&#34;, Value.INT));</TD></TR><TR CLASS="c"><TD CLASS="l">604</TD><TD>        cols.add(new Column(&#34;SQL&#34;, Value.STRING));</TD></TR><TR CLASS="c"><TD CLASS="l">605</TD><TD>        boolean create = true;</TD></TR><TR CLASS="c"><TD CLASS="l">606</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">607</TD><TD>            create = pageStore.isNew();</TD></TR><TR><TD CLASS="l">608</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">609</TD><TD>        data.tableName = &#34;SYS&#34;;</TD></TR><TR CLASS="c"><TD CLASS="l">610</TD><TD>        data.id = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">611</TD><TD>        data.temporary = false;</TD></TR><TR CLASS="c"><TD CLASS="l">612</TD><TD>        data.persistData = persistent;</TD></TR><TR CLASS="c"><TD CLASS="l">613</TD><TD>        data.persistIndexes = persistent;</TD></TR><TR CLASS="c"><TD CLASS="l">614</TD><TD>        data.create = create;</TD></TR><TR CLASS="c"><TD CLASS="l">615</TD><TD>        data.isHidden = true;</TD></TR><TR CLASS="c"><TD CLASS="l">616</TD><TD>        data.session = systemSession;</TD></TR><TR CLASS="c"><TD CLASS="l">617</TD><TD>        meta = mainSchema.createTable(data);</TD></TR><TR CLASS="c"><TD CLASS="l">618</TD><TD>        IndexColumn[] pkCols = IndexColumn.wrap(new Column[] { columnId });</TD></TR><TR CLASS="c"><TD CLASS="l">619</TD><TD>        metaIdIndex = meta.addIndex(systemSession, &#34;SYS_ID&#34;, 0, pkCols, IndexType.createPrimaryKey(</TD></TR><TR><TD CLASS="l">620</TD><TD>                false, false), true, null);</TD></TR><TR CLASS="c"><TD CLASS="l">621</TD><TD>        objectIds.set(0);</TD></TR><TR CLASS="c"><TD CLASS="l">622</TD><TD>        starting = true;</TD></TR><TR CLASS="c"><TD CLASS="l">623</TD><TD>        Cursor cursor = metaIdIndex.find(systemSession, null, null);</TD></TR><TR CLASS="c"><TD CLASS="l">624</TD><TD>        ArrayList&lt;MetaRecord&gt; records = New.arrayList();</TD></TR><TR CLASS="c"><TD CLASS="l">625</TD><TD>        while (cursor.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">626</TD><TD>            MetaRecord rec = new MetaRecord(cursor.get());</TD></TR><TR CLASS="c"><TD CLASS="l">627</TD><TD>            objectIds.set(rec.getId());</TD></TR><TR CLASS="c"><TD CLASS="l">628</TD><TD>            records.add(rec);</TD></TR><TR CLASS="c"><TD CLASS="l">629</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">630</TD><TD>        Collections.sort(records);</TD></TR><TR CLASS="c"><TD CLASS="l">631</TD><TD>        for (MetaRecord rec : records) {</TD></TR><TR CLASS="c"><TD CLASS="l">632</TD><TD>            rec.execute(this, systemSession, eventListener);</TD></TR><TR><TD CLASS="l">633</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">634</TD><TD>        recompileInvalidViews(systemSession);</TD></TR><TR CLASS="c"><TD CLASS="l">635</TD><TD>        starting = false;</TD></TR><TR CLASS="c"><TD CLASS="l">636</TD><TD>        if (!readOnly) {</TD></TR><TR><TD CLASS="l">637</TD><TD>            // set CREATE_BUILD in a new database</TD></TR><TR CLASS="c"><TD CLASS="l">638</TD><TD>            String name = SetTypes.getTypeName(SetTypes.CREATE_BUILD);</TD></TR><TR CLASS="c"><TD CLASS="l">639</TD><TD>            if (settings.get(name) == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">640</TD><TD>                Setting setting = new Setting(this, allocateObjectId(), name);</TD></TR><TR CLASS="c"><TD CLASS="l">641</TD><TD>                setting.setIntValue(Constants.BUILD_ID);</TD></TR><TR CLASS="c"><TD CLASS="l">642</TD><TD>                lockMeta(systemSession);</TD></TR><TR CLASS="c"><TD CLASS="l">643</TD><TD>                addDatabaseObject(systemSession, setting);</TD></TR><TR><TD CLASS="l">644</TD><TD>            }</TD></TR><TR><TD CLASS="l">645</TD><TD>            // mark all ids used in the page store</TD></TR><TR CLASS="c"><TD CLASS="l">646</TD><TD>            if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">647</TD><TD>                BitField f = pageStore.getObjectIds();</TD></TR><TR CLASS="c"><TD CLASS="l">648</TD><TD>                for (int i = 0, len = f.length(); i &lt; len; i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">649</TD><TD>                    if (f.get(i) &amp;&amp; !objectIds.get(i)) {</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>                        trace.info(&#34;unused object id: &#34; + i);</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>                        objectIds.set(i);</TD></TR><TR><TD CLASS="l">652</TD><TD>                    }</TD></TR><TR><TD CLASS="l">653</TD><TD>                }</TD></TR><TR><TD CLASS="l">654</TD><TD>            }</TD></TR><TR><TD CLASS="l">655</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">656</TD><TD>        getLobStorage().init();</TD></TR><TR CLASS="c"><TD CLASS="l">657</TD><TD>        systemSession.commit(true);</TD></TR><TR><TD CLASS="l">658</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">659</TD><TD>        trace.info(&#34;opened {0}&#34;, databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">660</TD><TD>        if (checkpointAllowed &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">661</TD><TD>            afterWriting();</TD></TR><TR><TD CLASS="l">662</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="10">663</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">664</TD><TD> </TD></TR><TR><TD CLASS="l">665</TD><TD>    private void startServer(String key) {</TD></TR><TR><TD CLASS="l">666</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>            server = Server.createTcpServer(</TD></TR><TR><TD CLASS="l">668</TD><TD>                    &#34;-tcpPort&#34;, Integer.toString(autoServerPort),</TD></TR><TR><TD CLASS="l">669</TD><TD>                    &#34;-tcpAllowOthers&#34;,</TD></TR><TR><TD CLASS="l">670</TD><TD>                    &#34;-tcpDaemon&#34;,</TD></TR><TR><TD CLASS="l">671</TD><TD>                    &#34;-key&#34;, key, databaseName);</TD></TR><TR CLASS="z"><TD CLASS="l">672</TD><TD>            server.start();</TD></TR><TR CLASS="z"><TD CLASS="l">673</TD><TD>        } catch (SQLException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">674</TD><TD>            throw DbException.convert(e);</TD></TR><TR CLASS="z"><TD CLASS="l">675</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>        String address = NetUtils.getLocalAddress() + &#34;:&#34; + server.getPort();</TD></TR><TR CLASS="z"><TD CLASS="l">677</TD><TD>        lock.setProperty(&#34;server&#34;, address);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="17">678</A></TD><TD>        lock.save();</TD></TR><TR CLASS="z"><TD CLASS="l">679</TD><TD>    }</TD></TR><TR><TD CLASS="l">680</TD><TD> </TD></TR><TR><TD CLASS="l">681</TD><TD>    private void stopServer() {</TD></TR><TR CLASS="c"><TD CLASS="l">682</TD><TD>        if (server != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">683</TD><TD>            Server s = server;</TD></TR><TR><TD CLASS="l">684</TD><TD>            // avoid calling stop recursively</TD></TR><TR><TD CLASS="l">685</TD><TD>            // because stopping the server will</TD></TR><TR><TD CLASS="l">686</TD><TD>            // try to close the database as well</TD></TR><TR CLASS="z"><TD CLASS="l">687</TD><TD>            server = null;</TD></TR><TR CLASS="z"><TD CLASS="l">688</TD><TD>            s.stop();</TD></TR><TR><TD CLASS="l">689</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">690</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="34">691</A></TD><TD> </TD></TR><TR><TD CLASS="l">692</TD><TD>    private void recompileInvalidViews(Session session) {</TD></TR><TR><TD CLASS="l">693</TD><TD>        boolean recompileSuccessful;</TD></TR><TR><TD CLASS="l">694</TD><TD>        do {</TD></TR><TR CLASS="c"><TD CLASS="l">695</TD><TD>            recompileSuccessful = false;</TD></TR><TR CLASS="c"><TD CLASS="l">696</TD><TD>            for (Table obj : getAllTablesAndViews(false)) {</TD></TR><TR CLASS="c"><TD CLASS="l">697</TD><TD>                if (obj instanceof TableView) {</TD></TR><TR CLASS="c"><TD CLASS="l">698</TD><TD>                    TableView view = (TableView) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">699</TD><TD>                    if (view.isInvalid()) {</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>                        view.recompile(session, true);</TD></TR><TR CLASS="z"><TD CLASS="l">701</TD><TD>                        if (!view.isInvalid()) {</TD></TR><TR CLASS="z"><TD CLASS="l">702</TD><TD>                            recompileSuccessful = true;</TD></TR><TR><TD CLASS="l">703</TD><TD>                        }</TD></TR><TR><TD CLASS="l">704</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">705</TD><TD>                }</TD></TR><TR><TD CLASS="l">706</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">707</TD><TD>        } while (recompileSuccessful);</TD></TR><TR><TD CLASS="l">708</TD><TD>        // when opening a database, views are initialized before indexes,</TD></TR><TR><TD CLASS="l">709</TD><TD>        // so they may not have the optimal plan yet</TD></TR><TR><TD CLASS="l">710</TD><TD>        // this is not a problem, it is just nice to see the newest plan</TD></TR><TR CLASS="c"><TD CLASS="l">711</TD><TD>        for (Table obj : getAllTablesAndViews(false)) {</TD></TR><TR CLASS="c"><TD CLASS="l">712</TD><TD>            if (obj instanceof TableView) {</TD></TR><TR CLASS="c"><TD CLASS="l">713</TD><TD>                TableView view = (TableView) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">714</TD><TD>                if (!view.isInvalid()) {</TD></TR><TR CLASS="c"><TD CLASS="l">715</TD><TD>                    view.recompile(systemSession, true);</TD></TR><TR><TD CLASS="l">716</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">717</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="3c">718</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">719</TD><TD>    }</TD></TR><TR><TD CLASS="l">720</TD><TD> </TD></TR><TR><TD CLASS="l">721</TD><TD>    private void initMetaTables() {</TD></TR><TR CLASS="c"><TD CLASS="l">722</TD><TD>        if (metaTablesInitialized) {</TD></TR><TR CLASS="c"><TD CLASS="l">723</TD><TD>            return;</TD></TR><TR><TD CLASS="l">724</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">725</TD><TD>        synchronized (infoSchema) {</TD></TR><TR CLASS="c"><TD CLASS="l">726</TD><TD>            if (!metaTablesInitialized) {</TD></TR><TR CLASS="c"><TD CLASS="l">727</TD><TD>                for (int type = 0, count = MetaTable.getMetaTableTypeCount(); type &lt; count; type++) {</TD></TR><TR CLASS="c"><TD CLASS="l">728</TD><TD>                    MetaTable m = new MetaTable(infoSchema, -1 - type, type);</TD></TR><TR CLASS="c"><TD CLASS="l">729</TD><TD>                    infoSchema.add(m);</TD></TR><TR><TD CLASS="l">730</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">731</TD><TD>                metaTablesInitialized = true;</TD></TR><TR><TD CLASS="l">732</TD><TD>            }</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="38% line coverage (3 out of 8 instructions)"><A NAME="38">733</A></TD><TD TITLE="38% line coverage (3 out of 8 instructions)">        }</TD></TR><TR CLASS="c"><TD CLASS="l">734</TD><TD>    }</TD></TR><TR><TD CLASS="l">735</TD><TD> </TD></TR><TR><TD CLASS="l">736</TD><TD>    private synchronized void addMeta(Session session, DbObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">737</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">738</TD><TD>        if (id &gt; 0 &amp;&amp; !starting &amp;&amp; !obj.isTemporary()) {</TD></TR><TR CLASS="c"><TD CLASS="l">739</TD><TD>            Row r = meta.getTemplateRow();</TD></TR><TR CLASS="c"><TD CLASS="l">740</TD><TD>            MetaRecord rec = new MetaRecord(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">741</TD><TD>            rec.setRecord(r);</TD></TR><TR CLASS="c"><TD CLASS="l">742</TD><TD>            objectIds.set(id);</TD></TR><TR CLASS="c"><TD CLASS="l">743</TD><TD>            if (SysProperties.CHECK) {</TD></TR><TR CLASS="c"><TD CLASS="l">744</TD><TD>                verifyMetaLocked(session);</TD></TR><TR><TD CLASS="l">745</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">746</TD><TD>            meta.addRow(session, r);</TD></TR><TR CLASS="c"><TD CLASS="l">747</TD><TD>            if (isMultiVersion()) {</TD></TR><TR><TD CLASS="l">748</TD><TD>                // TODO this should work without MVCC, but avoid risks at the moment</TD></TR><TR CLASS="z"><TD CLASS="l">749</TD><TD>                session.log(meta, UndoLogRecord.INSERT, r);</TD></TR><TR><TD CLASS="l">750</TD><TD>            }</TD></TR><TR><TD CLASS="l">751</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">752</TD><TD>    }</TD></TR><TR><TD CLASS="l">753</TD><TD> </TD></TR><TR><TD CLASS="l">754</TD><TD>    /**</TD></TR><TR><TD CLASS="l">755</TD><TD>     * Verify the meta table is locked.</TD></TR><TR><TD CLASS="l"><A NAME="1e">756</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">757</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">758</TD><TD>     */</TD></TR><TR><TD CLASS="l">759</TD><TD>    public void verifyMetaLocked(Session session) {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="57% line coverage (4 out of 7 instructions)">760</TD><TD TITLE="57% line coverage (4 out of 7 instructions)">        if (!lockMeta(session) &amp;&amp; lockMode != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">761</TD><TD>            throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">762</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">763</TD><TD>    }</TD></TR><TR><TD CLASS="l">764</TD><TD> </TD></TR><TR><TD CLASS="l">765</TD><TD>    /**</TD></TR><TR><TD CLASS="l">766</TD><TD>     * Lock the metadata table for updates.</TD></TR><TR><TD CLASS="l">767</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="8c">768</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">769</TD><TD>     * @return whether it was already locked before by this session</TD></TR><TR><TD CLASS="l">770</TD><TD>     */</TD></TR><TR><TD CLASS="l">771</TD><TD>    public synchronized boolean lockMeta(Session session) {</TD></TR><TR CLASS="c"><TD CLASS="l">772</TD><TD>        if (meta == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">773</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">774</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">775</TD><TD>        boolean wasLocked = meta.isLockedExclusivelyBy(session);</TD></TR><TR CLASS="c"><TD CLASS="l">776</TD><TD>        meta.lock(session, true, true);</TD></TR><TR CLASS="c"><TD CLASS="l">777</TD><TD>        return wasLocked;</TD></TR><TR><TD CLASS="l">778</TD><TD>    }</TD></TR><TR><TD CLASS="l">779</TD><TD> </TD></TR><TR><TD CLASS="l">780</TD><TD>    /**</TD></TR><TR><TD CLASS="l">781</TD><TD>     * Remove the given object from the meta data.</TD></TR><TR><TD CLASS="l">782</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="3d">783</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">784</TD><TD>     * @param id the id of the object to remove</TD></TR><TR><TD CLASS="l">785</TD><TD>     */</TD></TR><TR><TD CLASS="l">786</TD><TD>    public synchronized void removeMeta(Session session, int id) {</TD></TR><TR CLASS="c"><TD CLASS="l">787</TD><TD>        if (id &gt; 0 &amp;&amp; !starting) {</TD></TR><TR CLASS="c"><TD CLASS="l">788</TD><TD>            SearchRow r = meta.getTemplateSimpleRow(false);</TD></TR><TR CLASS="c"><TD CLASS="l">789</TD><TD>            r.setValue(0, ValueInt.get(id));</TD></TR><TR CLASS="c"><TD CLASS="l">790</TD><TD>            boolean wasLocked = lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">791</TD><TD>            Cursor cursor = metaIdIndex.find(session, r, r);</TD></TR><TR CLASS="c"><TD CLASS="l">792</TD><TD>            if (cursor.next()) {</TD></TR><TR CLASS="c"><TD CLASS="l">793</TD><TD>                if (SysProperties.CHECK) {</TD></TR><TR CLASS="c"><TD CLASS="l">794</TD><TD>                    if (lockMode != 0 &amp;&amp; !wasLocked) {</TD></TR><TR CLASS="z"><TD CLASS="l">795</TD><TD>                        throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">796</TD><TD>                    }</TD></TR><TR><TD CLASS="l">797</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">798</TD><TD>                Row found = cursor.get();</TD></TR><TR CLASS="c"><TD CLASS="l">799</TD><TD>                meta.removeRow(session, found);</TD></TR><TR CLASS="c"><TD CLASS="l">800</TD><TD>                if (isMultiVersion()) {</TD></TR><TR><TD CLASS="l">801</TD><TD>                    // TODO this should work without MVCC, but avoid risks at the</TD></TR><TR><TD CLASS="l">802</TD><TD>                    // moment</TD></TR><TR CLASS="z"><TD CLASS="l">803</TD><TD>                    session.log(meta, UndoLogRecord.DELETE, found);</TD></TR><TR><TD CLASS="l">804</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">805</TD><TD>                objectIds.clear(id);</TD></TR><TR CLASS="c"><TD CLASS="l">806</TD><TD>                if (SysProperties.CHECK) {</TD></TR><TR CLASS="c"><TD CLASS="l">807</TD><TD>                    checkMetaFree(session, id);</TD></TR><TR><TD CLASS="l">808</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">809</TD><TD>            } else if (!wasLocked) {</TD></TR><TR><TD CLASS="l">810</TD><TD>                // must not keep the lock if it was not locked</TD></TR><TR><TD CLASS="l">811</TD><TD>                // otherwise updating sequences may cause a deadlock</TD></TR><TR CLASS="c"><TD CLASS="l">812</TD><TD>                meta.unlock(session);</TD></TR><TR CLASS="c"><TD CLASS="l">813</TD><TD>                session.unlock(meta);</TD></TR><TR><TD CLASS="l">814</TD><TD>            }</TD></TR><TR><TD CLASS="l">815</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">816</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="2e">817</A></TD><TD> </TD></TR><TR><TD CLASS="l">818</TD><TD>    @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR><TD CLASS="l">819</TD><TD>    private HashMap&lt;String, DbObject&gt; getMap(int type) {</TD></TR><TR><TD CLASS="l">820</TD><TD>        HashMap&lt;String, ? extends DbObject&gt; result;</TD></TR><TR CLASS="c"><TD CLASS="l">821</TD><TD>        switch (type) {</TD></TR><TR><TD CLASS="l">822</TD><TD>        case DbObject.USER:</TD></TR><TR CLASS="c"><TD CLASS="l">823</TD><TD>            result = users;</TD></TR><TR CLASS="c"><TD CLASS="l">824</TD><TD>            break;</TD></TR><TR><TD CLASS="l">825</TD><TD>        case DbObject.SETTING:</TD></TR><TR CLASS="c"><TD CLASS="l">826</TD><TD>            result = settings;</TD></TR><TR CLASS="c"><TD CLASS="l">827</TD><TD>            break;</TD></TR><TR><TD CLASS="l">828</TD><TD>        case DbObject.ROLE:</TD></TR><TR CLASS="c"><TD CLASS="l">829</TD><TD>            result = roles;</TD></TR><TR CLASS="c"><TD CLASS="l">830</TD><TD>            break;</TD></TR><TR><TD CLASS="l">831</TD><TD>        case DbObject.RIGHT:</TD></TR><TR CLASS="c"><TD CLASS="l">832</TD><TD>            result = rights;</TD></TR><TR CLASS="c"><TD CLASS="l">833</TD><TD>            break;</TD></TR><TR><TD CLASS="l">834</TD><TD>        case DbObject.SCHEMA:</TD></TR><TR CLASS="c"><TD CLASS="l">835</TD><TD>            result = schemas;</TD></TR><TR CLASS="c"><TD CLASS="l">836</TD><TD>            break;</TD></TR><TR><TD CLASS="l">837</TD><TD>        case DbObject.USER_DATATYPE:</TD></TR><TR CLASS="c"><TD CLASS="l">838</TD><TD>            result = userDataTypes;</TD></TR><TR CLASS="c"><TD CLASS="l">839</TD><TD>            break;</TD></TR><TR><TD CLASS="l">840</TD><TD>        case DbObject.COMMENT:</TD></TR><TR CLASS="c"><TD CLASS="l">841</TD><TD>            result = comments;</TD></TR><TR CLASS="c"><TD CLASS="l">842</TD><TD>            break;</TD></TR><TR><TD CLASS="l">843</TD><TD>        case DbObject.AGGREGATE:</TD></TR><TR CLASS="c"><TD CLASS="l">844</TD><TD>            result = aggregates;</TD></TR><TR CLASS="c"><TD CLASS="l">845</TD><TD>            break;</TD></TR><TR><TD CLASS="l">846</TD><TD>        default:</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>            throw DbException.throwInternalError(&#34;type=&#34; + type);</TD></TR><TR><TD CLASS="l">848</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">849</TD><TD>        return (HashMap&lt;String, DbObject&gt;) result;</TD></TR><TR><TD CLASS="l">850</TD><TD>    }</TD></TR><TR><TD CLASS="l">851</TD><TD> </TD></TR><TR><TD CLASS="l">852</TD><TD>    /**</TD></TR><TR><TD CLASS="l">853</TD><TD>     * Add a schema object to the database.</TD></TR><TR><TD CLASS="l">854</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="49">855</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">856</TD><TD>     * @param obj the object to add</TD></TR><TR><TD CLASS="l">857</TD><TD>     */</TD></TR><TR><TD CLASS="l">858</TD><TD>    public synchronized void addSchemaObject(Session session, SchemaObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">859</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">860</TD><TD>        if (id &gt; 0 &amp;&amp; !starting) {</TD></TR><TR CLASS="c"><TD CLASS="l">861</TD><TD>            checkWritingAllowed();</TD></TR><TR><TD CLASS="l">862</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">863</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">864</TD><TD>        obj.getSchema().add(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">865</TD><TD>        addMeta(session, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">866</TD><TD>    }</TD></TR><TR><TD CLASS="l">867</TD><TD> </TD></TR><TR><TD CLASS="l">868</TD><TD>    /**</TD></TR><TR><TD CLASS="l">869</TD><TD>     * Add an object to the database.</TD></TR><TR><TD CLASS="l">870</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="45">871</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">872</TD><TD>     * @param obj the object to add</TD></TR><TR><TD CLASS="l">873</TD><TD>     */</TD></TR><TR><TD CLASS="l">874</TD><TD>    public synchronized void addDatabaseObject(Session session, DbObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">875</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">876</TD><TD>        if (id &gt; 0 &amp;&amp; !starting) {</TD></TR><TR CLASS="c"><TD CLASS="l">877</TD><TD>            checkWritingAllowed();</TD></TR><TR><TD CLASS="l">878</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">879</TD><TD>        HashMap&lt;String, DbObject&gt; map = getMap(obj.getType());</TD></TR><TR CLASS="c"><TD CLASS="l">880</TD><TD>        if (obj.getType() == DbObject.USER) {</TD></TR><TR CLASS="c"><TD CLASS="l">881</TD><TD>            User user = (User) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">882</TD><TD>            if (user.isAdmin() &amp;&amp; systemUser.getName().equals(SYSTEM_USER_NAME)) {</TD></TR><TR CLASS="c"><TD CLASS="l">883</TD><TD>                systemUser.rename(user.getName());</TD></TR><TR><TD CLASS="l">884</TD><TD>            }</TD></TR><TR><TD CLASS="l">885</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">886</TD><TD>        String name = obj.getName();</TD></TR><TR CLASS="c"><TD CLASS="l">887</TD><TD>        if (SysProperties.CHECK &amp;&amp; map.get(name) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>            DbException.throwInternalError(&#34;object already exists&#34;);</TD></TR><TR><TD CLASS="l">889</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">890</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">891</TD><TD>        addMeta(session, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">892</TD><TD>        map.put(name, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">893</TD><TD>    }</TD></TR><TR><TD CLASS="l">894</TD><TD> </TD></TR><TR><TD CLASS="l">895</TD><TD>    /**</TD></TR><TR><TD CLASS="l">896</TD><TD>     * Get the user defined aggregate function if it exists, or null if not.</TD></TR><TR><TD CLASS="l">897</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="50">898</A></TD><TD>     * @param name the name of the user defined aggregate function</TD></TR><TR><TD CLASS="l">899</TD><TD>     * @return the aggregate function or null</TD></TR><TR><TD CLASS="l">900</TD><TD>     */</TD></TR><TR><TD CLASS="l">901</TD><TD>    public UserAggregate findAggregate(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">902</TD><TD>        return aggregates.get(name);</TD></TR><TR><TD CLASS="l">903</TD><TD>    }</TD></TR><TR><TD CLASS="l">904</TD><TD> </TD></TR><TR><TD CLASS="l">905</TD><TD>    /**</TD></TR><TR><TD CLASS="l">906</TD><TD>     * Get the comment for the given database object if one exists, or null if</TD></TR><TR><TD CLASS="l">907</TD><TD>     * not.</TD></TR><TR><TD CLASS="l">908</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="51">909</A></TD><TD>     * @param object the database object</TD></TR><TR><TD CLASS="l">910</TD><TD>     * @return the comment or null</TD></TR><TR><TD CLASS="l">911</TD><TD>     */</TD></TR><TR><TD CLASS="l">912</TD><TD>    public Comment findComment(DbObject object) {</TD></TR><TR CLASS="c"><TD CLASS="l">913</TD><TD>        if (object.getType() == DbObject.COMMENT) {</TD></TR><TR CLASS="c"><TD CLASS="l">914</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">915</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">916</TD><TD>        String key = Comment.getKey(object);</TD></TR><TR CLASS="c"><TD CLASS="l">917</TD><TD>        return comments.get(key);</TD></TR><TR><TD CLASS="l">918</TD><TD>    }</TD></TR><TR><TD CLASS="l">919</TD><TD> </TD></TR><TR><TD CLASS="l">920</TD><TD>    /**</TD></TR><TR><TD CLASS="l">921</TD><TD>     * Get the role if it exists, or null if not.</TD></TR><TR><TD CLASS="l">922</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="52">923</A></TD><TD>     * @param roleName the name of the role</TD></TR><TR><TD CLASS="l">924</TD><TD>     * @return the role or null</TD></TR><TR><TD CLASS="l">925</TD><TD>     */</TD></TR><TR><TD CLASS="l">926</TD><TD>    public Role findRole(String roleName) {</TD></TR><TR CLASS="c"><TD CLASS="l">927</TD><TD>        return roles.get(roleName);</TD></TR><TR><TD CLASS="l">928</TD><TD>    }</TD></TR><TR><TD CLASS="l">929</TD><TD> </TD></TR><TR><TD CLASS="l">930</TD><TD>    /**</TD></TR><TR><TD CLASS="l">931</TD><TD>     * Get the schema if it exists, or null if not.</TD></TR><TR><TD CLASS="l">932</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="53">933</A></TD><TD>     * @param schemaName the name of the schema</TD></TR><TR><TD CLASS="l">934</TD><TD>     * @return the schema or null</TD></TR><TR><TD CLASS="l">935</TD><TD>     */</TD></TR><TR><TD CLASS="l">936</TD><TD>    public Schema findSchema(String schemaName) {</TD></TR><TR CLASS="c"><TD CLASS="l">937</TD><TD>        Schema schema = schemas.get(schemaName);</TD></TR><TR CLASS="c"><TD CLASS="l">938</TD><TD>        if (schema == infoSchema) {</TD></TR><TR CLASS="c"><TD CLASS="l">939</TD><TD>            initMetaTables();</TD></TR><TR><TD CLASS="l">940</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">941</TD><TD>        return schema;</TD></TR><TR><TD CLASS="l">942</TD><TD>    }</TD></TR><TR><TD CLASS="l">943</TD><TD> </TD></TR><TR><TD CLASS="l">944</TD><TD>    /**</TD></TR><TR><TD CLASS="l">945</TD><TD>     * Get the setting if it exists, or null if not.</TD></TR><TR><TD CLASS="l">946</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="54">947</A></TD><TD>     * @param name the name of the setting</TD></TR><TR><TD CLASS="l">948</TD><TD>     * @return the setting or null</TD></TR><TR><TD CLASS="l">949</TD><TD>     */</TD></TR><TR><TD CLASS="l">950</TD><TD>    public Setting findSetting(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">951</TD><TD>        return settings.get(name);</TD></TR><TR><TD CLASS="l">952</TD><TD>    }</TD></TR><TR><TD CLASS="l">953</TD><TD> </TD></TR><TR><TD CLASS="l">954</TD><TD>    /**</TD></TR><TR><TD CLASS="l">955</TD><TD>     * Get the user if it exists, or null if not.</TD></TR><TR><TD CLASS="l">956</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="55">957</A></TD><TD>     * @param name the name of the user</TD></TR><TR><TD CLASS="l">958</TD><TD>     * @return the user or null</TD></TR><TR><TD CLASS="l">959</TD><TD>     */</TD></TR><TR><TD CLASS="l">960</TD><TD>    public User findUser(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">961</TD><TD>        return users.get(name);</TD></TR><TR><TD CLASS="l">962</TD><TD>    }</TD></TR><TR><TD CLASS="l">963</TD><TD> </TD></TR><TR><TD CLASS="l">964</TD><TD>    /**</TD></TR><TR><TD CLASS="l">965</TD><TD>     * Get the user defined data type if it exists, or null if not.</TD></TR><TR><TD CLASS="l">966</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="56">967</A></TD><TD>     * @param name the name of the user defined data type</TD></TR><TR><TD CLASS="l">968</TD><TD>     * @return the user defined data type or null</TD></TR><TR><TD CLASS="l">969</TD><TD>     */</TD></TR><TR><TD CLASS="l">970</TD><TD>    public UserDataType findUserDataType(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">971</TD><TD>        return userDataTypes.get(name);</TD></TR><TR><TD CLASS="l">972</TD><TD>    }</TD></TR><TR><TD CLASS="l">973</TD><TD> </TD></TR><TR><TD CLASS="l">974</TD><TD>    /**</TD></TR><TR><TD CLASS="l">975</TD><TD>     * Get user with the given name. This method throws an exception if the user</TD></TR><TR><TD CLASS="l">976</TD><TD>     * does not exist.</TD></TR><TR><TD CLASS="l">977</TD><TD>     *</TD></TR><TR><TD CLASS="l">978</TD><TD>     * @param name the user name</TD></TR><TR><TD CLASS="l"><A NAME="25">979</A></TD><TD>     * @return the user</TD></TR><TR><TD CLASS="l">980</TD><TD>     * @throws DbException if the user does not exist</TD></TR><TR><TD CLASS="l">981</TD><TD>     */</TD></TR><TR><TD CLASS="l">982</TD><TD>    public User getUser(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">983</TD><TD>        User user = findUser(name);</TD></TR><TR CLASS="c"><TD CLASS="l">984</TD><TD>        if (user == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>            throw DbException.get(ErrorCode.USER_NOT_FOUND_1, name);</TD></TR><TR><TD CLASS="l">986</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">987</TD><TD>        return user;</TD></TR><TR><TD CLASS="l">988</TD><TD>    }</TD></TR><TR><TD CLASS="l">989</TD><TD> </TD></TR><TR><TD CLASS="l">990</TD><TD>    /**</TD></TR><TR><TD CLASS="l">991</TD><TD>     * Create a session for the given user.</TD></TR><TR><TD CLASS="l">992</TD><TD>     *</TD></TR><TR><TD CLASS="l">993</TD><TD>     * @param user the user</TD></TR><TR><TD CLASS="l"><A NAME="3a">994</A></TD><TD>     * @return the session</TD></TR><TR><TD CLASS="l">995</TD><TD>     * @throws DbException if the database is in exclusive mode</TD></TR><TR><TD CLASS="l">996</TD><TD>     */</TD></TR><TR><TD CLASS="l">997</TD><TD>    synchronized Session createSession(User user) {</TD></TR><TR CLASS="c"><TD CLASS="l">998</TD><TD>        if (exclusiveSession != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">999</TD><TD>            throw DbException.get(ErrorCode.DATABASE_IS_IN_EXCLUSIVE_MODE);</TD></TR><TR><TD CLASS="l">1000</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1001</TD><TD>        Session session = new Session(this, user, ++nextSessionId);</TD></TR><TR CLASS="c"><TD CLASS="l">1002</TD><TD>        userSessions.add(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1003</TD><TD>        trace.info(&#34;connecting session #{0} to {1}&#34;, session.getId(), databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1004</TD><TD>        if (delayedCloser != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1005</TD><TD>            delayedCloser.reset();</TD></TR><TR CLASS="z"><TD CLASS="l">1006</TD><TD>            delayedCloser = null;</TD></TR><TR><TD CLASS="l">1007</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1008</TD><TD>        return session;</TD></TR><TR><TD CLASS="l">1009</TD><TD>    }</TD></TR><TR><TD CLASS="l">1010</TD><TD> </TD></TR><TR><TD CLASS="l">1011</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1012</TD><TD>     * Remove a session. This method is called after the user has disconnected.</TD></TR><TR><TD CLASS="l"><A NAME="23">1013</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1014</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1015</TD><TD>     */</TD></TR><TR><TD CLASS="l">1016</TD><TD>    public synchronized void removeSession(Session session) {</TD></TR><TR CLASS="c"><TD CLASS="l">1017</TD><TD>        if (session != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1018</TD><TD>            if (exclusiveSession == session) {</TD></TR><TR CLASS="c"><TD CLASS="l">1019</TD><TD>                exclusiveSession = null;</TD></TR><TR><TD CLASS="l">1020</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1021</TD><TD>            userSessions.remove(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1022</TD><TD>            if (session != systemSession) {</TD></TR><TR CLASS="c"><TD CLASS="l">1023</TD><TD>                trace.info(&#34;disconnecting session #{0}&#34;, session.getId());</TD></TR><TR><TD CLASS="l">1024</TD><TD>            }</TD></TR><TR><TD CLASS="l">1025</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1026</TD><TD>        if (userSessions.size() == 0 &amp;&amp; session != systemSession) {</TD></TR><TR CLASS="c"><TD CLASS="l">1027</TD><TD>            if (closeDelay == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">1028</TD><TD>                close(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1029</TD><TD>            } else if (closeDelay &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1030</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1031</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1032</TD><TD>                delayedCloser = new DatabaseCloser(this, closeDelay * 1000, false);</TD></TR><TR CLASS="z"><TD CLASS="l">1033</TD><TD>                delayedCloser.setName(&#34;H2 Close Delay &#34; + getShortName());</TD></TR><TR CLASS="z"><TD CLASS="l">1034</TD><TD>                delayedCloser.setDaemon(true);</TD></TR><TR CLASS="z"><TD CLASS="l">1035</TD><TD>                delayedCloser.start();</TD></TR><TR><TD CLASS="l">1036</TD><TD>            }</TD></TR><TR><TD CLASS="l">1037</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1038</TD><TD>        if (session != systemSession &amp;&amp; session != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1039</TD><TD>            trace.info(&#34;disconnected session #{0}&#34;, session.getId());</TD></TR><TR><TD CLASS="l"><A NAME="27">1040</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1041</TD><TD>    }</TD></TR><TR><TD CLASS="l">1042</TD><TD> </TD></TR><TR><TD CLASS="l">1043</TD><TD>    private synchronized void closeAllSessionsException(Session except) {</TD></TR><TR CLASS="c"><TD CLASS="l">1044</TD><TD>        Session[] all = new Session[userSessions.size()];</TD></TR><TR CLASS="c"><TD CLASS="l">1045</TD><TD>        userSessions.toArray(all);</TD></TR><TR CLASS="c"><TD CLASS="l">1046</TD><TD>        for (Session s : all) {</TD></TR><TR CLASS="c"><TD CLASS="l">1047</TD><TD>            if (s != except) {</TD></TR><TR><TD CLASS="l">1048</TD><TD>                try {</TD></TR><TR><TD CLASS="l">1049</TD><TD>                    // must roll back, otherwise the session is removed and</TD></TR><TR><TD CLASS="l">1050</TD><TD>                    // the transaction log that contains its uncommitted operations as well</TD></TR><TR CLASS="c"><TD CLASS="l">1051</TD><TD>                    s.rollback();</TD></TR><TR CLASS="c"><TD CLASS="l">1052</TD><TD>                    s.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1053</TD><TD>                } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>                    trace.error(e, &#34;disconnecting session #{0}&#34;, s.getId());</TD></TR><TR CLASS="c"><TD CLASS="l">1055</TD><TD>                }</TD></TR><TR><TD CLASS="l">1056</TD><TD>            }</TD></TR><TR><TD CLASS="l">1057</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1058</TD><TD>    }</TD></TR><TR><TD CLASS="l">1059</TD><TD> </TD></TR><TR><TD CLASS="l">1060</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1061</TD><TD>     * Close the database.</TD></TR><TR><TD CLASS="l">1062</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="36">1063</A></TD><TD>     * @param fromShutdownHook true if this method is called from the shutdown</TD></TR><TR><TD CLASS="l">1064</TD><TD>     *            hook</TD></TR><TR><TD CLASS="l">1065</TD><TD>     */</TD></TR><TR><TD CLASS="l">1066</TD><TD>    synchronized void close(boolean fromShutdownHook) {</TD></TR><TR CLASS="c"><TD CLASS="l">1067</TD><TD>        if (closing) {</TD></TR><TR CLASS="c"><TD CLASS="l">1068</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1069</TD><TD>        }</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="57% line coverage (4 out of 7 instructions)">1070</TD><TD TITLE="57% line coverage (4 out of 7 instructions)">        if (fileLockMethod == FileLock.LOCK_SERIALIZED &amp;&amp; !reconnectChangePending) {</TD></TR><TR><TD CLASS="l">1071</TD><TD>            // another connection may have written something - don't write</TD></TR><TR><TD CLASS="l">1072</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1073</TD><TD>                closeOpenFilesAndUnlock(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>            } catch (DbException e) {</TD></TR><TR><TD CLASS="l">1075</TD><TD>                // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">1076</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>            traceSystem.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1078</TD><TD>            Engine.getInstance().close(databaseName);</TD></TR><TR CLASS="z"><TD CLASS="l">1079</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1080</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1081</TD><TD>        closing = true;</TD></TR><TR CLASS="c"><TD CLASS="l">1082</TD><TD>        stopServer();</TD></TR><TR CLASS="c"><TD CLASS="l">1083</TD><TD>        if (userSessions.size() &gt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">1084</TD><TD>            if (!fromShutdownHook) {</TD></TR><TR CLASS="z"><TD CLASS="l">1085</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1086</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1087</TD><TD>            trace.info(&#34;closing {0} from shutdown hook&#34;, databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1088</TD><TD>            closeAllSessionsException(null);</TD></TR><TR><TD CLASS="l">1089</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1090</TD><TD>        trace.info(&#34;closing {0}&#34;, databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1091</TD><TD>        if (eventListener != null) {</TD></TR><TR><TD CLASS="l">1092</TD><TD>            // allow the event listener to connect to the database</TD></TR><TR CLASS="c"><TD CLASS="l">1093</TD><TD>            closing = false;</TD></TR><TR CLASS="c"><TD CLASS="l">1094</TD><TD>            DatabaseEventListener e = eventListener;</TD></TR><TR><TD CLASS="l">1095</TD><TD>            // set it to null, to make sure it's called only once</TD></TR><TR CLASS="c"><TD CLASS="l">1096</TD><TD>            eventListener = null;</TD></TR><TR CLASS="c"><TD CLASS="l">1097</TD><TD>            e.closingDatabase();</TD></TR><TR CLASS="c"><TD CLASS="l">1098</TD><TD>            if (userSessions.size() &gt; 0) {</TD></TR><TR><TD CLASS="l">1099</TD><TD>                // if a connection was opened, we can't close the database</TD></TR><TR CLASS="z"><TD CLASS="l">1100</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1101</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1102</TD><TD>            closing = true;</TD></TR><TR><TD CLASS="l">1103</TD><TD>        }</TD></TR><TR><TD CLASS="l">1104</TD><TD>        // remove all session variables</TD></TR><TR CLASS="c"><TD CLASS="l">1105</TD><TD>        if (persistent) {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="92% line coverage (12 out of 13 instructions)">1106</TD><TD TITLE="92% line coverage (12 out of 13 instructions)">            boolean lobStorageIsUsed = infoSchema.findTableOrView(systemSession, LobStorage.LOB_DATA_TABLE) != null;</TD></TR><TR CLASS="c"><TD CLASS="l">1107</TD><TD>            if (lobStorageIsUsed) {</TD></TR><TR><TD CLASS="l">1108</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">1109</TD><TD>                    getLobStorage();</TD></TR><TR CLASS="c"><TD CLASS="l">1110</TD><TD>                    lobStorage.removeAllForTable(LobStorage.TABLE_ID_SESSION_VARIABLE);</TD></TR><TR CLASS="c"><TD CLASS="l">1111</TD><TD>                } catch (DbException e) {</TD></TR><TR CLASS="c"><TD CLASS="l">1112</TD><TD>                    trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">1113</TD><TD>                }</TD></TR><TR><TD CLASS="l">1114</TD><TD>            }</TD></TR><TR><TD CLASS="l">1115</TD><TD>        }</TD></TR><TR><TD CLASS="l">1116</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">1117</TD><TD>            if (systemSession != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1118</TD><TD>                if (powerOffCount != -1) {</TD></TR><TR CLASS="c"><TD CLASS="l">1119</TD><TD>                    for (Table table : getAllTablesAndViews(false)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1120</TD><TD>                        if (table.isGlobalTemporary()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1121</TD><TD>                            table.removeChildrenAndResources(systemSession);</TD></TR><TR><TD CLASS="l">1122</TD><TD>                        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1123</TD><TD>                            table.close(systemSession);</TD></TR><TR><TD CLASS="l">1124</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1125</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">1126</TD><TD>                    for (SchemaObject obj : getAllSchemaObjects(DbObject.SEQUENCE)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1127</TD><TD>                        Sequence sequence = (Sequence) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">1128</TD><TD>                        sequence.close();</TD></TR><TR CLASS="c"><TD CLASS="l">1129</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1130</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">1131</TD><TD>                for (SchemaObject obj : getAllSchemaObjects(DbObject.TRIGGER)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1132</TD><TD>                    TriggerObject trigger = (TriggerObject) obj;</TD></TR><TR><TD CLASS="l">1133</TD><TD>                    try {</TD></TR><TR CLASS="c"><TD CLASS="l">1134</TD><TD>                        trigger.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1135</TD><TD>                    } catch (SQLException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>                        trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">1137</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">1138</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">1139</TD><TD>                if (powerOffCount != -1) {</TD></TR><TR CLASS="c"><TD CLASS="l">1140</TD><TD>                    meta.close(systemSession);</TD></TR><TR CLASS="c"><TD CLASS="l">1141</TD><TD>                    systemSession.commit(true);</TD></TR><TR><TD CLASS="l">1142</TD><TD>                }</TD></TR><TR><TD CLASS="l">1143</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1144</TD><TD>        } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1145</TD><TD>            trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">1146</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1147</TD><TD>        tempFileDeleter.deleteAll();</TD></TR><TR><TD CLASS="l">1148</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">1149</TD><TD>            closeOpenFilesAndUnlock(true);</TD></TR><TR CLASS="z"><TD CLASS="l">1150</TD><TD>        } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1151</TD><TD>            trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">1152</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1153</TD><TD>        trace.info(&#34;closed&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">1154</TD><TD>        traceSystem.close();</TD></TR><TR CLASS="c"><TD CLASS="l">1155</TD><TD>        if (closeOnExit != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1156</TD><TD>            closeOnExit.reset();</TD></TR><TR><TD CLASS="l">1157</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1158</TD><TD>                Runtime.getRuntime().removeShutdownHook(closeOnExit);</TD></TR><TR CLASS="c"><TD CLASS="l">1159</TD><TD>            } catch (IllegalStateException e) {</TD></TR><TR><TD CLASS="l">1160</TD><TD>                // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>            } catch (SecurityException  e) {</TD></TR><TR><TD CLASS="l">1162</TD><TD>                // applets may not do that - ignore</TD></TR><TR CLASS="c"><TD CLASS="l">1163</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1164</TD><TD>            closeOnExit = null;</TD></TR><TR><TD CLASS="l">1165</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1166</TD><TD>        Engine.getInstance().close(databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1167</TD><TD>        if (deleteFilesOnDisconnect &amp;&amp; persistent) {</TD></TR><TR CLASS="c"><TD CLASS="l">1168</TD><TD>            deleteFilesOnDisconnect = false;</TD></TR><TR><TD CLASS="l">1169</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1170</TD><TD>                String directory = FileUtils.getParent(databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1171</TD><TD>                String name = FileUtils.getName(databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1172</TD><TD>                DeleteDbFiles.execute(directory, name, true);</TD></TR><TR CLASS="z"><TD CLASS="l">1173</TD><TD>            } catch (Exception e) {</TD></TR><TR><TD CLASS="l">1174</TD><TD>                // ignore (the trace is closed already)</TD></TR><TR CLASS="c"><TD CLASS="l">1175</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="a1">1176</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1177</TD><TD>    }</TD></TR><TR><TD CLASS="l">1178</TD><TD> </TD></TR><TR><TD CLASS="l">1179</TD><TD>    private void stopWriter() {</TD></TR><TR CLASS="c"><TD CLASS="l">1180</TD><TD>        if (writer != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1181</TD><TD>            writer.stopThread();</TD></TR><TR CLASS="c"><TD CLASS="l">1182</TD><TD>            writer = null;</TD></TR><TR><TD CLASS="l">1183</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1184</TD><TD>    }</TD></TR><TR><TD CLASS="l">1185</TD><TD> </TD></TR><TR><TD CLASS="l">1186</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1187</TD><TD>     * Close all open files and unlock the database.</TD></TR><TR><TD CLASS="l"><A NAME="1f">1188</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1189</TD><TD>     * @param flush whether writing is allowed</TD></TR><TR><TD CLASS="l">1190</TD><TD>     */</TD></TR><TR><TD CLASS="l">1191</TD><TD>    private synchronized void closeOpenFilesAndUnlock(boolean flush) {</TD></TR><TR CLASS="c"><TD CLASS="l">1192</TD><TD>        stopWriter();</TD></TR><TR CLASS="c"><TD CLASS="l">1193</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1194</TD><TD>            if (flush) {</TD></TR><TR><TD CLASS="l">1195</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">1196</TD><TD>                    pageStore.checkpoint();</TD></TR><TR CLASS="c"><TD CLASS="l">1197</TD><TD>                    if (!readOnly) {</TD></TR><TR CLASS="c"><TD CLASS="l">1198</TD><TD>                        lockMeta(pageStore.getSystemSession());</TD></TR><TR CLASS="c"><TD CLASS="l">1199</TD><TD>                        pageStore.compact(compactMode);</TD></TR><TR><TD CLASS="l">1200</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1201</TD><TD>                } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1202</TD><TD>                    if (SysProperties.CHECK2) {</TD></TR><TR CLASS="z"><TD CLASS="l">1203</TD><TD>                        int code = e.getErrorCode();</TD></TR><TR CLASS="z"><TD CLASS="l">1204</TD><TD>                        if (code != ErrorCode.DATABASE_IS_CLOSED &amp;&amp;</TD></TR><TR><TD CLASS="l">1205</TD><TD>                                code != ErrorCode.LOCK_TIMEOUT_1 &amp;&amp;</TD></TR><TR><TD CLASS="l">1206</TD><TD>                                code != ErrorCode.IO_EXCEPTION_2) {</TD></TR><TR CLASS="z"><TD CLASS="l">1207</TD><TD>                            e.printStackTrace();</TD></TR><TR><TD CLASS="l">1208</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1209</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1210</TD><TD>                    trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1211</TD><TD>                } catch (Throwable t) {</TD></TR><TR CLASS="z"><TD CLASS="l">1212</TD><TD>                    if (SysProperties.CHECK2) {</TD></TR><TR CLASS="z"><TD CLASS="l">1213</TD><TD>                        t.printStackTrace();</TD></TR><TR><TD CLASS="l">1214</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1215</TD><TD>                    trace.error(t, &#34;close&#34;);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="14% line coverage (1 out of 7 instructions)">1216</TD><TD TITLE="14% line coverage (1 out of 7 instructions)">                }</TD></TR><TR><TD CLASS="l">1217</TD><TD>            }</TD></TR><TR><TD CLASS="l">1218</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1219</TD><TD>        reconnectModified(false);</TD></TR><TR CLASS="c"><TD CLASS="l">1220</TD><TD>        closeFiles();</TD></TR><TR CLASS="c"><TD CLASS="l">1221</TD><TD>        if (persistent &amp;&amp; lock == null &amp;&amp; fileLockMethod != FileLock.LOCK_NO &amp;&amp; fileLockMethod != FileLock.LOCK_FS) {</TD></TR><TR><TD CLASS="l">1222</TD><TD>            // everything already closed (maybe in checkPowerOff)</TD></TR><TR><TD CLASS="l">1223</TD><TD>            // don't delete temp files in this case because</TD></TR><TR><TD CLASS="l">1224</TD><TD>            // the database could be open now (even from within another process)</TD></TR><TR CLASS="c"><TD CLASS="l">1225</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1226</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1227</TD><TD>        if (persistent) {</TD></TR><TR CLASS="c"><TD CLASS="l">1228</TD><TD>            deleteOldTempFiles();</TD></TR><TR><TD CLASS="l">1229</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1230</TD><TD>        if (systemSession != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1231</TD><TD>            systemSession.close();</TD></TR><TR CLASS="c"><TD CLASS="l">1232</TD><TD>            systemSession = null;</TD></TR><TR><TD CLASS="l">1233</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1234</TD><TD>        if (lock != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1235</TD><TD>            if (fileLockMethod == FileLock.LOCK_SERIALIZED) {</TD></TR><TR><TD CLASS="l">1236</TD><TD>                // wait before deleting the .lock file,</TD></TR><TR><TD CLASS="l">1237</TD><TD>                // otherwise other connections can not detect that</TD></TR><TR CLASS="z"><TD CLASS="l">1238</TD><TD>                if (lock.load().containsKey(&#34;changePending&#34;)) {</TD></TR><TR><TD CLASS="l">1239</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1240</TD><TD>                        Thread.sleep((int) (reconnectCheckDelay * 1.1));</TD></TR><TR CLASS="z"><TD CLASS="l">1241</TD><TD>                    } catch (InterruptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1242</TD><TD>                        trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1243</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1244</TD><TD>                }</TD></TR><TR><TD CLASS="l">1245</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1246</TD><TD>            lock.unlock();</TD></TR><TR CLASS="c"><TD CLASS="l">1247</TD><TD>            lock = null;</TD></TR><TR><TD CLASS="l">1248</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="22">1249</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1250</TD><TD> </TD></TR><TR><TD CLASS="l">1251</TD><TD>    private synchronized void closeFiles() {</TD></TR><TR><TD CLASS="l">1252</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">1253</TD><TD>            if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1254</TD><TD>                pageStore.close();</TD></TR><TR CLASS="c"><TD CLASS="l">1255</TD><TD>                pageStore = null;</TD></TR><TR><TD CLASS="l">1256</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1257</TD><TD>        } catch (DbException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1258</TD><TD>            trace.error(e, &#34;close&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="3f">1259</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1260</TD><TD>    }</TD></TR><TR><TD CLASS="l">1261</TD><TD> </TD></TR><TR><TD CLASS="l">1262</TD><TD>    private void checkMetaFree(Session session, int id) {</TD></TR><TR CLASS="c"><TD CLASS="l">1263</TD><TD>        SearchRow r = meta.getTemplateSimpleRow(false);</TD></TR><TR CLASS="c"><TD CLASS="l">1264</TD><TD>        r.setValue(0, ValueInt.get(id));</TD></TR><TR CLASS="c"><TD CLASS="l">1265</TD><TD>        Cursor cursor = metaIdIndex.find(session, r, r);</TD></TR><TR CLASS="c"><TD CLASS="l">1266</TD><TD>        if (cursor.next()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>            DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">1268</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1269</TD><TD>    }</TD></TR><TR><TD CLASS="l">1270</TD><TD> </TD></TR><TR><TD CLASS="l">1271</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1272</TD><TD>     * Allocate a new object id.</TD></TR><TR><TD CLASS="l"><A NAME="4a">1273</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1274</TD><TD>     * @return the id</TD></TR><TR><TD CLASS="l">1275</TD><TD>     */</TD></TR><TR><TD CLASS="l">1276</TD><TD>    public synchronized int allocateObjectId() {</TD></TR><TR CLASS="c"><TD CLASS="l">1277</TD><TD>        int i = objectIds.nextClearBit(0);</TD></TR><TR CLASS="c"><TD CLASS="l">1278</TD><TD>        objectIds.set(i);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="58">1279</A></TD><TD>        return i;</TD></TR><TR><TD CLASS="l">1280</TD><TD>    }</TD></TR><TR><TD CLASS="l">1281</TD><TD> </TD></TR><TR><TD CLASS="l">1282</TD><TD>    public ArrayList&lt;UserAggregate&gt; getAllAggregates() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="59">1283</A></TD><TD>        return New.arrayList(aggregates.values());</TD></TR><TR><TD CLASS="l">1284</TD><TD>    }</TD></TR><TR><TD CLASS="l">1285</TD><TD> </TD></TR><TR><TD CLASS="l">1286</TD><TD>    public ArrayList&lt;Comment&gt; getAllComments() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="62">1287</A></TD><TD>        return New.arrayList(comments.values());</TD></TR><TR><TD CLASS="l">1288</TD><TD>    }</TD></TR><TR><TD CLASS="l">1289</TD><TD> </TD></TR><TR><TD CLASS="l">1290</TD><TD>    public int getAllowLiterals() {</TD></TR><TR CLASS="c"><TD CLASS="l">1291</TD><TD>        if (starting) {</TD></TR><TR CLASS="c"><TD CLASS="l">1292</TD><TD>            return Constants.ALLOW_LITERALS_ALL;</TD></TR><TR><TD CLASS="l">1293</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5a">1294</A></TD><TD>        return allowLiterals;</TD></TR><TR><TD CLASS="l">1295</TD><TD>    }</TD></TR><TR><TD CLASS="l">1296</TD><TD> </TD></TR><TR><TD CLASS="l">1297</TD><TD>    public ArrayList&lt;Right&gt; getAllRights() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5b">1298</A></TD><TD>        return New.arrayList(rights.values());</TD></TR><TR><TD CLASS="l">1299</TD><TD>    }</TD></TR><TR><TD CLASS="l">1300</TD><TD> </TD></TR><TR><TD CLASS="l">1301</TD><TD>    public ArrayList&lt;Role&gt; getAllRoles() {</TD></TR><TR CLASS="c"><TD CLASS="l">1302</TD><TD>        return New.arrayList(roles.values());</TD></TR><TR><TD CLASS="l">1303</TD><TD>    }</TD></TR><TR><TD CLASS="l">1304</TD><TD> </TD></TR><TR><TD CLASS="l">1305</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1306</TD><TD>     * Get all schema objects.</TD></TR><TR><TD CLASS="l"><A NAME="5c">1307</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1308</TD><TD>     * @return all objects of all types</TD></TR><TR><TD CLASS="l">1309</TD><TD>     */</TD></TR><TR><TD CLASS="l">1310</TD><TD>    public ArrayList&lt;SchemaObject&gt; getAllSchemaObjects() {</TD></TR><TR CLASS="c"><TD CLASS="l">1311</TD><TD>        initMetaTables();</TD></TR><TR CLASS="c"><TD CLASS="l">1312</TD><TD>        ArrayList&lt;SchemaObject&gt; list = New.arrayList();</TD></TR><TR CLASS="c"><TD CLASS="l">1313</TD><TD>        for (Schema schema : schemas.values()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1314</TD><TD>            list.addAll(schema.getAll());</TD></TR><TR><TD CLASS="l">1315</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1316</TD><TD>        return list;</TD></TR><TR><TD CLASS="l">1317</TD><TD>    }</TD></TR><TR><TD CLASS="l">1318</TD><TD> </TD></TR><TR><TD CLASS="l">1319</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1320</TD><TD>     * Get all schema objects of the given type.</TD></TR><TR><TD CLASS="l">1321</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="41">1322</A></TD><TD>     * @param type the object type</TD></TR><TR><TD CLASS="l">1323</TD><TD>     * @return all objects of that type</TD></TR><TR><TD CLASS="l">1324</TD><TD>     */</TD></TR><TR><TD CLASS="l">1325</TD><TD>    public ArrayList&lt;SchemaObject&gt; getAllSchemaObjects(int type) {</TD></TR><TR CLASS="c"><TD CLASS="l">1326</TD><TD>        if (type == DbObject.TABLE_OR_VIEW) {</TD></TR><TR CLASS="z"><TD CLASS="l">1327</TD><TD>            initMetaTables();</TD></TR><TR><TD CLASS="l">1328</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1329</TD><TD>        ArrayList&lt;SchemaObject&gt; list = New.arrayList();</TD></TR><TR CLASS="c"><TD CLASS="l">1330</TD><TD>        for (Schema schema : schemas.values()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1331</TD><TD>            list.addAll(schema.getAll(type));</TD></TR><TR><TD CLASS="l">1332</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1333</TD><TD>        return list;</TD></TR><TR><TD CLASS="l">1334</TD><TD>    }</TD></TR><TR><TD CLASS="l">1335</TD><TD> </TD></TR><TR><TD CLASS="l">1336</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1337</TD><TD>     * Get all tables and views.</TD></TR><TR><TD CLASS="l">1338</TD><TD>     *</TD></TR><TR><TD CLASS="l">1339</TD><TD>     * @param includeMeta whether to force including the meta data tables (if</TD></TR><TR><TD CLASS="l">1340</TD><TD>     *            true, metadata tables are always included; if false, metadata</TD></TR><TR><TD CLASS="l"><A NAME="5f">1341</A></TD><TD>     *            tables are only included if they are already initialized)</TD></TR><TR><TD CLASS="l">1342</TD><TD>     * @return all objects of that type</TD></TR><TR><TD CLASS="l">1343</TD><TD>     */</TD></TR><TR><TD CLASS="l">1344</TD><TD>    public ArrayList&lt;Table&gt; getAllTablesAndViews(boolean includeMeta) {</TD></TR><TR CLASS="c"><TD CLASS="l">1345</TD><TD>        if (includeMeta) {</TD></TR><TR CLASS="c"><TD CLASS="l">1346</TD><TD>            initMetaTables();</TD></TR><TR><TD CLASS="l">1347</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1348</TD><TD>        ArrayList&lt;Table&gt; list = New.arrayList();</TD></TR><TR CLASS="c"><TD CLASS="l">1349</TD><TD>        for (Schema schema : schemas.values()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1350</TD><TD>            list.addAll(schema.getAllTablesAndViews());</TD></TR><TR><TD CLASS="l">1351</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5d">1352</A></TD><TD>        return list;</TD></TR><TR><TD CLASS="l">1353</TD><TD>    }</TD></TR><TR><TD CLASS="l">1354</TD><TD> </TD></TR><TR><TD CLASS="l">1355</TD><TD>    public ArrayList&lt;Schema&gt; getAllSchemas() {</TD></TR><TR CLASS="c"><TD CLASS="l">1356</TD><TD>        initMetaTables();</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="5e">1357</A></TD><TD>        return New.arrayList(schemas.values());</TD></TR><TR><TD CLASS="l">1358</TD><TD>    }</TD></TR><TR><TD CLASS="l">1359</TD><TD> </TD></TR><TR><TD CLASS="l">1360</TD><TD>    public ArrayList&lt;Setting&gt; getAllSettings() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="60">1361</A></TD><TD>        return New.arrayList(settings.values());</TD></TR><TR><TD CLASS="l">1362</TD><TD>    }</TD></TR><TR><TD CLASS="l">1363</TD><TD> </TD></TR><TR><TD CLASS="l">1364</TD><TD>    public ArrayList&lt;UserDataType&gt; getAllUserDataTypes() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="61">1365</A></TD><TD>        return New.arrayList(userDataTypes.values());</TD></TR><TR><TD CLASS="l">1366</TD><TD>    }</TD></TR><TR><TD CLASS="l">1367</TD><TD> </TD></TR><TR><TD CLASS="l">1368</TD><TD>    public ArrayList&lt;User&gt; getAllUsers() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="63">1369</A></TD><TD>        return New.arrayList(users.values());</TD></TR><TR><TD CLASS="l">1370</TD><TD>    }</TD></TR><TR><TD CLASS="l">1371</TD><TD> </TD></TR><TR><TD CLASS="l">1372</TD><TD>    public String getCacheType() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="64">1373</A></TD><TD>        return cacheType;</TD></TR><TR><TD CLASS="l">1374</TD><TD>    }</TD></TR><TR><TD CLASS="l">1375</TD><TD> </TD></TR><TR><TD CLASS="l">1376</TD><TD>    public String getCluster() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="65">1377</A></TD><TD>        return cluster;</TD></TR><TR><TD CLASS="l">1378</TD><TD>    }</TD></TR><TR><TD CLASS="l">1379</TD><TD> </TD></TR><TR><TD CLASS="l">1380</TD><TD>    public CompareMode getCompareMode() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="2c">1381</A></TD><TD>        return compareMode;</TD></TR><TR><TD CLASS="l">1382</TD><TD>    }</TD></TR><TR><TD CLASS="l">1383</TD><TD> </TD></TR><TR><TD CLASS="l">1384</TD><TD>    public String getDatabasePath() {</TD></TR><TR CLASS="c"><TD CLASS="l">1385</TD><TD>        if (persistent) {</TD></TR><TR CLASS="c"><TD CLASS="l">1386</TD><TD>            return FileUtils.toRealPath(databaseName);</TD></TR><TR><TD CLASS="l">1387</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="80">1388</A></TD><TD>        return null;</TD></TR><TR><TD CLASS="l">1389</TD><TD>    }</TD></TR><TR><TD CLASS="l">1390</TD><TD> </TD></TR><TR><TD CLASS="l">1391</TD><TD>    public String getShortName() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="78">1392</A></TD><TD>        return databaseShortName;</TD></TR><TR><TD CLASS="l">1393</TD><TD>    }</TD></TR><TR><TD CLASS="l">1394</TD><TD> </TD></TR><TR><TD CLASS="l">1395</TD><TD>    public String getName() {</TD></TR><TR CLASS="c"><TD CLASS="l">1396</TD><TD>        return databaseName;</TD></TR><TR><TD CLASS="l">1397</TD><TD>    }</TD></TR><TR><TD CLASS="l">1398</TD><TD> </TD></TR><TR><TD CLASS="l">1399</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1400</TD><TD>     * Get all sessions that are currently connected to the database.</TD></TR><TR><TD CLASS="l">1401</TD><TD>     *</TD></TR><TR><TD CLASS="l">1402</TD><TD>     * @param includingSystemSession if the system session should also be</TD></TR><TR><TD CLASS="l">1403</TD><TD>     *            included</TD></TR><TR><TD CLASS="l">1404</TD><TD>     * @return the list of sessions</TD></TR><TR><TD CLASS="l">1405</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="37">1406</A></TD><TD>    public Session[] getSessions(boolean includingSystemSession) {</TD></TR><TR><TD CLASS="l">1407</TD><TD>        ArrayList&lt;Session&gt; list;</TD></TR><TR><TD CLASS="l">1408</TD><TD>        // need to synchronized on userSession, otherwise the list</TD></TR><TR><TD CLASS="l">1409</TD><TD>        // may contain null elements</TD></TR><TR CLASS="c"><TD CLASS="l">1410</TD><TD>        synchronized (userSessions) {</TD></TR><TR CLASS="c"><TD CLASS="l">1411</TD><TD>            list = New.arrayList(userSessions);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="71% line coverage (12 out of 17 instructions)">1412</TD><TD TITLE="71% line coverage (12 out of 17 instructions)">        }</TD></TR><TR><TD CLASS="l">1413</TD><TD>        // copy, to ensure the reference is stable</TD></TR><TR CLASS="c"><TD CLASS="l">1414</TD><TD>        Session sys = systemSession;</TD></TR><TR CLASS="c"><TD CLASS="l">1415</TD><TD>        if (includingSystemSession &amp;&amp; sys != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1416</TD><TD>            list.add(sys);</TD></TR><TR><TD CLASS="l">1417</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1418</TD><TD>        Session[] array = new Session[list.size()];</TD></TR><TR CLASS="c"><TD CLASS="l">1419</TD><TD>        list.toArray(array);</TD></TR><TR CLASS="c"><TD CLASS="l">1420</TD><TD>        return array;</TD></TR><TR><TD CLASS="l">1421</TD><TD>    }</TD></TR><TR><TD CLASS="l">1422</TD><TD> </TD></TR><TR><TD CLASS="l">1423</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1424</TD><TD>     * Update an object in the system table.</TD></TR><TR><TD CLASS="l">1425</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="a2">1426</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1427</TD><TD>     * @param obj the database object</TD></TR><TR><TD CLASS="l">1428</TD><TD>     */</TD></TR><TR><TD CLASS="l">1429</TD><TD>    public synchronized void update(Session session, DbObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">1430</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1431</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">1432</TD><TD>        removeMeta(session, id);</TD></TR><TR CLASS="c"><TD CLASS="l">1433</TD><TD>        addMeta(session, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1434</TD><TD>    }</TD></TR><TR><TD CLASS="l">1435</TD><TD> </TD></TR><TR><TD CLASS="l">1436</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1437</TD><TD>     * Rename a schema object.</TD></TR><TR><TD CLASS="l">1438</TD><TD>     *</TD></TR><TR><TD CLASS="l">1439</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l"><A NAME="90">1440</A></TD><TD>     * @param obj the object</TD></TR><TR><TD CLASS="l">1441</TD><TD>     * @param newName the new name</TD></TR><TR><TD CLASS="l">1442</TD><TD>     */</TD></TR><TR><TD CLASS="l">1443</TD><TD>    public synchronized void renameSchemaObject(Session session, SchemaObject obj, String newName) {</TD></TR><TR CLASS="c"><TD CLASS="l">1444</TD><TD>        checkWritingAllowed();</TD></TR><TR CLASS="c"><TD CLASS="l">1445</TD><TD>        obj.getSchema().rename(obj, newName);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="43">1446</A></TD><TD>        updateWithChildren(session, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1447</TD><TD>    }</TD></TR><TR><TD CLASS="l">1448</TD><TD> </TD></TR><TR><TD CLASS="l">1449</TD><TD>    private synchronized void updateWithChildren(Session session, DbObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">1450</TD><TD>        ArrayList&lt;DbObject&gt; list = obj.getChildren();</TD></TR><TR CLASS="c"><TD CLASS="l">1451</TD><TD>        Comment comment = findComment(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1452</TD><TD>        if (comment != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1453</TD><TD>            DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">1454</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1455</TD><TD>        update(session, obj);</TD></TR><TR><TD CLASS="l">1456</TD><TD>        // remember that this scans only one level deep!</TD></TR><TR CLASS="c"><TD CLASS="l">1457</TD><TD>        if (list != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1458</TD><TD>            for (DbObject o : list) {</TD></TR><TR CLASS="c"><TD CLASS="l">1459</TD><TD>                if (o.getCreateSQL() != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1460</TD><TD>                    update(session, o);</TD></TR><TR><TD CLASS="l">1461</TD><TD>                }</TD></TR><TR><TD CLASS="l">1462</TD><TD>            }</TD></TR><TR><TD CLASS="l">1463</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1464</TD><TD>    }</TD></TR><TR><TD CLASS="l">1465</TD><TD> </TD></TR><TR><TD CLASS="l">1466</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1467</TD><TD>     * Rename a database object.</TD></TR><TR><TD CLASS="l">1468</TD><TD>     *</TD></TR><TR><TD CLASS="l">1469</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l"><A NAME="29">1470</A></TD><TD>     * @param obj the object</TD></TR><TR><TD CLASS="l">1471</TD><TD>     * @param newName the new name</TD></TR><TR><TD CLASS="l">1472</TD><TD>     */</TD></TR><TR><TD CLASS="l">1473</TD><TD>    public synchronized void renameDatabaseObject(Session session, DbObject obj, String newName) {</TD></TR><TR CLASS="c"><TD CLASS="l">1474</TD><TD>        checkWritingAllowed();</TD></TR><TR CLASS="c"><TD CLASS="l">1475</TD><TD>        int type = obj.getType();</TD></TR><TR CLASS="c"><TD CLASS="l">1476</TD><TD>        HashMap&lt;String, DbObject&gt; map = getMap(type);</TD></TR><TR CLASS="c"><TD CLASS="l">1477</TD><TD>        if (SysProperties.CHECK) {</TD></TR><TR CLASS="c"><TD CLASS="l">1478</TD><TD>            if (!map.containsKey(obj.getName())) {</TD></TR><TR CLASS="z"><TD CLASS="l">1479</TD><TD>                DbException.throwInternalError(&#34;not found: &#34; + obj.getName());</TD></TR><TR><TD CLASS="l">1480</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1481</TD><TD>            if (obj.getName().equals(newName) || map.containsKey(newName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>                DbException.throwInternalError(&#34;object already exists: &#34; + newName);</TD></TR><TR><TD CLASS="l">1483</TD><TD>            }</TD></TR><TR><TD CLASS="l">1484</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1485</TD><TD>        obj.checkRename();</TD></TR><TR CLASS="c"><TD CLASS="l">1486</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">1487</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1488</TD><TD>        removeMeta(session, id);</TD></TR><TR CLASS="c"><TD CLASS="l">1489</TD><TD>        map.remove(obj.getName());</TD></TR><TR CLASS="c"><TD CLASS="l">1490</TD><TD>        obj.rename(newName);</TD></TR><TR CLASS="c"><TD CLASS="l">1491</TD><TD>        map.put(newName, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1492</TD><TD>        updateWithChildren(session, obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1493</TD><TD>    }</TD></TR><TR><TD CLASS="l">1494</TD><TD> </TD></TR><TR><TD CLASS="l">1495</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1496</TD><TD>     * Create a temporary file in the database folder.</TD></TR><TR><TD CLASS="l">1497</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="1d">1498</A></TD><TD>     * @return the file name</TD></TR><TR><TD CLASS="l">1499</TD><TD>     */</TD></TR><TR><TD CLASS="l">1500</TD><TD>    public String createTempFile() {</TD></TR><TR><TD CLASS="l">1501</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">1502</TD><TD>            boolean inTempDir = readOnly;</TD></TR><TR CLASS="c"><TD CLASS="l">1503</TD><TD>            String name = databaseName;</TD></TR><TR CLASS="c"><TD CLASS="l">1504</TD><TD>            if (!persistent) {</TD></TR><TR CLASS="z"><TD CLASS="l">1505</TD><TD>                name = &#34;memFS:&#34; + name;</TD></TR><TR><TD CLASS="l">1506</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1507</TD><TD>            return FileUtils.createTempFile(name, Constants.SUFFIX_TEMP_FILE, true, inTempDir);</TD></TR><TR CLASS="z"><TD CLASS="l">1508</TD><TD>        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1509</TD><TD>            throw DbException.convertIOException(e, databaseName);</TD></TR><TR><TD CLASS="l"><A NAME="28">1510</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1511</TD><TD>    }</TD></TR><TR><TD CLASS="l">1512</TD><TD> </TD></TR><TR><TD CLASS="l">1513</TD><TD>    private void deleteOldTempFiles() {</TD></TR><TR CLASS="c"><TD CLASS="l">1514</TD><TD>        String path = FileUtils.getParent(databaseName);</TD></TR><TR CLASS="c"><TD CLASS="l">1515</TD><TD>        for (String name : FileUtils.newDirectoryStream(path)) {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="62% line coverage (8 out of 13 instructions)">1516</TD><TD TITLE="62% line coverage (8 out of 13 instructions)">            if (name.endsWith(Constants.SUFFIX_TEMP_FILE) &amp;&amp; name.startsWith(databaseName)) {</TD></TR><TR><TD CLASS="l">1517</TD><TD>                // can't always delete the files, they may still be open</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="25% line coverage (1 out of 4 instructions)">1518</TD><TD TITLE="25% line coverage (1 out of 4 instructions)">                FileUtils.tryDelete(name);</TD></TR><TR><TD CLASS="l">1519</TD><TD>            }</TD></TR><TR><TD CLASS="l">1520</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1521</TD><TD>    }</TD></TR><TR><TD CLASS="l">1522</TD><TD> </TD></TR><TR><TD CLASS="l">1523</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1524</TD><TD>     * Get the schema. If the schema does not exist, an exception is thrown.</TD></TR><TR><TD CLASS="l">1525</TD><TD>     *</TD></TR><TR><TD CLASS="l">1526</TD><TD>     * @param schemaName the name of the schema</TD></TR><TR><TD CLASS="l"><A NAME="24">1527</A></TD><TD>     * @return the schema</TD></TR><TR><TD CLASS="l">1528</TD><TD>     * @throws DbException no schema with that name exists</TD></TR><TR><TD CLASS="l">1529</TD><TD>     */</TD></TR><TR><TD CLASS="l">1530</TD><TD>    public Schema getSchema(String schemaName) {</TD></TR><TR CLASS="c"><TD CLASS="l">1531</TD><TD>        Schema schema = findSchema(schemaName);</TD></TR><TR CLASS="c"><TD CLASS="l">1532</TD><TD>        if (schema == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1533</TD><TD>            throw DbException.get(ErrorCode.SCHEMA_NOT_FOUND_1, schemaName);</TD></TR><TR><TD CLASS="l">1534</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1535</TD><TD>        return schema;</TD></TR><TR><TD CLASS="l">1536</TD><TD>    }</TD></TR><TR><TD CLASS="l">1537</TD><TD> </TD></TR><TR><TD CLASS="l">1538</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1539</TD><TD>     * Remove the object from the database.</TD></TR><TR><TD CLASS="l">1540</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="2b">1541</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1542</TD><TD>     * @param obj the object to remove</TD></TR><TR><TD CLASS="l">1543</TD><TD>     */</TD></TR><TR><TD CLASS="l">1544</TD><TD>    public synchronized void removeDatabaseObject(Session session, DbObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">1545</TD><TD>        checkWritingAllowed();</TD></TR><TR CLASS="c"><TD CLASS="l">1546</TD><TD>        String objName = obj.getName();</TD></TR><TR CLASS="c"><TD CLASS="l">1547</TD><TD>        int type = obj.getType();</TD></TR><TR CLASS="c"><TD CLASS="l">1548</TD><TD>        HashMap&lt;String, DbObject&gt; map = getMap(type);</TD></TR><TR CLASS="c"><TD CLASS="l">1549</TD><TD>        if (SysProperties.CHECK &amp;&amp; !map.containsKey(objName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>            DbException.throwInternalError(&#34;not found: &#34; + objName);</TD></TR><TR><TD CLASS="l">1551</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1552</TD><TD>        Comment comment = findComment(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1553</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1554</TD><TD>        if (comment != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1555</TD><TD>            removeDatabaseObject(session, comment);</TD></TR><TR><TD CLASS="l">1556</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1557</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">1558</TD><TD>        obj.removeChildrenAndResources(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1559</TD><TD>        map.remove(objName);</TD></TR><TR CLASS="c"><TD CLASS="l">1560</TD><TD>        removeMeta(session, id);</TD></TR><TR CLASS="c"><TD CLASS="l">1561</TD><TD>    }</TD></TR><TR><TD CLASS="l">1562</TD><TD> </TD></TR><TR><TD CLASS="l">1563</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1564</TD><TD>     * Get the first table that depends on this object.</TD></TR><TR><TD CLASS="l">1565</TD><TD>     *</TD></TR><TR><TD CLASS="l">1566</TD><TD>     * @param obj the object to find</TD></TR><TR><TD CLASS="l"><A NAME="47">1567</A></TD><TD>     * @param except the table to exclude (or null)</TD></TR><TR><TD CLASS="l">1568</TD><TD>     * @return the first dependent table, or null</TD></TR><TR><TD CLASS="l">1569</TD><TD>     */</TD></TR><TR><TD CLASS="l">1570</TD><TD>    public Table getDependentTable(SchemaObject obj, Table except) {</TD></TR><TR CLASS="c"><TD CLASS="l">1571</TD><TD>        switch (obj.getType()) {</TD></TR><TR><TD CLASS="l">1572</TD><TD>        case DbObject.COMMENT:</TD></TR><TR><TD CLASS="l">1573</TD><TD>        case DbObject.CONSTRAINT:</TD></TR><TR><TD CLASS="l">1574</TD><TD>        case DbObject.INDEX:</TD></TR><TR><TD CLASS="l">1575</TD><TD>        case DbObject.RIGHT:</TD></TR><TR><TD CLASS="l">1576</TD><TD>        case DbObject.TRIGGER:</TD></TR><TR><TD CLASS="l">1577</TD><TD>        case DbObject.USER:</TD></TR><TR CLASS="c"><TD CLASS="l">1578</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">1579</TD><TD>        default:</TD></TR><TR><TD CLASS="l">1580</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1581</TD><TD>        HashSet&lt;DbObject&gt; set = New.hashSet();</TD></TR><TR CLASS="c"><TD CLASS="l">1582</TD><TD>        for (Table t : getAllTablesAndViews(false)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1583</TD><TD>            if (except == t) {</TD></TR><TR CLASS="z"><TD CLASS="l">1584</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">1585</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1586</TD><TD>            set.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">1587</TD><TD>            t.addDependencies(set);</TD></TR><TR CLASS="c"><TD CLASS="l">1588</TD><TD>            if (set.contains(obj)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1589</TD><TD>                return t;</TD></TR><TR><TD CLASS="l">1590</TD><TD>            }</TD></TR><TR><TD CLASS="l">1591</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1592</TD><TD>        return null;</TD></TR><TR><TD CLASS="l">1593</TD><TD>    }</TD></TR><TR><TD CLASS="l">1594</TD><TD> </TD></TR><TR><TD CLASS="l">1595</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1596</TD><TD>     * Remove an object from the system table.</TD></TR><TR><TD CLASS="l">1597</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="46">1598</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1599</TD><TD>     * @param obj the object to be removed</TD></TR><TR><TD CLASS="l">1600</TD><TD>     */</TD></TR><TR><TD CLASS="l">1601</TD><TD>    public synchronized void removeSchemaObject(Session session, SchemaObject obj) {</TD></TR><TR CLASS="c"><TD CLASS="l">1602</TD><TD>        int type = obj.getType();</TD></TR><TR CLASS="c"><TD CLASS="l">1603</TD><TD>        if (type == DbObject.TABLE_OR_VIEW) {</TD></TR><TR CLASS="c"><TD CLASS="l">1604</TD><TD>            Table table = (Table) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">1605</TD><TD>            if (table.isTemporary() &amp;&amp; !table.isGlobalTemporary()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1606</TD><TD>                session.removeLocalTempTable(table);</TD></TR><TR CLASS="c"><TD CLASS="l">1607</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1608</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1609</TD><TD>        } else if (type == DbObject.INDEX) {</TD></TR><TR CLASS="c"><TD CLASS="l">1610</TD><TD>            Index index = (Index) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">1611</TD><TD>            Table table = index.getTable();</TD></TR><TR CLASS="c"><TD CLASS="l">1612</TD><TD>            if (table.isTemporary() &amp;&amp; !table.isGlobalTemporary()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1613</TD><TD>                session.removeLocalTempTableIndex(index);</TD></TR><TR CLASS="c"><TD CLASS="l">1614</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1615</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1616</TD><TD>        } else if (type == DbObject.CONSTRAINT) {</TD></TR><TR CLASS="c"><TD CLASS="l">1617</TD><TD>            Constraint constraint = (Constraint) obj;</TD></TR><TR CLASS="c"><TD CLASS="l">1618</TD><TD>            Table table = constraint.getTable();</TD></TR><TR CLASS="c"><TD CLASS="l">1619</TD><TD>            if (table.isTemporary() &amp;&amp; !table.isGlobalTemporary()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1620</TD><TD>                session.removeLocalTempTableConstraint(constraint);</TD></TR><TR CLASS="c"><TD CLASS="l">1621</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1622</TD><TD>            }</TD></TR><TR><TD CLASS="l">1623</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1624</TD><TD>        checkWritingAllowed();</TD></TR><TR CLASS="c"><TD CLASS="l">1625</TD><TD>        lockMeta(session);</TD></TR><TR CLASS="c"><TD CLASS="l">1626</TD><TD>        Comment comment = findComment(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1627</TD><TD>        if (comment != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1628</TD><TD>            removeDatabaseObject(session, comment);</TD></TR><TR><TD CLASS="l">1629</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1630</TD><TD>        obj.getSchema().remove(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1631</TD><TD>        int id = obj.getId();</TD></TR><TR CLASS="c"><TD CLASS="l">1632</TD><TD>        if (!starting) {</TD></TR><TR CLASS="c"><TD CLASS="l">1633</TD><TD>            Table t = getDependentTable(obj, null);</TD></TR><TR CLASS="c"><TD CLASS="l">1634</TD><TD>            if (t != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1635</TD><TD>                obj.getSchema().add(obj);</TD></TR><TR CLASS="c"><TD CLASS="l">1636</TD><TD>                throw DbException.get(ErrorCode.CANNOT_DROP_2, obj.getSQL(), t.getSQL());</TD></TR><TR><TD CLASS="l">1637</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">1638</TD><TD>            obj.removeChildrenAndResources(session);</TD></TR><TR><TD CLASS="l">1639</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1640</TD><TD>        removeMeta(session, id);</TD></TR><TR CLASS="c"><TD CLASS="l">1641</TD><TD>    }</TD></TR><TR><TD CLASS="l">1642</TD><TD> </TD></TR><TR><TD CLASS="l">1643</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1644</TD><TD>     * Check if this database disk-based.</TD></TR><TR><TD CLASS="l"><A NAME="88">1645</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1646</TD><TD>     * @return true if it is disk-based, false it it is in-memory only.</TD></TR><TR><TD CLASS="l">1647</TD><TD>     */</TD></TR><TR><TD CLASS="l">1648</TD><TD>    public boolean isPersistent() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6">1649</A></TD><TD>        return persistent;</TD></TR><TR><TD CLASS="l">1650</TD><TD>    }</TD></TR><TR><TD CLASS="l">1651</TD><TD> </TD></TR><TR><TD CLASS="l">1652</TD><TD>    public TraceSystem getTraceSystem() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="20">1653</A></TD><TD>        return traceSystem;</TD></TR><TR><TD CLASS="l">1654</TD><TD>    }</TD></TR><TR><TD CLASS="l">1655</TD><TD> </TD></TR><TR><TD CLASS="l">1656</TD><TD>    public synchronized void setCacheSize(int kb) {</TD></TR><TR CLASS="c"><TD CLASS="l">1657</TD><TD>        if (starting) {</TD></TR><TR CLASS="z"><TD CLASS="l">1658</TD><TD>            int max = MathUtils.convertLongToInt(Utils.getMemoryMax()) / 2;</TD></TR><TR CLASS="z"><TD CLASS="l">1659</TD><TD>            kb = Math.min(kb, max);</TD></TR><TR><TD CLASS="l">1660</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1661</TD><TD>        cacheSize = kb;</TD></TR><TR CLASS="c"><TD CLASS="l">1662</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1663</TD><TD>            pageStore.getCache().setMaxMemory(kb);</TD></TR><TR><TD CLASS="l"><A NAME="99">1664</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1665</TD><TD>    }</TD></TR><TR><TD CLASS="l">1666</TD><TD> </TD></TR><TR><TD CLASS="l">1667</TD><TD>    public synchronized void setMasterUser(User user) {</TD></TR><TR CLASS="c"><TD CLASS="l">1668</TD><TD>        lockMeta(systemSession);</TD></TR><TR CLASS="c"><TD CLASS="l">1669</TD><TD>        addDatabaseObject(systemSession, user);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="7c">1670</A></TD><TD>        systemSession.commit(true);</TD></TR><TR CLASS="c"><TD CLASS="l">1671</TD><TD>    }</TD></TR><TR><TD CLASS="l">1672</TD><TD> </TD></TR><TR><TD CLASS="l">1673</TD><TD>    public Role getPublicRole() {</TD></TR><TR CLASS="c"><TD CLASS="l">1674</TD><TD>        return publicRole;</TD></TR><TR><TD CLASS="l">1675</TD><TD>    }</TD></TR><TR><TD CLASS="l">1676</TD><TD> </TD></TR><TR><TD CLASS="l">1677</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1678</TD><TD>     * Get a unique temporary table name.</TD></TR><TR><TD CLASS="l">1679</TD><TD>     *</TD></TR><TR><TD CLASS="l">1680</TD><TD>     * @param baseName the prefix of the returned name</TD></TR><TR><TD CLASS="l">1681</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1682</TD><TD>     * @return a unique name</TD></TR><TR><TD CLASS="l"><A NAME="83">1683</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1684</TD><TD>    public synchronized String getTempTableName(String baseName, Session session) {</TD></TR><TR><TD CLASS="l">1685</TD><TD>        String tempName;</TD></TR><TR><TD CLASS="l">1686</TD><TD>        do {</TD></TR><TR CLASS="c"><TD CLASS="l">1687</TD><TD>            tempName = baseName + &#34;_COPY_&#34; + session.getId() + &#34;_&#34; + nextTempTableId++;</TD></TR><TR CLASS="c"><TD CLASS="l">1688</TD><TD>        } while (mainSchema.findTableOrView(session, tempName) != null);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="94">1689</A></TD><TD>        return tempName;</TD></TR><TR><TD CLASS="l">1690</TD><TD>    }</TD></TR><TR><TD CLASS="l">1691</TD><TD> </TD></TR><TR><TD CLASS="l">1692</TD><TD>    public void setCompareMode(CompareMode compareMode) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="92">1693</A></TD><TD>        this.compareMode = compareMode;</TD></TR><TR CLASS="c"><TD CLASS="l">1694</TD><TD>    }</TD></TR><TR><TD CLASS="l">1695</TD><TD> </TD></TR><TR><TD CLASS="l">1696</TD><TD>    public void setCluster(String cluster) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1c">1697</A></TD><TD>        this.cluster = cluster;</TD></TR><TR CLASS="c"><TD CLASS="l">1698</TD><TD>    }</TD></TR><TR><TD CLASS="l">1699</TD><TD> </TD></TR><TR><TD CLASS="l">1700</TD><TD>    public void checkWritingAllowed() {</TD></TR><TR CLASS="c"><TD CLASS="l">1701</TD><TD>        if (readOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l">1702</TD><TD>            throw DbException.get(ErrorCode.DATABASE_IS_READ_ONLY);</TD></TR><TR><TD CLASS="l">1703</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1704</TD><TD>        if (noDiskSpace) {</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>            throw DbException.get(ErrorCode.NO_DISK_SPACE_AVAILABLE);</TD></TR><TR><TD CLASS="l">1706</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1707</TD><TD>        if (fileLockMethod == FileLock.LOCK_SERIALIZED) {</TD></TR><TR CLASS="z"><TD CLASS="l">1708</TD><TD>            if (!reconnectChangePending) {</TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>                throw DbException.get(ErrorCode.DATABASE_IS_READ_ONLY);</TD></TR><TR><TD CLASS="l">1710</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="89">1711</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1712</TD><TD>    }</TD></TR><TR><TD CLASS="l">1713</TD><TD> </TD></TR><TR><TD CLASS="l">1714</TD><TD>    public boolean isReadOnly() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="44">1715</A></TD><TD>        return readOnly;</TD></TR><TR><TD CLASS="l">1716</TD><TD>    }</TD></TR><TR><TD CLASS="l">1717</TD><TD> </TD></TR><TR><TD CLASS="l">1718</TD><TD>    public void setWriteDelay(int value) {</TD></TR><TR CLASS="c"><TD CLASS="l">1719</TD><TD>        writeDelay = value;</TD></TR><TR CLASS="c"><TD CLASS="l">1720</TD><TD>        if (writer != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1721</TD><TD>            writer.setWriteDelay(value);</TD></TR><TR><TD CLASS="l">1722</TD><TD>            // TODO check if MIN_WRITE_DELAY is a good value</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="92% line coverage (12 out of 13 instructions)">1723</TD><TD TITLE="92% line coverage (12 out of 13 instructions)">            flushOnEachCommit = writeDelay &lt; Constants.MIN_WRITE_DELAY;</TD></TR><TR><TD CLASS="l">1724</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1725</TD><TD>    }</TD></TR><TR><TD CLASS="l">1726</TD><TD> </TD></TR><TR><TD CLASS="l">1727</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1728</TD><TD>     * Check if flush-on-each-commit is enabled.</TD></TR><TR><TD CLASS="l"><A NAME="6a">1729</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1730</TD><TD>     * @return true if it is</TD></TR><TR><TD CLASS="l">1731</TD><TD>     */</TD></TR><TR><TD CLASS="l">1732</TD><TD>    public boolean getFlushOnEachCommit() {</TD></TR><TR CLASS="c"><TD CLASS="l">1733</TD><TD>        return flushOnEachCommit;</TD></TR><TR><TD CLASS="l">1734</TD><TD>    }</TD></TR><TR><TD CLASS="l">1735</TD><TD> </TD></TR><TR><TD CLASS="l">1736</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1737</TD><TD>     * Get the list of in-doubt transactions.</TD></TR><TR><TD CLASS="l"><A NAME="3">1738</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1739</TD><TD>     * @return the list</TD></TR><TR><TD CLASS="l">1740</TD><TD>     */</TD></TR><TR><TD CLASS="l">1741</TD><TD>    public ArrayList&lt;InDoubtTransaction&gt; getInDoubtTransactions() {</TD></TR><TR CLASS="z"><TD CLASS="l">1742</TD><TD>        return pageStore == null ? null : pageStore.getInDoubtTransactions();</TD></TR><TR><TD CLASS="l">1743</TD><TD>    }</TD></TR><TR><TD CLASS="l">1744</TD><TD> </TD></TR><TR><TD CLASS="l">1745</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1746</TD><TD>     * Prepare a transaction.</TD></TR><TR><TD CLASS="l">1747</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="3e">1748</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1749</TD><TD>     * @param transaction the name of the transaction</TD></TR><TR><TD CLASS="l">1750</TD><TD>     */</TD></TR><TR><TD CLASS="l">1751</TD><TD>    synchronized void prepareCommit(Session session, String transaction) {</TD></TR><TR CLASS="c"><TD CLASS="l">1752</TD><TD>        if (readOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1754</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1755</TD><TD>        pageStore.prepareCommit(session, transaction);</TD></TR><TR CLASS="c"><TD CLASS="l">1756</TD><TD>    }</TD></TR><TR><TD CLASS="l">1757</TD><TD> </TD></TR><TR><TD CLASS="l">1758</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1759</TD><TD>     * Commit the current transaction of the given session.</TD></TR><TR><TD CLASS="l"><A NAME="42">1760</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1761</TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">1762</TD><TD>     */</TD></TR><TR><TD CLASS="l">1763</TD><TD>    synchronized void commit(Session session) {</TD></TR><TR CLASS="c"><TD CLASS="l">1764</TD><TD>        if (readOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l">1765</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1766</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1767</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1768</TD><TD>            pageStore.commit(session);</TD></TR><TR><TD CLASS="l">1769</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1770</TD><TD>        session.setAllCommitted();</TD></TR><TR CLASS="c"><TD CLASS="l">1771</TD><TD>    }</TD></TR><TR><TD CLASS="l">1772</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="57">1773</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">1774</TD><TD>     * Flush all pending changes to the transaction log.</TD></TR><TR><TD CLASS="l">1775</TD><TD>     */</TD></TR><TR><TD CLASS="l">1776</TD><TD>    public synchronized void flush() {</TD></TR><TR CLASS="c"><TD CLASS="l">1777</TD><TD>        if (readOnly || pageStore == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1778</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1779</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="a">1780</A></TD><TD>        pageStore.flushLog();</TD></TR><TR CLASS="c"><TD CLASS="l">1781</TD><TD>    }</TD></TR><TR><TD CLASS="l">1782</TD><TD> </TD></TR><TR><TD CLASS="l">1783</TD><TD>    public void setEventListener(DatabaseEventListener eventListener) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1b">1784</A></TD><TD>        this.eventListener = eventListener;</TD></TR><TR CLASS="z"><TD CLASS="l">1785</TD><TD>    }</TD></TR><TR><TD CLASS="l">1786</TD><TD> </TD></TR><TR><TD CLASS="l">1787</TD><TD>    public void setEventListenerClass(String className) {</TD></TR><TR CLASS="c"><TD CLASS="l">1788</TD><TD>        if (className == null || className.length() == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1789</TD><TD>            eventListener = null;</TD></TR><TR><TD CLASS="l">1790</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">1791</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1792</TD><TD>                eventListener = (DatabaseEventListener) Utils.loadUserClass(className).newInstance();</TD></TR><TR CLASS="c"><TD CLASS="l">1793</TD><TD>                String url = databaseURL;</TD></TR><TR CLASS="c"><TD CLASS="l">1794</TD><TD>                if (cipher != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1795</TD><TD>                    url += &#34;;CIPHER=&#34; + cipher;</TD></TR><TR><TD CLASS="l">1796</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">1797</TD><TD>                eventListener.init(url);</TD></TR><TR CLASS="z"><TD CLASS="l">1798</TD><TD>            } catch (Throwable e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1799</TD><TD>                throw DbException.get(ErrorCode.ERROR_SETTING_DATABASE_EVENT_LISTENER_2, e, className, e.toString());</TD></TR><TR CLASS="c"><TD CLASS="l">1800</TD><TD>            }</TD></TR><TR><TD CLASS="l">1801</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1802</TD><TD>    }</TD></TR><TR><TD CLASS="l">1803</TD><TD> </TD></TR><TR><TD CLASS="l">1804</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1805</TD><TD>     * Set the progress of a long running operation.</TD></TR><TR><TD CLASS="l">1806</TD><TD>     * This method calls the {@link DatabaseEventListener} if one is registered.</TD></TR><TR><TD CLASS="l">1807</TD><TD>     *</TD></TR><TR><TD CLASS="l">1808</TD><TD>     * @param state the {@link DatabaseEventListener} state</TD></TR><TR><TD CLASS="l">1809</TD><TD>     * @param name the object name</TD></TR><TR><TD CLASS="l"><A NAME="40">1810</A></TD><TD>     * @param x the current position</TD></TR><TR><TD CLASS="l">1811</TD><TD>     * @param max the highest value</TD></TR><TR><TD CLASS="l">1812</TD><TD>     */</TD></TR><TR><TD CLASS="l">1813</TD><TD>    public void setProgress(int state, String name, int x, int max) {</TD></TR><TR CLASS="c"><TD CLASS="l">1814</TD><TD>        if (eventListener != null) {</TD></TR><TR><TD CLASS="l">1815</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1816</TD><TD>                eventListener.setProgress(state, name, x, max);</TD></TR><TR CLASS="z"><TD CLASS="l">1817</TD><TD>            } catch (Exception e2) {</TD></TR><TR><TD CLASS="l">1818</TD><TD>                // ignore this (user made) exception</TD></TR><TR CLASS="c"><TD CLASS="l">1819</TD><TD>            }</TD></TR><TR><TD CLASS="l">1820</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1821</TD><TD>    }</TD></TR><TR><TD CLASS="l">1822</TD><TD> </TD></TR><TR><TD CLASS="l">1823</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1824</TD><TD>     * This method is called after an exception occurred, to inform the database</TD></TR><TR><TD CLASS="l">1825</TD><TD>     * event listener (if one is set).</TD></TR><TR><TD CLASS="l">1826</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="18">1827</A></TD><TD>     * @param e the exception</TD></TR><TR><TD CLASS="l">1828</TD><TD>     * @param sql the SQL statement</TD></TR><TR><TD CLASS="l">1829</TD><TD>     */</TD></TR><TR><TD CLASS="l">1830</TD><TD>    public void exceptionThrown(SQLException e, String sql) {</TD></TR><TR CLASS="c"><TD CLASS="l">1831</TD><TD>        if (eventListener != null) {</TD></TR><TR><TD CLASS="l">1832</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1833</TD><TD>                eventListener.exceptionThrown(e, sql);</TD></TR><TR CLASS="z"><TD CLASS="l">1834</TD><TD>            } catch (Exception e2) {</TD></TR><TR><TD CLASS="l">1835</TD><TD>                // ignore this (user made) exception</TD></TR><TR CLASS="z"><TD CLASS="l">1836</TD><TD>            }</TD></TR><TR><TD CLASS="l">1837</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1838</TD><TD>    }</TD></TR><TR><TD CLASS="l">1839</TD><TD> </TD></TR><TR><TD CLASS="l">1840</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="11">1841</A></TD><TD>     * Synchronize the files with the file system. This method is called when</TD></TR><TR><TD CLASS="l">1842</TD><TD>     * executing the SQL statement CHECKPOINT SYNC.</TD></TR><TR><TD CLASS="l">1843</TD><TD>     */</TD></TR><TR><TD CLASS="l">1844</TD><TD>    public synchronized void sync() {</TD></TR><TR CLASS="z"><TD CLASS="l">1845</TD><TD>        if (readOnly || pageStore == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1846</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1847</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="72">1848</A></TD><TD>        pageStore.sync();</TD></TR><TR CLASS="z"><TD CLASS="l">1849</TD><TD>    }</TD></TR><TR><TD CLASS="l">1850</TD><TD> </TD></TR><TR><TD CLASS="l">1851</TD><TD>    public int getMaxMemoryRows() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="9b">1852</A></TD><TD>        return maxMemoryRows;</TD></TR><TR><TD CLASS="l">1853</TD><TD>    }</TD></TR><TR><TD CLASS="l">1854</TD><TD> </TD></TR><TR><TD CLASS="l">1855</TD><TD>    public void setMaxMemoryRows(int value) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="9c">1856</A></TD><TD>        this.maxMemoryRows = value;</TD></TR><TR CLASS="c"><TD CLASS="l">1857</TD><TD>    }</TD></TR><TR><TD CLASS="l">1858</TD><TD> </TD></TR><TR><TD CLASS="l">1859</TD><TD>    public void setMaxMemoryUndo(int value) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="73">1860</A></TD><TD>        this.maxMemoryUndo = value;</TD></TR><TR CLASS="c"><TD CLASS="l">1861</TD><TD>    }</TD></TR><TR><TD CLASS="l">1862</TD><TD> </TD></TR><TR><TD CLASS="l">1863</TD><TD>    public int getMaxMemoryUndo() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="19">1864</A></TD><TD>        return maxMemoryUndo;</TD></TR><TR><TD CLASS="l">1865</TD><TD>    }</TD></TR><TR><TD CLASS="l">1866</TD><TD> </TD></TR><TR><TD CLASS="l">1867</TD><TD>    public void setLockMode(int lockMode) {</TD></TR><TR CLASS="c"><TD CLASS="l">1868</TD><TD>        switch (lockMode) {</TD></TR><TR><TD CLASS="l">1869</TD><TD>        case Constants.LOCK_MODE_OFF:</TD></TR><TR CLASS="z"><TD CLASS="l">1870</TD><TD>            if (multiThreaded) {</TD></TR><TR><TD CLASS="l">1871</TD><TD>                // currently the combination of LOCK_MODE=0 and MULTI_THREADED is not supported</TD></TR><TR CLASS="z"><TD CLASS="l">1872</TD><TD>                throw DbException.get(ErrorCode.CANNOT_CHANGE_SETTING_WHEN_OPEN_1, &#34;LOCK_MODE=0 &amp; MULTI_THREADED&#34;);</TD></TR><TR><TD CLASS="l">1873</TD><TD>            }</TD></TR><TR><TD CLASS="l">1874</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1875</TD><TD>        case Constants.LOCK_MODE_READ_COMMITTED:</TD></TR><TR><TD CLASS="l">1876</TD><TD>        case Constants.LOCK_MODE_TABLE:</TD></TR><TR><TD CLASS="l">1877</TD><TD>        case Constants.LOCK_MODE_TABLE_GC:</TD></TR><TR CLASS="c"><TD CLASS="l">1878</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1879</TD><TD>        default:</TD></TR><TR CLASS="z"><TD CLASS="l">1880</TD><TD>            throw DbException.getInvalidValueException(&#34;lock mode&#34;, lockMode);</TD></TR><TR><TD CLASS="l">1881</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="71">1882</A></TD><TD>        this.lockMode = lockMode;</TD></TR><TR CLASS="c"><TD CLASS="l">1883</TD><TD>    }</TD></TR><TR><TD CLASS="l">1884</TD><TD> </TD></TR><TR><TD CLASS="l">1885</TD><TD>    public int getLockMode() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="91">1886</A></TD><TD>        return lockMode;</TD></TR><TR><TD CLASS="l">1887</TD><TD>    }</TD></TR><TR><TD CLASS="l">1888</TD><TD> </TD></TR><TR><TD CLASS="l">1889</TD><TD>    public synchronized void setCloseDelay(int value) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="81">1890</A></TD><TD>        this.closeDelay = value;</TD></TR><TR CLASS="c"><TD CLASS="l">1891</TD><TD>    }</TD></TR><TR><TD CLASS="l">1892</TD><TD> </TD></TR><TR><TD CLASS="l">1893</TD><TD>    public Session getSystemSession() {</TD></TR><TR CLASS="c"><TD CLASS="l">1894</TD><TD>        return systemSession;</TD></TR><TR><TD CLASS="l">1895</TD><TD>    }</TD></TR><TR><TD CLASS="l">1896</TD><TD> </TD></TR><TR><TD CLASS="l">1897</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1898</TD><TD>     * Check if the database is in the process of closing.</TD></TR><TR><TD CLASS="l"><A NAME="85">1899</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1900</TD><TD>     * @return true if the database is closing</TD></TR><TR><TD CLASS="l">1901</TD><TD>     */</TD></TR><TR><TD CLASS="l">1902</TD><TD>    public boolean isClosing() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="9a">1903</A></TD><TD>        return closing;</TD></TR><TR><TD CLASS="l">1904</TD><TD>    }</TD></TR><TR><TD CLASS="l">1905</TD><TD> </TD></TR><TR><TD CLASS="l">1906</TD><TD>    public void setMaxLengthInplaceLob(int value) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="39">1907</A></TD><TD>        this.maxLengthInplaceLob = value;</TD></TR><TR CLASS="c"><TD CLASS="l">1908</TD><TD>    }</TD></TR><TR><TD CLASS="l">1909</TD><TD> </TD></TR><TR><TD CLASS="l">1910</TD><TD>    public int getMaxLengthInplaceLob() {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="88% line coverage (7 out of 8 instructions)"><A NAME="97">1911</A></TD><TD TITLE="88% line coverage (7 out of 8 instructions)">        return persistent ? maxLengthInplaceLob : Integer.MAX_VALUE;</TD></TR><TR><TD CLASS="l">1912</TD><TD>    }</TD></TR><TR><TD CLASS="l">1913</TD><TD> </TD></TR><TR><TD CLASS="l">1914</TD><TD>    public void setIgnoreCase(boolean b) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6b">1915</A></TD><TD>        ignoreCase = b;</TD></TR><TR CLASS="c"><TD CLASS="l">1916</TD><TD>    }</TD></TR><TR><TD CLASS="l">1917</TD><TD> </TD></TR><TR><TD CLASS="l">1918</TD><TD>    public boolean getIgnoreCase() {</TD></TR><TR CLASS="c"><TD CLASS="l">1919</TD><TD>        if (starting) {</TD></TR><TR><TD CLASS="l">1920</TD><TD>            // tables created at startup must not be converted to ignorecase</TD></TR><TR CLASS="c"><TD CLASS="l">1921</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">1922</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="95">1923</A></TD><TD>        return ignoreCase;</TD></TR><TR><TD CLASS="l">1924</TD><TD>    }</TD></TR><TR><TD CLASS="l">1925</TD><TD> </TD></TR><TR><TD CLASS="l">1926</TD><TD>    public synchronized void setDeleteFilesOnDisconnect(boolean b) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6d">1927</A></TD><TD>        this.deleteFilesOnDisconnect = b;</TD></TR><TR CLASS="c"><TD CLASS="l">1928</TD><TD>    }</TD></TR><TR><TD CLASS="l">1929</TD><TD> </TD></TR><TR><TD CLASS="l">1930</TD><TD>    public String getLobCompressionAlgorithm(int type) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="98">1931</A></TD><TD>        return lobCompressionAlgorithm;</TD></TR><TR><TD CLASS="l">1932</TD><TD>    }</TD></TR><TR><TD CLASS="l">1933</TD><TD> </TD></TR><TR><TD CLASS="l">1934</TD><TD>    public void setLobCompressionAlgorithm(String stringValue) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="d">1935</A></TD><TD>        this.lobCompressionAlgorithm = stringValue;</TD></TR><TR CLASS="c"><TD CLASS="l">1936</TD><TD>    }</TD></TR><TR><TD CLASS="l">1937</TD><TD> </TD></TR><TR><TD CLASS="l">1938</TD><TD>    public synchronized void setMaxLogSize(long value) {</TD></TR><TR CLASS="z"><TD CLASS="l">1939</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1940</TD><TD>            pageStore.setMaxLogSize(value);</TD></TR><TR><TD CLASS="l"><A NAME="8">1941</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1942</TD><TD>    }</TD></TR><TR><TD CLASS="l">1943</TD><TD> </TD></TR><TR><TD CLASS="l">1944</TD><TD>    public void setAllowLiterals(int value) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7b">1945</A></TD><TD>        this.allowLiterals = value;</TD></TR><TR CLASS="z"><TD CLASS="l">1946</TD><TD>    }</TD></TR><TR><TD CLASS="l">1947</TD><TD> </TD></TR><TR><TD CLASS="l">1948</TD><TD>    public boolean getOptimizeReuseResults() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="e">1949</A></TD><TD>        return optimizeReuseResults;</TD></TR><TR><TD CLASS="l">1950</TD><TD>    }</TD></TR><TR><TD CLASS="l">1951</TD><TD> </TD></TR><TR><TD CLASS="l">1952</TD><TD>    public void setOptimizeReuseResults(boolean b) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="70">1953</A></TD><TD>        optimizeReuseResults = b;</TD></TR><TR CLASS="z"><TD CLASS="l">1954</TD><TD>    }</TD></TR><TR><TD CLASS="l">1955</TD><TD> </TD></TR><TR><TD CLASS="l">1956</TD><TD>    public Object getLobSyncObject() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="7e">1957</A></TD><TD>        return lobSyncObject;</TD></TR><TR><TD CLASS="l">1958</TD><TD>    }</TD></TR><TR><TD CLASS="l">1959</TD><TD> </TD></TR><TR><TD CLASS="l">1960</TD><TD>    public int getSessionCount() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="a0">1961</A></TD><TD>        return userSessions.size();</TD></TR><TR><TD CLASS="l">1962</TD><TD>    }</TD></TR><TR><TD CLASS="l">1963</TD><TD> </TD></TR><TR><TD CLASS="l">1964</TD><TD>    public void setReferentialIntegrity(boolean b) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="7d">1965</A></TD><TD>        referentialIntegrity = b;</TD></TR><TR CLASS="c"><TD CLASS="l">1966</TD><TD>    }</TD></TR><TR><TD CLASS="l">1967</TD><TD> </TD></TR><TR><TD CLASS="l">1968</TD><TD>    public boolean getReferentialIntegrity() {</TD></TR><TR CLASS="c"><TD CLASS="l">1969</TD><TD>        return referentialIntegrity;</TD></TR><TR><TD CLASS="l">1970</TD><TD>    }</TD></TR><TR><TD CLASS="l">1971</TD><TD> </TD></TR><TR><TD CLASS="l">1972</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1973</TD><TD>     * Check if the database is currently opening. This is true until all stored</TD></TR><TR><TD CLASS="l">1974</TD><TD>     * SQL statements have been executed.</TD></TR><TR><TD CLASS="l"><A NAME="8a">1975</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1976</TD><TD>     * @return true if the database is still starting</TD></TR><TR><TD CLASS="l">1977</TD><TD>     */</TD></TR><TR><TD CLASS="l">1978</TD><TD>    public boolean isStarting() {</TD></TR><TR CLASS="c"><TD CLASS="l">1979</TD><TD>        return starting;</TD></TR><TR><TD CLASS="l">1980</TD><TD>    }</TD></TR><TR><TD CLASS="l">1981</TD><TD> </TD></TR><TR><TD CLASS="l">1982</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1983</TD><TD>     * Check if multi version concurrency is enabled for this database.</TD></TR><TR><TD CLASS="l"><A NAME="87">1984</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1985</TD><TD>     * @return true if it is enabled</TD></TR><TR><TD CLASS="l">1986</TD><TD>     */</TD></TR><TR><TD CLASS="l">1987</TD><TD>    public boolean isMultiVersion() {</TD></TR><TR CLASS="c"><TD CLASS="l">1988</TD><TD>        return multiVersion;</TD></TR><TR><TD CLASS="l">1989</TD><TD>    }</TD></TR><TR><TD CLASS="l">1990</TD><TD> </TD></TR><TR><TD CLASS="l">1991</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="8e">1992</A></TD><TD>     * Called after the database has been opened and initialized. This method</TD></TR><TR><TD CLASS="l">1993</TD><TD>     * notifies the event listener if one has been set.</TD></TR><TR><TD CLASS="l">1994</TD><TD>     */</TD></TR><TR><TD CLASS="l">1995</TD><TD>    void opened() {</TD></TR><TR CLASS="c"><TD CLASS="l">1996</TD><TD>        if (eventListener != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1997</TD><TD>            eventListener.opened();</TD></TR><TR><TD CLASS="l">1998</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1999</TD><TD>        if (writer != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2000</TD><TD>            writer.startThread();</TD></TR><TR><TD CLASS="l"><A NAME="9e">2001</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2002</TD><TD>    }</TD></TR><TR><TD CLASS="l">2003</TD><TD> </TD></TR><TR><TD CLASS="l">2004</TD><TD>    public void setMode(Mode mode) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="75">2005</A></TD><TD>        this.mode = mode;</TD></TR><TR CLASS="c"><TD CLASS="l">2006</TD><TD>    }</TD></TR><TR><TD CLASS="l">2007</TD><TD> </TD></TR><TR><TD CLASS="l">2008</TD><TD>    public Mode getMode() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="86">2009</A></TD><TD>        return mode;</TD></TR><TR><TD CLASS="l">2010</TD><TD>    }</TD></TR><TR><TD CLASS="l">2011</TD><TD> </TD></TR><TR><TD CLASS="l">2012</TD><TD>    public boolean isMultiThreaded() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="26">2013</A></TD><TD>        return multiThreaded;</TD></TR><TR><TD CLASS="l">2014</TD><TD>    }</TD></TR><TR><TD CLASS="l">2015</TD><TD> </TD></TR><TR><TD CLASS="l">2016</TD><TD>    public void setMultiThreaded(boolean multiThreaded) {</TD></TR><TR CLASS="c"><TD CLASS="l">2017</TD><TD>        if (multiThreaded &amp;&amp; this.multiThreaded != multiThreaded) {</TD></TR><TR CLASS="c"><TD CLASS="l">2018</TD><TD>            if (multiVersion) {</TD></TR><TR><TD CLASS="l">2019</TD><TD>                // currently the combination of MVCC and MULTI_THREADED is not supported</TD></TR><TR CLASS="z"><TD CLASS="l">2020</TD><TD>                throw DbException.get(ErrorCode.CANNOT_CHANGE_SETTING_WHEN_OPEN_1, &#34;MVCC &amp; MULTI_THREADED&#34;);</TD></TR><TR><TD CLASS="l">2021</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2022</TD><TD>            if (lockMode == 0) {</TD></TR><TR><TD CLASS="l">2023</TD><TD>                // currently the combination of LOCK_MODE=0 and MULTI_THREADED is not supported</TD></TR><TR CLASS="z"><TD CLASS="l">2024</TD><TD>                throw DbException.get(ErrorCode.CANNOT_CHANGE_SETTING_WHEN_OPEN_1, &#34;LOCK_MODE=0 &amp; MULTI_THREADED&#34;);</TD></TR><TR><TD CLASS="l">2025</TD><TD>            }</TD></TR><TR><TD CLASS="l">2026</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="9d">2027</A></TD><TD>        this.multiThreaded = multiThreaded;</TD></TR><TR CLASS="c"><TD CLASS="l">2028</TD><TD>    }</TD></TR><TR><TD CLASS="l">2029</TD><TD> </TD></TR><TR><TD CLASS="l">2030</TD><TD>    public void setMaxOperationMemory(int maxOperationMemory) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="74">2031</A></TD><TD>        this.maxOperationMemory  = maxOperationMemory;</TD></TR><TR CLASS="c"><TD CLASS="l">2032</TD><TD>    }</TD></TR><TR><TD CLASS="l">2033</TD><TD> </TD></TR><TR><TD CLASS="l">2034</TD><TD>    public int getMaxOperationMemory() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="68">2035</A></TD><TD>        return maxOperationMemory;</TD></TR><TR><TD CLASS="l">2036</TD><TD>    }</TD></TR><TR><TD CLASS="l">2037</TD><TD> </TD></TR><TR><TD CLASS="l">2038</TD><TD>    public Session getExclusiveSession() {</TD></TR><TR CLASS="c"><TD CLASS="l">2039</TD><TD>        return exclusiveSession;</TD></TR><TR><TD CLASS="l">2040</TD><TD>    }</TD></TR><TR><TD CLASS="l">2041</TD><TD> </TD></TR><TR><TD CLASS="l">2042</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2043</TD><TD>     * Set the session that can exclusively access the database.</TD></TR><TR><TD CLASS="l">2044</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="96">2045</A></TD><TD>     * @param session the session</TD></TR><TR><TD CLASS="l">2046</TD><TD>     * @param closeOthers whether other sessions are closed</TD></TR><TR><TD CLASS="l">2047</TD><TD>     */</TD></TR><TR><TD CLASS="l">2048</TD><TD>    public void setExclusiveSession(Session session, boolean closeOthers) {</TD></TR><TR CLASS="c"><TD CLASS="l">2049</TD><TD>        this.exclusiveSession = session;</TD></TR><TR CLASS="c"><TD CLASS="l">2050</TD><TD>        if (closeOthers) {</TD></TR><TR CLASS="c"><TD CLASS="l">2051</TD><TD>            closeAllSessionsException(session);</TD></TR><TR><TD CLASS="l"><A NAME="4">2052</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2053</TD><TD>    }</TD></TR><TR><TD CLASS="l">2054</TD><TD> </TD></TR><TR><TD CLASS="l">2055</TD><TD>    public SmallLRUCache&lt;String, String[]&gt; getLobFileListCache() {</TD></TR><TR CLASS="z"><TD CLASS="l">2056</TD><TD>        if (lobFileListCache == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2057</TD><TD>            lobFileListCache = SmallLRUCache.newInstance(128);</TD></TR><TR><TD CLASS="l">2058</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2059</TD><TD>        return lobFileListCache;</TD></TR><TR><TD CLASS="l">2060</TD><TD>    }</TD></TR><TR><TD CLASS="l">2061</TD><TD> </TD></TR><TR><TD CLASS="l">2062</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2063</TD><TD>     * Checks if the system table (containing the catalog) is locked.</TD></TR><TR><TD CLASS="l"><A NAME="8b">2064</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">2065</TD><TD>     * @return true if it is currently locked</TD></TR><TR><TD CLASS="l">2066</TD><TD>     */</TD></TR><TR><TD CLASS="l">2067</TD><TD>    public boolean isSysTableLocked() {</TD></TR><TR CLASS="c"><TD CLASS="l">2068</TD><TD>        return meta == null || meta.isLockedExclusively();</TD></TR><TR><TD CLASS="l">2069</TD><TD>    }</TD></TR><TR><TD CLASS="l">2070</TD><TD> </TD></TR><TR><TD CLASS="l">2071</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2072</TD><TD>     * Open a new connection or get an existing connection to another database.</TD></TR><TR><TD CLASS="l">2073</TD><TD>     *</TD></TR><TR><TD CLASS="l">2074</TD><TD>     * @param driver the database driver or null</TD></TR><TR><TD CLASS="l">2075</TD><TD>     * @param url the database URL</TD></TR><TR><TD CLASS="l">2076</TD><TD>     * @param user the user name</TD></TR><TR><TD CLASS="l"><A NAME="6c">2077</A></TD><TD>     * @param password the password</TD></TR><TR><TD CLASS="l">2078</TD><TD>     * @return the connection</TD></TR><TR><TD CLASS="l">2079</TD><TD>     */</TD></TR><TR><TD CLASS="l">2080</TD><TD>    public TableLinkConnection getLinkConnection(String driver, String url, String user, String password) {</TD></TR><TR CLASS="c"><TD CLASS="l">2081</TD><TD>        if (linkConnections == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2082</TD><TD>            linkConnections = New.hashMap();</TD></TR><TR><TD CLASS="l">2083</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="12">2084</A></TD><TD>        return TableLinkConnection.open(linkConnections, driver, url, user, password, dbSettings.shareLinkedConnections);</TD></TR><TR><TD CLASS="l">2085</TD><TD>    }</TD></TR><TR><TD CLASS="l">2086</TD><TD> </TD></TR><TR><TD CLASS="l">2087</TD><TD>    public String toString() {</TD></TR><TR CLASS="z"><TD CLASS="l">2088</TD><TD>        return databaseShortName + &#34;:&#34; + super.toString();</TD></TR><TR><TD CLASS="l">2089</TD><TD>    }</TD></TR><TR><TD CLASS="l">2090</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1a">2091</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2092</TD><TD>     * Immediately close the database.</TD></TR><TR><TD CLASS="l">2093</TD><TD>     */</TD></TR><TR><TD CLASS="l">2094</TD><TD>    public void shutdownImmediately() {</TD></TR><TR CLASS="z"><TD CLASS="l">2095</TD><TD>        setPowerOffCount(1);</TD></TR><TR><TD CLASS="l">2096</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2097</TD><TD>            checkPowerOff();</TD></TR><TR CLASS="c"><TD CLASS="l">2098</TD><TD>        } catch (DbException e) {</TD></TR><TR><TD CLASS="l">2099</TD><TD>            // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">2100</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="82">2101</A></TD><TD>        closeFiles();</TD></TR><TR CLASS="c"><TD CLASS="l">2102</TD><TD>    }</TD></TR><TR><TD CLASS="l">2103</TD><TD> </TD></TR><TR><TD CLASS="l">2104</TD><TD>    public TempFileDeleter getTempFileDeleter() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="30">2105</A></TD><TD>        return tempFileDeleter;</TD></TR><TR><TD CLASS="l">2106</TD><TD>    }</TD></TR><TR><TD CLASS="l">2107</TD><TD> </TD></TR><TR><TD CLASS="l">2108</TD><TD>    public PageStore getPageStore() {</TD></TR><TR CLASS="c"><TD CLASS="l">2109</TD><TD>        if (pageStore == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2110</TD><TD>            pageStore = new PageStore(this, databaseName + Constants.SUFFIX_PAGE_FILE, accessModeData, cacheSize);</TD></TR><TR CLASS="c"><TD CLASS="l">2111</TD><TD>            if (pageSize != Constants.DEFAULT_PAGE_SIZE) {</TD></TR><TR CLASS="z"><TD CLASS="l">2112</TD><TD>                pageStore.setPageSize(pageSize);</TD></TR><TR><TD CLASS="l">2113</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2114</TD><TD>            if (!readOnly &amp;&amp; fileLockMethod == FileLock.LOCK_FS) {</TD></TR><TR CLASS="z"><TD CLASS="l">2115</TD><TD>                pageStore.setLockFile(true);</TD></TR><TR><TD CLASS="l">2116</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2117</TD><TD>            pageStore.setLogMode(logMode);</TD></TR><TR CLASS="c"><TD CLASS="l">2118</TD><TD>            pageStore.open();</TD></TR><TR><TD CLASS="l">2119</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2120</TD><TD>        return pageStore;</TD></TR><TR><TD CLASS="l">2121</TD><TD>    }</TD></TR><TR><TD CLASS="l">2122</TD><TD> </TD></TR><TR><TD CLASS="l">2123</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2124</TD><TD>     * Get the first user defined table.</TD></TR><TR><TD CLASS="l"><A NAME="69">2125</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">2126</TD><TD>     * @return the table or null if no table is defined</TD></TR><TR><TD CLASS="l">2127</TD><TD>     */</TD></TR><TR><TD CLASS="l">2128</TD><TD>    public Table getFirstUserTable() {</TD></TR><TR CLASS="c"><TD CLASS="l">2129</TD><TD>        for (Table table : getAllTablesAndViews(false)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2130</TD><TD>            if (table.getCreateSQL() != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2131</TD><TD>                if (table.isHidden()) {</TD></TR><TR><TD CLASS="l">2132</TD><TD>                    // LOB tables</TD></TR><TR CLASS="c"><TD CLASS="l">2133</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">2134</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">2135</TD><TD>                return table;</TD></TR><TR><TD CLASS="l">2136</TD><TD>            }</TD></TR><TR><TD CLASS="l">2137</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2138</TD><TD>        return null;</TD></TR><TR><TD CLASS="l">2139</TD><TD>    }</TD></TR><TR><TD CLASS="l">2140</TD><TD> </TD></TR><TR><TD CLASS="l">2141</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2142</TD><TD>     * Check if the contents of the database was changed and therefore it is</TD></TR><TR><TD CLASS="l">2143</TD><TD>     * required to re-connect. This method waits until pending changes are</TD></TR><TR><TD CLASS="l">2144</TD><TD>     * completed. If a pending change takes too long (more than 2 seconds), the</TD></TR><TR><TD CLASS="l">2145</TD><TD>     * pending change is broken (removed from the properties file).</TD></TR><TR><TD CLASS="l"><A NAME="13">2146</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">2147</TD><TD>     * @return true if reconnecting is required</TD></TR><TR><TD CLASS="l">2148</TD><TD>     */</TD></TR><TR><TD CLASS="l">2149</TD><TD>    public boolean isReconnectNeeded() {</TD></TR><TR CLASS="c"><TD CLASS="l">2150</TD><TD>        if (fileLockMethod != FileLock.LOCK_SERIALIZED) {</TD></TR><TR CLASS="c"><TD CLASS="l">2151</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">2152</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2153</TD><TD>        if (reconnectChangePending) {</TD></TR><TR CLASS="z"><TD CLASS="l">2154</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">2155</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2156</TD><TD>        long now = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2157</TD><TD>        if (now &lt; reconnectCheckNext) {</TD></TR><TR CLASS="z"><TD CLASS="l">2158</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">2159</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2160</TD><TD>        reconnectCheckNext = now + reconnectCheckDelay;</TD></TR><TR CLASS="z"><TD CLASS="l">2161</TD><TD>        if (lock == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2162</TD><TD>            lock = new FileLock(traceSystem, databaseName + Constants.SUFFIX_LOCK_FILE, Constants.LOCK_SLEEP);</TD></TR><TR><TD CLASS="l">2163</TD><TD>        }</TD></TR><TR><TD CLASS="l">2164</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2165</TD><TD>            Properties prop = lock.load(), first = prop;</TD></TR><TR><TD CLASS="l">2166</TD><TD>            while (true) {</TD></TR><TR CLASS="z"><TD CLASS="l">2167</TD><TD>                if (prop.equals(reconnectLastLock)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2168</TD><TD>                    return false;</TD></TR><TR><TD CLASS="l">2169</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2170</TD><TD>                if (prop.getProperty(&#34;changePending&#34;, null) == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2171</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">2172</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2173</TD><TD>                if (System.currentTimeMillis() &gt; now + reconnectCheckDelay * 10) {</TD></TR><TR CLASS="z"><TD CLASS="l">2174</TD><TD>                    if (first.equals(prop)) {</TD></TR><TR><TD CLASS="l">2175</TD><TD>                        // the writing process didn't update the file -</TD></TR><TR><TD CLASS="l">2176</TD><TD>                        // it may have terminated</TD></TR><TR CLASS="z"><TD CLASS="l">2177</TD><TD>                        lock.setProperty(&#34;changePending&#34;, null);</TD></TR><TR CLASS="z"><TD CLASS="l">2178</TD><TD>                        lock.save();</TD></TR><TR CLASS="z"><TD CLASS="l">2179</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2180</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2181</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2182</TD><TD>                trace.debug(&#34;delay (change pending)&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2183</TD><TD>                Thread.sleep(reconnectCheckDelay);</TD></TR><TR CLASS="z"><TD CLASS="l">2184</TD><TD>                prop = lock.load();</TD></TR><TR><TD CLASS="l">2185</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2186</TD><TD>            reconnectLastLock = prop;</TD></TR><TR CLASS="z"><TD CLASS="l">2187</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2188</TD><TD>            // DbException, InterruptedException</TD></TR><TR CLASS="z"><TD CLASS="l">2189</TD><TD>            trace.error(e, &#34;readOnly {0}&#34;, readOnly);</TD></TR><TR><TD CLASS="l">2190</TD><TD>            // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">2191</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2192</TD><TD>        return true;</TD></TR><TR><TD CLASS="l">2193</TD><TD>    }</TD></TR><TR><TD CLASS="l">2194</TD><TD> </TD></TR><TR><TD CLASS="l">2195</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2196</TD><TD>     * Flush all changes when using the serialized mode, and if there are</TD></TR><TR><TD CLASS="l">2197</TD><TD>     * pending changes, and some time has passed. This switches to a new</TD></TR><TR><TD CLASS="l"><A NAME="1">2198</A></TD><TD>     * transaction log and resets the change pending flag in</TD></TR><TR><TD CLASS="l">2199</TD><TD>     * the .lock.db file.</TD></TR><TR><TD CLASS="l">2200</TD><TD>     */</TD></TR><TR><TD CLASS="l">2201</TD><TD>    public void checkpointIfRequired() {</TD></TR><TR CLASS="z"><TD CLASS="l">2202</TD><TD>        if (fileLockMethod != FileLock.LOCK_SERIALIZED || readOnly || !reconnectChangePending || closing) {</TD></TR><TR CLASS="z"><TD CLASS="l">2203</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2204</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2205</TD><TD>        long now = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2206</TD><TD>        if (now &gt; reconnectCheckNext + reconnectCheckDelay) {</TD></TR><TR CLASS="z"><TD CLASS="l">2207</TD><TD>            if (SysProperties.CHECK &amp;&amp; checkpointAllowed &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2208</TD><TD>                DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">2209</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>            synchronized (reconnectSync) {</TD></TR><TR CLASS="z"><TD CLASS="l">2211</TD><TD>                if (checkpointAllowed &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2212</TD><TD>                    return;</TD></TR><TR><TD CLASS="l">2213</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2214</TD><TD>                checkpointRunning = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2215</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2216</TD><TD>            synchronized (this) {</TD></TR><TR CLASS="z"><TD CLASS="l">2217</TD><TD>                trace.debug(&#34;checkpoint start&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2218</TD><TD>                flushSequences();</TD></TR><TR CLASS="z"><TD CLASS="l">2219</TD><TD>                checkpoint();</TD></TR><TR CLASS="z"><TD CLASS="l">2220</TD><TD>                reconnectModified(false);</TD></TR><TR CLASS="z"><TD CLASS="l">2221</TD><TD>                trace.debug(&#34;checkpoint end&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2222</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2223</TD><TD>            synchronized (reconnectSync) {</TD></TR><TR CLASS="z"><TD CLASS="l">2224</TD><TD>                checkpointRunning = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2225</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="2a">2226</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2227</TD><TD>    }</TD></TR><TR><TD CLASS="l">2228</TD><TD> </TD></TR><TR><TD CLASS="l">2229</TD><TD>    public boolean isFileLockSerialized() {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="75% line coverage (6 out of 8 instructions)"><A NAME="2">2230</A></TD><TD TITLE="75% line coverage (6 out of 8 instructions)">        return fileLockMethod == FileLock.LOCK_SERIALIZED;</TD></TR><TR><TD CLASS="l">2231</TD><TD>    }</TD></TR><TR><TD CLASS="l">2232</TD><TD> </TD></TR><TR><TD CLASS="l">2233</TD><TD>    private void flushSequences() {</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>        for (SchemaObject obj : getAllSchemaObjects(DbObject.SEQUENCE)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2235</TD><TD>            Sequence sequence = (Sequence) obj;</TD></TR><TR CLASS="z"><TD CLASS="l">2236</TD><TD>            sequence.flushWithoutMargin();</TD></TR><TR CLASS="z"><TD CLASS="l">2237</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2238</TD><TD>    }</TD></TR><TR><TD CLASS="l">2239</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2f">2240</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2241</TD><TD>     * Flush all changes and open a new transaction log.</TD></TR><TR><TD CLASS="l">2242</TD><TD>     */</TD></TR><TR><TD CLASS="l">2243</TD><TD>    public void checkpoint() {</TD></TR><TR CLASS="c"><TD CLASS="l">2244</TD><TD>        if (persistent) {</TD></TR><TR CLASS="c"><TD CLASS="l">2245</TD><TD>            synchronized (this) {</TD></TR><TR CLASS="c"><TD CLASS="l">2246</TD><TD>                if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2247</TD><TD>                    pageStore.checkpoint();</TD></TR><TR><TD CLASS="l">2248</TD><TD>                }</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="38% line coverage (3 out of 8 instructions)">2249</TD><TD TITLE="38% line coverage (3 out of 8 instructions)">            }</TD></TR><TR><TD CLASS="l">2250</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2251</TD><TD>        getTempFileDeleter().deleteUnused();</TD></TR><TR CLASS="c"><TD CLASS="l">2252</TD><TD>    }</TD></TR><TR><TD CLASS="l">2253</TD><TD> </TD></TR><TR><TD CLASS="l">2254</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2255</TD><TD>     * This method is called before writing to the transaction log.</TD></TR><TR><TD CLASS="l">2256</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="15">2257</A></TD><TD>     * @return true if the call was successful and writing is allowed,</TD></TR><TR><TD CLASS="l">2258</TD><TD>     *          false if another connection was faster</TD></TR><TR><TD CLASS="l">2259</TD><TD>     */</TD></TR><TR><TD CLASS="l">2260</TD><TD>    public boolean beforeWriting() {</TD></TR><TR CLASS="c"><TD CLASS="l">2261</TD><TD>        if (fileLockMethod != FileLock.LOCK_SERIALIZED) {</TD></TR><TR CLASS="c"><TD CLASS="l">2262</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">2263</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2264</TD><TD>        while (checkpointRunning) {</TD></TR><TR><TD CLASS="l">2265</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2266</TD><TD>                Thread.sleep(10 + (int) (Math.random() * 10));</TD></TR><TR CLASS="z"><TD CLASS="l">2267</TD><TD>            } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2268</TD><TD>                // ignore InterruptedException</TD></TR><TR CLASS="z"><TD CLASS="l">2269</TD><TD>            }</TD></TR><TR><TD CLASS="l">2270</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2271</TD><TD>        synchronized (reconnectSync) {</TD></TR><TR CLASS="z"><TD CLASS="l">2272</TD><TD>            if (reconnectModified(true)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2273</TD><TD>                checkpointAllowed++;</TD></TR><TR CLASS="z"><TD CLASS="l">2274</TD><TD>                if (SysProperties.CHECK &amp;&amp; checkpointAllowed &gt; 20) {</TD></TR><TR CLASS="z"><TD CLASS="l">2275</TD><TD>                    throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">2276</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2277</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">2278</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2279</TD><TD>        }</TD></TR><TR><TD CLASS="l">2280</TD><TD>        // make sure the next call to isReconnectNeeded() returns true</TD></TR><TR CLASS="z"><TD CLASS="l">2281</TD><TD>        reconnectCheckNext = System.currentTimeMillis() - 1;</TD></TR><TR CLASS="z"><TD CLASS="l">2282</TD><TD>        reconnectLastLock = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2283</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">2284</TD><TD>    }</TD></TR><TR><TD CLASS="l">2285</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="16">2286</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2287</TD><TD>     * This method is called after updates are finished.</TD></TR><TR><TD CLASS="l">2288</TD><TD>     */</TD></TR><TR><TD CLASS="l">2289</TD><TD>    public void afterWriting() {</TD></TR><TR CLASS="c"><TD CLASS="l">2290</TD><TD>        if (fileLockMethod != FileLock.LOCK_SERIALIZED) {</TD></TR><TR CLASS="c"><TD CLASS="l">2291</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2292</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2293</TD><TD>        synchronized (reconnectSync) {</TD></TR><TR CLASS="z"><TD CLASS="l">2294</TD><TD>            checkpointAllowed--;</TD></TR><TR CLASS="z"><TD CLASS="l">2295</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2296</TD><TD>        if (SysProperties.CHECK &amp;&amp; checkpointAllowed &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2297</TD><TD>            throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">2298</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2299</TD><TD>    }</TD></TR><TR><TD CLASS="l">2300</TD><TD> </TD></TR><TR><TD CLASS="l">2301</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2302</TD><TD>     * Switch the database to read-only mode.</TD></TR><TR><TD CLASS="l"><A NAME="f">2303</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">2304</TD><TD>     * @param readOnly the new value</TD></TR><TR><TD CLASS="l">2305</TD><TD>     */</TD></TR><TR><TD CLASS="l">2306</TD><TD>    public void setReadOnly(boolean readOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="93">2307</A></TD><TD>        this.readOnly = readOnly;</TD></TR><TR CLASS="z"><TD CLASS="l">2308</TD><TD>    }</TD></TR><TR><TD CLASS="l">2309</TD><TD> </TD></TR><TR><TD CLASS="l">2310</TD><TD>    public void setCompactMode(int compactMode) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="66">2311</A></TD><TD>        this.compactMode = compactMode;</TD></TR><TR CLASS="c"><TD CLASS="l">2312</TD><TD>    }</TD></TR><TR><TD CLASS="l">2313</TD><TD> </TD></TR><TR><TD CLASS="l">2314</TD><TD>    public SourceCompiler getCompiler() {</TD></TR><TR CLASS="c"><TD CLASS="l">2315</TD><TD>        if (compiler == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2316</TD><TD>            compiler = new SourceCompiler();</TD></TR><TR><TD CLASS="l">2317</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6f">2318</A></TD><TD>        return compiler;</TD></TR><TR><TD CLASS="l">2319</TD><TD>    }</TD></TR><TR><TD CLASS="l">2320</TD><TD> </TD></TR><TR><TD CLASS="l">2321</TD><TD>    public LobStorage getLobStorage() {</TD></TR><TR CLASS="c"><TD CLASS="l">2322</TD><TD>        if (lobStorage == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2323</TD><TD>            lobStorage = new LobStorage(this);</TD></TR><TR><TD CLASS="l">2324</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="6e">2325</A></TD><TD>        return lobStorage;</TD></TR><TR><TD CLASS="l">2326</TD><TD>    }</TD></TR><TR><TD CLASS="l">2327</TD><TD> </TD></TR><TR><TD CLASS="l">2328</TD><TD>    public Connection getLobConnection() {</TD></TR><TR CLASS="c"><TD CLASS="l">2329</TD><TD>        String url = Constants.CONN_URL_INTERNAL;</TD></TR><TR CLASS="c"><TD CLASS="l">2330</TD><TD>        JdbcConnection conn = new JdbcConnection(systemSession, systemUser.getName(), url);</TD></TR><TR CLASS="c"><TD CLASS="l">2331</TD><TD>        conn.setTraceLevel(TraceSystem.OFF);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="c">2332</A></TD><TD>        return conn;</TD></TR><TR><TD CLASS="l">2333</TD><TD>    }</TD></TR><TR><TD CLASS="l">2334</TD><TD> </TD></TR><TR><TD CLASS="l">2335</TD><TD>    public void setLogMode(int log) {</TD></TR><TR CLASS="z"><TD CLASS="l">2336</TD><TD>        if (log &lt; 0 || log &gt; 2) {</TD></TR><TR CLASS="z"><TD CLASS="l">2337</TD><TD>            throw DbException.getInvalidValueException(&#34;LOG&#34;, log);</TD></TR><TR><TD CLASS="l">2338</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2339</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2340</TD><TD>            if (log != PageStore.LOG_MODE_SYNC ||</TD></TR><TR><TD CLASS="l">2341</TD><TD>                    pageStore.getLogMode() != PageStore.LOG_MODE_SYNC) {</TD></TR><TR><TD CLASS="l">2342</TD><TD>                // write the log mode in the trace file when enabling or</TD></TR><TR><TD CLASS="l">2343</TD><TD>                // disabling a dangerous mode</TD></TR><TR CLASS="z"><TD CLASS="l">2344</TD><TD>                trace.error(null, &#34;log {0}&#34;, log);</TD></TR><TR><TD CLASS="l">2345</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2346</TD><TD>            this.logMode = log;</TD></TR><TR CLASS="z"><TD CLASS="l">2347</TD><TD>            pageStore.setLogMode(log);</TD></TR><TR><TD CLASS="l"><A NAME="2d">2348</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2349</TD><TD>    }</TD></TR><TR><TD CLASS="l">2350</TD><TD> </TD></TR><TR><TD CLASS="l">2351</TD><TD>    public int getLogMode() {</TD></TR><TR CLASS="c"><TD CLASS="l">2352</TD><TD>        if (pageStore != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2353</TD><TD>            return pageStore.getLogMode();</TD></TR><TR><TD CLASS="l">2354</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="67">2355</A></TD><TD>        return PageStore.LOG_MODE_OFF;</TD></TR><TR><TD CLASS="l">2356</TD><TD>    }</TD></TR><TR><TD CLASS="l">2357</TD><TD> </TD></TR><TR><TD CLASS="l">2358</TD><TD>    public int getDefaultTableType() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="9">2359</A></TD><TD>        return defaultTableType;</TD></TR><TR><TD CLASS="l">2360</TD><TD>    }</TD></TR><TR><TD CLASS="l">2361</TD><TD> </TD></TR><TR><TD CLASS="l">2362</TD><TD>    public void setDefaultTableType(int defaultTableType) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="9f">2363</A></TD><TD>        this.defaultTableType = defaultTableType;</TD></TR><TR CLASS="z"><TD CLASS="l">2364</TD><TD>    }</TD></TR><TR><TD CLASS="l">2365</TD><TD> </TD></TR><TR><TD CLASS="l">2366</TD><TD>    public void setMultiVersion(boolean multiVersion) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="7f">2367</A></TD><TD>        this.multiVersion = multiVersion;</TD></TR><TR CLASS="c"><TD CLASS="l">2368</TD><TD>    }</TD></TR><TR><TD CLASS="l">2369</TD><TD> </TD></TR><TR><TD CLASS="l">2370</TD><TD>    public DbSettings getSettings() {</TD></TR><TR CLASS="c"><TD CLASS="l">2371</TD><TD>        return dbSettings;</TD></TR><TR><TD CLASS="l">2372</TD><TD>    }</TD></TR><TR><TD CLASS="l">2373</TD><TD> </TD></TR><TR><TD CLASS="l">2374</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2375</TD><TD>     * Create a new hash map. Depending on the configuration, the key is case</TD></TR><TR><TD CLASS="l">2376</TD><TD>     * sensitive or case insensitive.</TD></TR><TR><TD CLASS="l">2377</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="8d">2378</A></TD><TD>     * @param &lt;V&gt; the value type</TD></TR><TR><TD CLASS="l">2379</TD><TD>     * @return the hash map</TD></TR><TR><TD CLASS="l">2380</TD><TD>     */</TD></TR><TR><TD CLASS="l">2381</TD><TD>    public &lt;V&gt; HashMap&lt;String, V&gt; newStringMap() {</TD></TR><TR CLASS="c"><TD CLASS="l">2382</TD><TD>        return dbSettings.databaseToUpper ?</TD></TR><TR><TD CLASS="l">2383</TD><TD>                new HashMap&lt;String, V&gt;() :</TD></TR><TR><TD CLASS="l">2384</TD><TD>                new CaseInsensitiveMap&lt;V&gt;();</TD></TR><TR><TD CLASS="l">2385</TD><TD>    }</TD></TR><TR><TD CLASS="l">2386</TD><TD> </TD></TR><TR><TD CLASS="l">2387</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2388</TD><TD>     * Compare two identifiers (table names, column names,...) and verify they</TD></TR><TR><TD CLASS="l">2389</TD><TD>     * are equal. Case sensitivity depends on the configuration.</TD></TR><TR><TD CLASS="l">2390</TD><TD>     *</TD></TR><TR><TD CLASS="l">2391</TD><TD>     * @param a the first identifier</TD></TR><TR><TD CLASS="l"><A NAME="4e">2392</A></TD><TD>     * @param b the second identifier</TD></TR><TR><TD CLASS="l">2393</TD><TD>     * @return true if they match</TD></TR><TR><TD CLASS="l">2394</TD><TD>     */</TD></TR><TR><TD CLASS="l">2395</TD><TD>    public boolean equalsIdentifiers(String a, String b) {</TD></TR><TR CLASS="c"><TD CLASS="l">2396</TD><TD>        if (a == b || a.equals(b)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2397</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">2398</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2399</TD><TD>        if (!dbSettings.databaseToUpper &amp;&amp; a.equalsIgnoreCase(b)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2400</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">2401</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="7">2402</A></TD><TD>        return false;</TD></TR><TR><TD CLASS="l">2403</TD><TD>    }</TD></TR><TR><TD CLASS="l">2404</TD><TD> </TD></TR><TR><TD CLASS="l">2405</TD><TD>    public int readLob(long lobId, byte[] hmac, long offset, byte[] buff, int off, int length) {</TD></TR><TR CLASS="z"><TD CLASS="l">2406</TD><TD>        throw DbException.throwInternalError();</TD></TR><TR><TD CLASS="l">2407</TD><TD>    }</TD></TR><TR><TD CLASS="l">2408</TD><TD> </TD></TR><TR><TD CLASS="l">2409</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="a.html">org.h2.engine</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>